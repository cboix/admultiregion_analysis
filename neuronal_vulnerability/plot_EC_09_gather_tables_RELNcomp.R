#!/usr/bin/R
# --------------------------------------------------------
# Gather tables for RELN validation, compare to RELN list:
# Updated: 07/25/2022
# --------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(patchwork)
library(ggrastr)
library(ComplexHeatmap)
library(circlize)
options(width=170)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
srdir = paste0(sdbdir, 'subtype_reg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load all vuln markers + annotations:
# ------------------------------------
# RELN annotation:
relndf = read.delim('RELN_related_genes_jxia.tsv', header=T)[,1:3]

# Load the vulnerability results:
path = 'braaksc.ad'
use.regions = 'allregions'
use.ctrlonly = TRUE
use.est = TRUE
suffix = use.regions
if (use.ctrlonly){ suffix = paste0(suffix, '_ctrlonly') }
if (use.est){ 
    suffix = paste0(suffix, '_estvuln_', path)
} else {
    suffix = paste0(suffix, '_vuln')
}
res.regfile.rda = paste0('multiRegion/vulnmarkers_regression_psbulk_', suffix, '_full.Rda')
load(res.regfile.rda)


# Only the high expression genes:
adf = adf[order(adf$p), ]
adf.outfile = paste0('vulnmarkers_regression_psbulk_', suffix, '_highexprgenes.for_jxia.tsv')
write.table(adf, adf.outfile, quote=F, sep="\t", row.names=F)

# All genes:
p.cut = 1e-3
bdf = est.regdf[est.regdf$var == 'val',]
bdf = bdf[!is.na(bdf$p),]
bdf$padj = p.adjust(bdf$p, 'fdr')
bdf$sig = ifelse(bdf$padj < p.cut, ifelse(bdf$Est < 0, 'Vuln', 'Resil'), 'NS')
bdf = bdf[order(bdf$p), ]
bdf.outfile = paste0('vulnmarkers_regression_psbulk_', suffix, '_full.for_jxia.tsv')
write.table(bdf, bdf.outfile, quote=F, sep="\t", row.names=F)

# RELN genes in these:
adf[adf$symbol %in% relndf$symbol,]
bdf[bdf$symbol %in% relndf$symbol,]


# Load the DEG results:
# ---------------------
extail = '.excitatory_subsets.comparison_depletion.tsv'
estdf = read.delim(paste0(regdir, 'allmethods', extail), header=T)
estdf$sig = ifelse(estdf$col > 0, ifelse(estdf$col == 2, 'Up', 'Down'), 'NS')

degdf.outfile = paste0('excitatory_subset_degs.for_jxia.tsv')
write.table(estdf[,c('gene','zdir','log10p_nm','sig')], degdf.outfile, quote=F, sep="\t", row.names=F)



vulndf = bdf[bdf$symbol %in% relndf$symbol, c('symbol', 'Est', 'sig')]
degdf = estdf[estdf$gene %in% relndf$symbol, c('gene', 'zdir', 'sig')]
names(vulndf) = c('symbol', 'vuln.est', 'vuln.sig')
names(degdf) = c('symbol', 'deg.z', 'deg.sig')

df = merge(vulndf, degdf, all=TRUE)
df = df[order(df$vuln.sig, df$deg.sig, decreasing=T),]

zmat = as.matrix(df[, c('vuln.est', 'deg.z')])
pmat = as.matrix(df[, c('vuln.sig', 'deg.sig')])
pmat[is.na(pmat)] = ''
colnames(zmat) = c('Subtype\nMarker', 'AD DEG\n(Exc neu.)')
colnames(pmat) = colnames(zmat)
rownames(zmat) = df$symbol
rownames(pmat) = df$symbol

ux = 1.5
ht = Heatmap(zmat, 
    name='Effect size',
    cluster_rows=FALSE,
    cluster_columns=FALSE,
    column_split = c(' ', ''),
    border_gp=gpar(color='black', lwd=.5),
    width = ncol(zmat)*unit(ux, "mm") * 3.5, 
    height = nrow(zmat)*unit(ux, "mm"),
    cell_fun = function(j, i, x, y, w, h, col){ # Add the p-value text
        p = pmat[i,j]
        if (p != 'NS'){
        grid.text(p, x, y, gp=gpar(fontsize=gridtxt.fs))
        }
    }
)

pltprefix = paste0(imgpref, 'relncomp_heatmap')
h = .5 + 1 / 15 * nrow(zmat)
w = 1 + 1 / 15 * ncol(zmat) * 3.5
saveHeatmap(ht, pltprefix, h=h, w=w)



