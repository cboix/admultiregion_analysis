#!/usr/bin/R
# -----------------------------------------------
# Aggregate all DEGs results for EC / HC neurons:
# Updated: 12/06/2021
# -----------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Get a list of all differential runs:
# -------------------------------------------------------
rundf = read.delim(paste0(sdbdir, 'nebula_wRUV_excitatory_subsets_runlist.tsv'), header=T)
rundf$prefstr = with(rundf, paste(celltype, subtype, region, path, sep="_"))

# Which have final merged outputs:
rundf$merged = sapply(rundf$prefstr, function(x){
                            length(list.files(path=regdir, pattern=paste0('allmethods.', x, '.merged.rda'))) })
table(rundf$merged)
head(rundf[rundf$merged == 0,])


# Select runs to use (EC / HC):
# -----------------------------
rundf$setid = with(rundf, paste0(celltype, '_', subtype))
sets = unique(rundf$setid)
print(sets)


# Aggregate the DEGs and results across all runs:
# -----------------------------------------------
fullneu.rda = paste0(regdir, 'allmethods.excitatory_subsets.merged.rda')
if (!file.exists(fullneu.rda)){
    kept.cols = c("gene","pc", "col_nm","log10p_nm","path",
                  "logFC_nb","p_nb","padj_nb","col_nb",
                  "coef_mast","p_mast","padj_mast","col_mast")

    setdflist = lapply(sets, function(x){})
    names(setdflist) = sets
    totnsigdf = NULL
    for (i in 1:nrow(rundf)){
        prefstr = rundf$prefstr[i]
        setid = rundf$setid[i]
        aggrda = paste0(regdir, 'allmethods.', prefstr, '.merged.rda')
        if (file.exists(aggrda)){
            load(aggrda)  # Loads aggdf, nsig
            cat(nsig, '\n')
            # Concatenate results:
            aggdf$path = nsig[1,'path']
            setdflist[[setid]] = rbind(setdflist[[setid]], aggdf[,kept.cols])
            # Pad nsig:
            nsigdf = data.frame(nsig)
            if (!("X1" %in% colnames(nsigdf))){ nsigdf$X1 = 0}
            if (!("X2" %in% colnames(nsigdf))){ nsigdf$X2 = 0}
            totnsigdf = rbind(totnsigdf, nsigdf)
        }
    }
    save(setdflist, totnsigdf, file=fullneu.rda)
} else {
    load(fullneu.rda)
}
