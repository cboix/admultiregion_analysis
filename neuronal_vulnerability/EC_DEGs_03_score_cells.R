#!/usr/bin/R
# ---------------------------------------------------------------
# Score cells in the entorhinal cortex using the consistent DEGs:
# Updated: 12/06/2021
# ---------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load everything (including full matrix dataset):
# ------------------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, TRUE, TRUE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))

# Metadata for the pseudobulk matrix:
umeta = ps.data$meta
pmat = ps.data$mat
umeta = umeta[umeta$cell_type_high_resolution != 'Exc SOX11 NCKAP5',]
umeta = umeta[umeta$ncell > 10,]


# Matched metadata to the full matrix:
# ------------------------------------
rownames(cellmeta) = cellmeta$barcode
submeta = cellmeta[colnames(nmat),]
advars = c('cogdx','cogdxad','niareagansc','nrad','braaksc')
covars = c('age_death','msex','pmi', 'Apoe_e4')
submeta = merge(submeta, unique(metadata[,c('projid','region', advars, covars)]))
rownames(submeta) = submeta$barcode
submeta = submeta[colnames(nmat),]


# Load in regression results for subtypes:
# ----------------------------------------
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
topdegdf = read.delim(gzfile(topdeg.file), sep="\t")
topdegdf = topdegdf[order(topdegdf$log10p_nm, decreasing=T),]


# Select covariate of interest, make score:
# -----------------------------------------
pathlist = c('cogdxad','nrad','nft','plaq_n','plaq_d')
ecscoredf = c()
for (path in pathlist){
    # Genes for selected covariate:
    # -----------------------------
    subdf = topdegdf[topdegdf$path == path,]
    updf = subdf[subdf$col == 2,]
    dwdf = subdf[subdf$col == 1,]

    # genes = c('FAIM2','CDK5R1','FASTK','DFFA','HYOU1','PRNP','SNCB','CX3CL1')
    upweights = rep(0, nrow(nmat))
    names(upweights) = rownames(nmat)
    # upweights[updf$gene] = updf$zdir
    upweights[genes] = 1
    upweights = upweights / sum(upweights)

    dwweights = rep(0, nrow(nmat))
    names(dwweights) = rownames(nmat)
    dwweights[dwdf$gene] = -dwdf$zdir
    dwweights = dwweights / sum(dwweights)


    # Score all of the cells with both up and down:
    # ---------------------------------------------
    upscore = log1p(t(upweights) %*% nmat)
    dwscore = log1p(t(dwweights) %*% nmat)

    rownames(submeta) = submeta$barcode
    submeta = submeta[colnames(nmat),]
    submeta$upscore = c(as.matrix(upscore))
    submeta$dwscore = c(as.matrix(dwscore))


    # z-score in a per-subtype manner so we can compare subtypes:
    # -----------------------------------------------------------
    submeta$upm = NULL
    submeta$dwm = NULL
    submeta$ups = NULL
    submeta$dws = NULL
    # NOTE: Median here might be more stable:
    mdf = aggregate(cbind(upscore, dwscore) ~ cell_type_high_resolution, submeta, mean)
    sdf = aggregate(cbind(upscore, dwscore) ~ cell_type_high_resolution, submeta, sd)
    names(mdf)[2:3] = c('upm','dwm')
    names(sdf)[2:3] = c('ups','dws')
    submeta = merge(submeta, mdf, all.x=TRUE)
    submeta = merge(submeta, sdf, all.x=TRUE)

    # z-scores from these attributes:
    submeta$upz = with(submeta, (upscore - upm) / ups)
    submeta$dwz = with(submeta, (dwscore - dwm) / dws)

    # Should be more or less opposite (sanity check):
    png(paste0(imgpref, 'pst_zscores_check_', path, '.png'), res=400, units='in', width=5, height=5)
    plot(submeta$upz, submeta$dwz, pch='.', main=paste0("EC: ", path))
    dev.off()

    # TODO: Save the scores:
    scoredf = submeta[,c('barcode','upz','dwz')]
    scoredf$path = path
    ecscoredf = rbind(ecscoredf, scoredf)
}

ecscore.file = paste0(regdir, 'DE_score_table_EC.tsv.gz')
write.table(ecscoredf, gzfile(ecscore.file), quote=F, row.names=F, sep="\t") 


# Plot scores relative to metadata:
# ---------------------------------
rownames(submeta) = submeta$barcode
ecscoredf$cell_type_high_resolution = submeta[ecscoredf$barcode, 'cell_type_high_resolution']
ecscoredf$projid = submeta[ecscoredf$barcode, 'projid']
ecscoredf$cogdxad = submeta[ecscoredf$barcode, 'cogdxad']

gp = ggplot(ecscoredf, aes(cell_type_high_resolution, upz, fill=cogdxad)) + 
    facet_wrap(~path) + 
    geom_violin(alpha=0.5) + 
    scale_fill_manual(values=colvals[['nrad']]) + 
    geom_boxplot(alpha=0.5) + 
    stat_compare_means() + 
    theme_pubr()
ggsave(paste0(imgpref, 'pst_zscores_by_cogdxad_EC.png'), gp, dpi=400, units='in', width=12, height=8)
ggsave(paste0(imgpref, 'pst_zscores_by_cogdxad_EC.pdf'), gp, dpi=400, units='in', width=12, height=8)


gp = ggplot(ecscoredf, aes(upz, color=cell_type_high_resolution)) + 
    facet_grid(cogdxad~path) + 
    scale_color_manual(values=tcols[subtypes]) + 
    geom_density(alpha=0.5) + 
    scale_y_continuous(expand=c(0,0)) + 
    theme_pubr()
ggsave(paste0(imgpref, 'pst_zscores_density_by_cogdxad_EC.png'), gp, dpi=400, units='in', width=12, height=8)
ggsave(paste0(imgpref, 'pst_zscores_density_by_cogdxad_EC.pdf'), gp, dpi=400, units='in', width=12, height=8)


gp = ggplot(ecscoredf, aes(upz, color=factor(projid))) + 
    facet_grid(cogdxad~path) + 
    geom_density(alpha=0.5) + 
    scale_y_continuous(expand=c(0,0)) + 
    theme_pubr()
ggsave(paste0(imgpref, 'pst_zscores_density_by_projid_EC.png'), gp, dpi=400, units='in', width=12, height=8)
ggsave(paste0(imgpref, 'pst_zscores_density_by_projid_EC.pdf'), gp, dpi=400, units='in', width=12, height=8)



# ggplot(submeta, aes(dwz, color=cell_type_high_resolution)) + 
#     facet_wrap(~cogdxad, ncol=1) + 
#     scale_color_manual(values=tcols[subtypes]) + 
#     geom_density(alpha=0.5) + 
#     scale_y_continuous(expand=c(0,0)) + 
#     theme_pubr()


# ------------------------------------------
# Score individuals (move to separate file):
# ------------------------------------------
aggdf = aggregate(cbind(upz, dwz) ~ projid + cell_type_high_resolution + region + rind, submeta, mean)
upmat = pivot.tomatrix(aggdf[,c('rind','upz','cell_type_high_resolution')], 'cell_type_high_resolution','upz')
dwmat = pivot.tomatrix(aggdf[,c('rind','dwz','cell_type_high_resolution')], 'cell_type_high_resolution','dwz')
colnames(dwmat) = paste0("dw_", colnames(dwmat))
scoremat = cbind(upmat[rownames(upmat),], dwmat[rownames(upmat),])

Heatmap(scoremat)


aggdf = aggregate(cbind(upz, dwz) ~ projid + nrad + cogdxad + region + rind, submeta, mean)
aggdf = merge(aggdf, pqdf)

submeta$cell.stage = ifelse((submeta$upz -submeta$upm) > .5, 'late', ifelse((submeta$upz - submeta$upm) > .25, 'early','non'))
totdf = agg.rename(barcode ~ projid + # cell_type_high_resolution +
                   region, submeta, length, 'total')
ctdf = agg.rename(barcode ~ cell.stage +#  cell_type_high_resolution + 
                  projid + region, submeta, length, 'count')
ctdf$cell.stage = as.character(ctdf$cell.stage)

combdf = expand.grid(cell.stage=c('early','non','late'), 
                     # cell_type_high_resolution=subtypes,
                     projid=unique(ctdf$projid), 
                     region='EC')
ctdf = merge(ctdf, combdf, all.y=TRUE)
ctdf$count[is.na(ctdf$count)] = 0
ctdf = merge(ctdf, totdf)
ctdf$frac = ctdf$count / ctdf$total
ctdf = merge(ctdf, unique(metadata[,c('projid','region', 'rind', advars, covars)]))
ctdf = merge(ctdf, pqdf)  # Pathology variables

# ggplot(ctdf, aes(log1p(nft), frac, color=cell_type_high_resolution)) + 
ggplot(ctdf, aes(log1p(nft), log10(frac + 1e-4))) + 
    facet_wrap(~cell.stage, scales='free') + 
    geom_point() + geom_smooth(method='lm') + 
    theme_pubr()
