#!/usr/bin/R
# ------------------------------------------------------------
# See which vuln markers have carry over to inhibitory neurons
# Updated: 12/23/2021
# ------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)
library(ggrastr)
library(GGally)  # ggpairs

library(ComplexHeatmap)
library(circlize)
library(gprofiler2)
options(width=175)

# Directories:
srdir = paste0(sdbdir, 'subtype_reg/')
regdir = paste0(sdbdir, 'dereg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'vulnmarker_inh_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


qbreg.file = paste0(fracdir, 'quasibinom_contrasts_Inh_byregion.tsv')
qbdf = read.delim(qbreg.file, sep='\t')

path = 'braaksc.ad'
sub.qbdf = qbdf[qbdf$path == path,]
sub.qbdf$Est = log2(sub.qbdf$odds.ratio)
sub.qbdf = sub.qbdf[,c('region','cls','Est')]
names(sub.qbdf)[2] = 'cell_type_high_resolution'


# Load pseudobulk data for all neurons in any set of regions:
# -----------------------------------------------------------
# Set the used regions:
# use.regions = 'EC'
# use.regions = 'ECHCTH'
use.regions = 'allregions'
use.ctrlonly = TRUE
use.est = TRUE
suffix = use.regions
if (use.ctrlonly){ suffix = paste0(suffix, '_ctrlonly') }
if (use.est){ 
    suffix = paste0(suffix, '_estvuln_', path)
} else {
    suffix = paste0(suffix, '_vuln')
}

res.regfile.rda = paste0('multiRegion/vulnmarkers_regression_psbulk_', suffix, '_full.Rda')
load(res.regfile.rda)

# Write, with expression cut more leniently (mx > 3) to look at internally:
mxexpr = apply(pmat, 1, max)
reportdf = est.regdf[est.regdf$var == 'val',]
reportdf = reportdf[!is.na(reportdf$p),]
reportdf$mx = mxexpr[reportdf$symbol]
reportdf = reportdf[order(reportdf$p), ]
reportdf$padj = p.adjust(reportdf$p, 'fdr')
reportdf$log10q = -log10(reportdf$padj)
reportdf = reportdf[(reportdf$padj < pcut) & (reportdf$mx > 3),]
reportdf$dir = ifelse(reportdf$Est < 0, 'Vulnerable','Resilient')

sub.regfile.tsv = paste0(sdbdir, 'vulnmarkers_regression_psbulk_', suffix, '_topgenes.tsv')
write.table(reportdf, sub.regfile.tsv, quote=F, row.names=F, sep='\t')


# Load the pseudobulk data:
# -------------------------
psdata.rda = paste0(srdir, 'pseudobulk_data_Inh.rda')
load(psdata.rda)
# Metadata for the pseudobulk matrix:
umeta = ps.data$meta
pmat = ps.data$mat

nrmeta = unique(metadata[,c('projid','region','rind', 'nrad','cogdxad', 
                            'Apoe_e4','msex','pmi','age_death')])
umeta = merge(umeta, nrmeta)
umeta = merge(umeta, pqdf, all.x=TRUE)
umeta$age_rescaled = umeta$age_death / 100
umeta$vuln = 1 * (umeta$cell_type_high_resolution %in% vuln.neurons)
umeta$lnft = log1p(umeta$nft)
pmat = pmat[, umeta$ptype]

umeta$Est = NULL
umeta$p = NULL
umeta$reg = NULL
umeta = merge(umeta, sub.qbdf, all.x=TRUE)  # Odds ratios from fig 3a
pmat = pmat[, umeta$ptype]
umeta$est.vuln = ifelse(umeta$Est < 0, 1, 0)


# Plot small heatmap with selected top markers:
# TODO: Merge each subtype:
# ---------------------------------------------
ind = (umeta$nrad == 'CTRL')
umeta$cr = with(umeta, paste0(cell_type_high_resolution, '-', region))
crs = unique(umeta$cr)
tform = make.tform(umeta$cr[ind], u=crs, norm=FALSE)
tform = sweep(tform, 1, umeta$ncell[ind], '*')
tform = sweep(tform, 2, apply(tform, 2, sum), '/')
avg.mat = as.matrix(pmat[, ind] %*% tform)

pltgenes = c('CLSTN1','FOXP2','RELN','DAB1','PRKCA','SPHKAP','DLGAP1', 'KCNN2')

pltmat = log1p(avg.mat[pltgenes,])
# pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
plt = Heatmap(t(pltmat), 
              # column_split=paste0(umeta$vuln, '-', umeta$nrad),
              use_raster=T)
              # show_column_names=TRUE)

# Plot as scatter as well:
sub.qbdf$cr = with(sub.qbdf, paste0(cell_type_high_resolution, '-', region))
sub.pltdf = sub.qbdf[sub.qbdf$cr %in% colnames(pltmat),]

all.pltdf = c()

excgenes = c('DAB1','HS6ST3','AGBL1','SPHKAP','DLGAP1','EYS','PRKCA','COL4A2','RELN', 'KCNN2', 'CLSTN1','PCSK1N')
siggenes = c('RELN', 'DAB1', 'LRP8', 'VLDLR', 'PIK3CB','PIK3CA')
for (gene in siggenes){
# for (gene in excgenes){
    sub.pltdf$x = log1p(avg.mat[gene, sub.pltdf$cr])
    sub.pltdf$gene = gene
    all.pltdf = rbind(all.pltdf, sub.pltdf)
}

subdf = all.pltdf[!(all.pltdf$cr %in% c('Inh MEIS2 FOXP2-TH', 'Inh MEIS2 FOXP2-EC', 'Inh MEIS2 FOXP2-HC')),]
gp = ggplot(subdf, aes(x, Est, label=cr)) + 
    facet_wrap(~gene, scales='free') + 
    geom_point() + 
    geom_smooth(method='lm') + 
    geom_text_repel() + 
    stat_cor() + 
    theme_pubr()

gp2 = rasterize(gp, layers='Point', dpi=450)
w = 12; h=9
pltprefix = paste0(imgpref, 'vuln_genes_subtype_scatters_', suffix)
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)


# Plot expression of RELN + DAB1 signaling pathways against each other:
# ---------------------------------------------------------------------
ind = (umeta$nrad == 'CTRL')
ind = 1:nrow(umeta)
umeta$cr = with(umeta, paste0(cell_type_high_resolution, '-', region))
crs = unique(umeta$cr)
tform = make.tform(umeta$cr[ind], u=crs, norm=FALSE)
tform = sweep(tform, 1, umeta$ncell[ind], '*')
tform = sweep(tform, 2, apply(tform, 2, sum), '/')
avg.mat = as.matrix(pmat[, ind] %*% tform)

sub.qbdf$cr = with(sub.qbdf, paste0(cell_type_high_resolution, '-', region))
sub.pltdf = sub.qbdf[sub.qbdf$cr %in% colnames(pltmat),]
siggenes = c('RELN', 'DAB1', 'LRP8', 'VLDLR', 'FYN', 'SRC', 'PIK3CB','PIK3CA','GSK3B', 'CDK5','AKT1')
for (gene in siggenes){
    sub.pltdf[[gene]] = log1p(avg.mat[gene, sub.pltdf$cr])
}


# Plot reduced version:
gp = ggpairs(sub.pltdf, columns=c(siggenes[1:6], 'Est'),
             lower = list(continuous = "smooth")) + 
    theme_pubr()
w = 9; h=9
pltprefix = paste0(imgpref, 'vuln_genes_reelin_signaling_pairs_', suffix)
ggsave(paste0(pltprefix, '.png'), gp, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp, dpi=450, units='in', width=w, height=h)


# Plot full version:
gp2 = ggpairs(sub.pltdf, columns=c(siggenes, 'Est'),
              lower = list(continuous = "smooth")) + 
    theme_pubr()
w = 10; h=10
pltprefix = paste0(imgpref, 'vuln_genes_reelin_signaling_pairs_full_', suffix)
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)

smat = sub.pltdf[,c('VLDLR','FYN','DAB1')]
sub.pltdf$sig.score = apply(smat, 1, sum)
head(sub.pltdf[order(sub.pltdf$sig.score, decreasing=T),], 50)


