#!/usr/bin/R
# --------------------------------------------------
# Load the regression estimates of fraction changes:
# --------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
if (!exists('cellmeta')){
    source(paste0(sbindir, 'load_metadata.R'))
}


# Load the regression odds ratio estimates:
# -----------------------------------------
fracdir = paste0(sdbdir, 'fractions/')
qbreg.file = paste0(fracdir, 'quasibinom_contrasts_Exc_byregion.tsv')
qbdf = read.delim(qbreg.file, sep='\t')


# Filter down the odds ratios analysis:
# -------------------------------------
kdf = merge(data.frame(cls=exc.sets[['CTXneurons']]), data.frame(region=c('AG','MT','PFC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['ECneurons']], region=c('EC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['HCneurons']], region=c('HC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['THneurons']], region=c('TH')))


getqb = function(path){
    sub.qbdf = qbdf[qbdf$path == path,]
    sub.qbdf = merge(sub.qbdf[,c('cls','region','odds.ratio')], kdf)
    sub.qbdf$Est = log2(sub.qbdf$odds.ratio)
    sub.qbdf = sub.qbdf[,c('region','cls','Est')]
    names(sub.qbdf)[2] = 'cell_type_high_resolution'
    sub.qbdf$set = paste0('Exc_', gsub(" ", "_", sub.qbdf$cell_type_high_resolution))
    # Average for changes in cortical:
    sub.qbdf = aggregate(Est ~ set, sub.qbdf, mean)
    return(sub.qbdf)
}


