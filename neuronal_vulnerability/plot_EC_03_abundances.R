#!/usr/bin/R
# ----------------------------------------
# Plot neuron counts in entorhinal cortex:
# Updated: 12/06/2021
# ----------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

# Directories:
plotdir = paste0(imgdir, 'metadata/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load abundances data only (1st arg):
# ------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, FALSE, FALSE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))


# Merge TOX3?
merge.tox3=TRUE
if (merge.tox3){
    imgpref = paste0(imgpref, 'mergetox3_')
    ctdf$cls[ctdf$cls %in% c('Exc TOX3 TTC6', 'Exc TOX3 INO80D')] = 'Exc TOX3'
    ctdf$other = NULL
    agg.ctdf = aggregate(count ~ ., ctdf, sum)

}


# Simple significance from wilcoxon; greater, adjusted:
# ----------------------------------------------------- 
pathval = 'nrad'
ctdf$frac = ctdf$count / ctdf$total
cts = unique(ctdf$cls)
pv = c()
for (ct in cts){
    x1 = ctdf$frac[ctdf$cls == ct & ctdf$nrad == 'AD']
    x2 = ctdf$frac[ctdf$cls == ct & ctdf$nrad == 'CTRL']
    pv = c(pv, wilcox.test(x2,x1, alternative ='greater')$p.value)
}
names(pv) = cts
pv = pv[order(pv)]
padj = p.adjust(pv, 'fdr')
labdf = data.frame(cls=names(padj), padj=padj)


# Plot these as simple boxplot comparisons for cognition + NIA-Reagan:
# --------------------------------------------------------------------
g0a = ggplot(ctdf, aes(x=cls, y=count / total, color=nrad)) +
    geom_boxplot() + 
    theme_pubr() + 
    geom_text(data=labdf, aes(x=cls, y=max(ctdf$frac), label=padj), color='black') + 
    scale_color_manual(values=colvals[['nrad']]) + 
    scale_y_continuous(label=scales::percent, expand=c(0,0.001)) + 
    coord_flip()

g0b = ggplot(ctdf, aes(x=cls, y=count / total, color=cogdxad)) +
    geom_boxplot() + 
    theme_pubr() + 
    stat_compare_means(label='p.signif') +
    scale_color_manual(values=colvals[['nrad']]) + 
    scale_y_continuous(label=scales::percent, expand=c(0,0.001)) + 
    coord_flip()

garr = g0a + g0b
ggsave(paste0(imgpref, 'ECfrac_againststrat_overall.png'), garr, dpi=450, units='in', width=12, height=6)
ggsave(paste0(imgpref, 'ECfrac_againststrat_overall.pdf'), garr, dpi=450, units='in', width=12, height=6)


# Plots to see if there is an impact of APOE e4 status on depletion:
# ------------------------------------------------------------------
g0c = ggplot(ctdf, aes(x=cls, y=count / total, color=nrad)) +
    facet_wrap(~Apoe_e4) + 
    geom_boxplot(outlier.shape=NA) + 
    theme_pubr() + 
    geom_jitter(position=position_jitterdodge(jitter.width=.35, dodge.width=.75), cex=.8) +
    scale_color_manual(values=colvals[['nrad']]) + 
    scale_y_continuous(label=scales::percent, expand=c(0,0.001)) + 
    coord_flip()

fit = lm(frac ~ Apoe_e4 * cls, ctdf[ctdf$nrad == 'AD',])

g0c = ggplot(ctdf[ctdf$nrad == 'AD',], aes(x=cls, y=count / total, color=Apoe_e4)) +
    geom_boxplot(outlier.shape=NA) + 
    theme_pubr() + 
    geom_jitter(position=position_jitterdodge(jitter.width=.35, dodge.width=.75), cex=.8) +
    stat_compare_means(label='p.format', method.args = list(alternative = "greater")) + 
    scale_color_manual(values=c('grey','black')) + 
    scale_y_continuous(label=scales::percent, expand=c(0,0.001)) + 
    coord_flip()


# Scatter plots against different pathology variables:
# ----------------------------------------------------
ctdf$frac = ctdf$count / ctdf$total
g1 = ggplot(ctdf, aes(x=nft_ec, y=frac)) +
    facet_wrap(~cls, scales='free_y') + 
    geom_point() + geom_smooth(method='lm') + 
    theme_pubr() + 
    stat_fit_glance(method = 'lm', geom = 'text',
                    aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                    label.x = 'center', label.y = 'top', size = 3)

g2 = ggplot(ctdf, aes(x=plaq_n_ec, y=frac)) +
    facet_wrap(~cls, scales='free_y') + 
    geom_point() + geom_smooth(method='lm') + 
    theme_pubr() + 
    stat_fit_glance(method = 'lm', geom = 'text',
                    aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                    label.x = 'center', label.y = 'top', size = 3)

g3 = ggplot(ctdf, aes(x=plaq_d_ec, y=frac)) +
    facet_wrap(~cls, scales='free_y') + 
    geom_point() + geom_smooth(method='lm') + 
    theme_pubr() + 
    stat_fit_glance(method = 'lm', geom = 'text',
                    aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                    label.x = 'center', label.y = 'top', size = 3)

garr = g1 + g2 + g3
ggsave(paste0(imgpref, 'ECfrac_againstpath_overall.png'), garr, dpi=450, units='in', width=25, height=8)
ggsave(paste0(imgpref, 'ECfrac_againstpath_overall.pdf'), garr, dpi=450, units='in', width=25, height=8)

