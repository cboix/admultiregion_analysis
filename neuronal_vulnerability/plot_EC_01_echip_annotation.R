#!/usr/bin/R
# ---------------------------------------
# Plot the HIP + EC annotation from Jose:
# Updated: 12/02/2021
# ---------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(ComplexHeatmap)
library(circlize)

# Directories:
plotdir = paste0(imgdir, 'metadata/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load Jose's metadata on merged HIP + EC:
# ----------------------------------------
jann = read.delim('multiRegion/Jose.HIP.EC.Neuron.annotations.csv', sep=",")
jann$region[jann$region == 'HIP'] = 'HC'
jann$barcode = paste0(jann$region, '_', jann$barcode)
jann$tail = sub(".*-","",jann$barcode)

table(jann[,c('region','tail')])
table(jann[,c('region','annotation')])
jann = merge(jann, cellmeta)

# Shuffle points for plotting:
ind = 1:nrow(jann)
ad.ind = which(jann$nrad == 'AD')
ctrl.ind = which(jann$nrad == 'CTRL')
full.ind = sample(ind, length(ind), replace=FALSE)
ad.ind = sample(ad.ind, length(ad.ind), replace=FALSE)
ctrl.ind = sample(ctrl.ind, length(ctrl.ind), replace=FALSE)
xr = diff(range(jann$U1))
yr = diff(range(jann$U2))

jlvls = unique(jann$annotation)
jcols = rep(snap.cols,3)[1:length(jlvls)]
names(jcols) = as.character(jlvls)
tsp.jcols = sapply(jcols, tsp.col)

jtype.loc = aggregate(cbind(U1, U2) ~ annotation, jann, mean)
celltype.loc = aggregate(cbind(U1, U2) ~ cell_type_high_resolution, jann, mean)

# Plot by the U1/U2 in our data but Jose's annotation:
w = 5
h = w * yr / xr
cex = 0.025
sp = 0.01
png(paste0(imgpref, 'EC_HIP_joseann_neurons_umap_alone.png'), units='in', res=450, width=w*2, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
layout(matrix(1:2,nrow=1, ncol=2))
plot(jann$U1[full.ind], jann$U2[full.ind], 
     col=tsp.jcols[jann$annotation[full.ind]], pch=19, cex=cex, axes=F)
with(jtype.loc, text(U1, U2, annotation, cex=.5, xpd=TRUE, font=1))
mtext('Jose Annotation', side=1, line=-1)
# Also:
plot(jann$U1[full.ind], jann$U2[full.ind], 
     col=tsp.tcols[jann$cell_type_high_resolution[full.ind]], pch=19, cex=cex, axes=F)
with(celltype.loc, text(U1, U2, cell_type_high_resolution, cex=.5, xpd=TRUE, font=1))
mtext('Hans/Carles Annotation', side=1, line=-1)
dev.off()


# Plot the confusion matrix:
aggdf = agg.rename(barcode ~ annotation + cell_type_high_resolution + region, jann[jann$major.celltype  == 'Exc',], length, 'count')

# Select neuronal subtypes in EC only:
rdf = agg.rename(barcode ~ region + cell_type_high_resolution, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'count')
rdf = spread(rdf, region, count, fill=0)
rmat = as.matrix(rdf[,-1])
rownames(rmat) = rdf[,1]
topec = apply(rmat,1, max) == rmat[,'EC']
topec = names(topec)[topec]
topec = topec[topec != 'Exc SV2C LINC02137']
atab = table(jann[jann$major.celltype  == 'Exc',c('annotation','cell_type_high_resolution')])
atab = t(as.matrix(unclass(atab)))
atab = t(scale(t(atab), center=FALSE))
atab2 = diag.mat2(atab)[[1]]

png(paste0(imgpref, 'EC_HIP_joseann_neurons_heatmap_cont.png'), units='in', res=450, width=8, height=6)
Heatmap(atab2, 'Scaled\nshared',
        row_split=ifelse(rownames(atab2) %in% topec, 'EC', 'Other'),
        cluster_columns=FALSE,
        cluster_rows=FALSE,
        col=colb)
dev.off()


