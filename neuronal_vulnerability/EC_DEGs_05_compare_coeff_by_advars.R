#!/usr/bin/R
# -------------------------------------------------------------------------
# Determine consistent up / down patterns for each covariate
# Determine unique subtypes of DEGs for each pathology / AD measurement
# Plot coeff. + clusters of these DEGs across EC neurons
# Updated: 12/06/2021
# -------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(ComplexHeatmap)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load in the aggregated the DEGs and results across all runs:
# ------------------------------------------------------------
fullneu.rda = paste0(regdir, 'allmethods.excitatory_subsets.merged.rda')
load(fullneu.rda)

# Aggregate into one data.frame + top degs:
runsets = paste0("Exc_", gsub(" ", "_", unlist(exc.sets)))
pathlist = c('cogdxad','nrad','nft','plaq_n','plaq_d', 'braaksc.ad','braaksc.early')

aggneu.rda = paste0(regdir, 'allmethods.excitatory_subsets.merged.aggtop.rda')
if (!file.exists(aggneu.rda)){
    topdegdf = c()
    alldf = c()
    for (path in pathlist){
        # Aggregate the DE results across these subtypes:
        # -----------------------------------------------
        fulldf = c()
        for (set in runsets){
            kept.cols = c("gene","pc", "col_nm","log10p_nm","path", 'coef_mast','logFC_nb')
            regdf = setdflist[[set]]
            if (!is.null(regdf)){
                regdf = regdf[regdf$path == path, kept.cols]
                c1 = regdf$coef_mast / sd(regdf$coef_mast)
                c2 = regdf$logFC_nb / sd (regdf$logFC_nb)
                regdf$zdir = (c1 + c2) /2
                if (nrow(regdf) > 0){
                    regdf$set = set
                    fulldf = rbind(fulldf, regdf)
                } else { print(paste(set, path, "missing")) } 
            }
        }

        fulldf = fulldf[order(fulldf$log10p_nm, decreasing=T),]
        fulldf = fulldf[order(fulldf$col_nm, decreasing=T),]
        fulldf$signif = fulldf$col_nm != 0
        alldf = rbind(alldf, fulldf)

        # Aggregate scores and pick genes significant in 4/5 sets:
        # --------------------------------------------------------
        sigcutoff = 0.8
        meandf = aggregate(cbind(zdir, log10p_nm, signif) ~ gene, fulldf, mean)
        meandf = meandf[order(meandf$log10p_nm, decreasing=T),]
        meandf$col = ifelse(meandf$signif >= sigcutoff,
                            ifelse(meandf$zdir > 0, 2, 1), 0)
        updf = meandf[meandf$col == 2,]
        dwdf = meandf[meandf$col == 1,]
        # head(updf, 20)
        # head(dwdf, 20)
        meandf$path = path
        topdegdf = rbind(topdegdf, meandf)
    }
    save(topdegdf, alldf, file=aggneu.rda)
} else {
    load(aggneu.rda)
}

# Save this table:
# topdeg.file = paste0(regdir, 'allmethods.ECHC_excitatory_subsets.bypath.tsv.gz')
# write.table(topdegdf, gzfile(topdeg.file), quote=F, row.names=F, sep="\t")


# Compare pairs of cell types:
# ----------------------------
# g1 = 'Exc_Exc_RELN_GPC5'
g1 = 'Exc_Exc_TOX3_TTC6'
# g2 = 'Exc_Exc_TOX3_INO80D'
g2 = 'Exc_CA1_pyramidal_cells'
path = 'cogdxad'
subdf = alldf[alldf$set %in% c(g1, g2),]
subdf = subdf[subdf$path == path,]
zdf = spread(subdf[,c('gene','logFC_nb','set')], 'set','logFC_nb')
cdf = spread(subdf[,c('gene','col_nm','set')], 'set','col_nm')
cdf$col = factor((cdf[[g1]] != 0) + (cdf[[g2]] != 0))
zdf$col = factor((cdf[[g1]] != 0) + (cdf[[g2]] != 0))
zdf = zdf[order(zdf$col),]

library(ggpubr)
library(ggrepel)
labdf = zdf[zdf$col != 0,]

ggplot(zdf, aes_string(g1,g2, color='col')) + 
    geom_point() + 
    geom_abline(lty='dashed') + 
    scale_color_manual(values=c('0'='grey90','1'='red','2'='black')) +
    geom_hline(yintercept=0, lty='dotted') + 
    geom_vline(xintercept=0, lty='dotted') + 
    geom_text_repel(data=labdf, aes_string(g1,g2, label='gene', color='col')) + 
    theme_pubr()


# Compare pairs of pathology:
# ---------------------------
g1 = 'braaksc.ad'
g2 = 'braaksc.early'
# g1 = 'plaq_n'
# g2 = 'nft'
set = 'Exc_CA1_pyramidal_cells'
set = 'Exc_Exc_L2-3_CBLN2_LINC02306'
set = 'Exc_Exc_L3-4_RORB_CUX2'
# set = 'Exc_DG_granule_cells'
# set = 'Exc_Exc_RELN_GPC5'
subdf = alldf[alldf$set == set,]
subdf = subdf[subdf$path %in% c(g1, g2),]
zdf = spread(subdf[,c('gene','logFC_nb','path')], 'path','logFC_nb')
cdf = spread(subdf[,c('gene','col_nm','path')], 'path','col_nm')
cdf$col = factor((cdf[[g1]] != 0) + (cdf[[g2]] != 0))
zdf$col = factor((cdf[[g1]] != 0) + (cdf[[g2]] != 0))
zdf = zdf[order(zdf$col),]

library(ggpubr)
library(ggrepel)
labdf = zdf[zdf$col != 0,]

ggplot(zdf, aes_string(g1,g2, color='col')) + 
    geom_point() + 
    geom_abline(lty='dashed') + 
    scale_color_manual(values=c('0'='grey90','1'='red','2'='black')) +
    geom_hline(yintercept=0, lty='dotted') + 
    geom_vline(xintercept=0, lty='dotted') + 
    geom_text_repel(data=labdf, aes_string(g1,g2, label='gene', color='col')) + 
    theme_pubr()



# Compare gene coefficient across subtypes:
# -----------------------------------------
genes = c('H1FX', 'BACE2', 'CLSTN1', 'NEUROD2', 'NCDN','MT-ND3')
g1 = 'braaksc.ad'
g2 = 'braaksc.early'
# g1 = 'plaq_n'
# g2 = 'nft'
subdf = alldf[alldf$gene %in% genes,]
subdf = subdf[subdf$path %in% c(g1, g2),]
zdf = spread(subdf[,c('set','gene','logFC_nb','path')], path, logFC_nb)
cdf = spread(subdf[,c('set','gene', 'col_nm','path')], path, col_nm)
cdf$col = factor((cdf[[g1]] != 0) + (cdf[[g2]] != 0))
zdf$col = factor((cdf[[g1]] != 0) + (cdf[[g2]] != 0))
zdf = zdf[order(zdf$col),]
zdf = zdf[!is.na(zdf$col),]

library(ggpubr)
library(ggrepel)
labdf = zdf[zdf$col != 0,]

ggplot(zdf, aes_string(g1,g2, color='col')) + 
    facet_wrap(~gene) + 
    geom_point() + 
    geom_abline(lty='dashed') + 
    scale_color_manual(values=c('0'='grey50','1'='red','2'='black')) +
    geom_hline(yintercept=0, lty='dotted') + 
    geom_vline(xintercept=0, lty='dotted') + 
    geom_text_repel(data=labdf, aes_string(g1,g2, label='set', color='col')) + 
    theme_pubr()



