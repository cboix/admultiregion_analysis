#!/usr/bin/R
# -------------------------------------------------------------------------
# Determine consistent up / down patterns for each covariate
# Determine unique subtypes of DEGs for each pathology / AD measurement
# Plot coeff. + clusters of these DEGs across EC neurons
# Updated: 12/06/2021
# -------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(ComplexHeatmap)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load in the aggregated the DEGs and results across all runs:
# ------------------------------------------------------------
fullneu.rda = paste0(regdir, 'allmethods.excitatory_subsets.merged.rda')
load(fullneu.rda)

# Will only look at the most vulnerable sets for now:
# TODO: also repeat on all subtypes??
vuln.sets = paste0("Exc_", gsub(" ", "_", vuln.neurons))
# TODO: FOR ALL PATH:
path = 'nrad'
path = 'cogdxad'
path = 'plaq_d'

pathlist = c('cogdxad','nrad','nft','plaq_n','plaq_d', 'braaksc.ad','braaksc.early')
topdegdf = c()
for (path in pathlist){
    # Aggregate the DE results across these subtypes:
    # -----------------------------------------------
    fulldf = c()
    for (set in vuln.sets){
        kept.cols = c("gene","pc", "col_nm","log10p_nm","path", 'coef_mast','logFC_nb')
        regdf = setdflist[[set]]
        regdf = regdf[regdf$path == path, kept.cols]
        c1 = regdf$coef_mast / sd(regdf$coef_mast)
        c2 = regdf$logFC_nb / sd (regdf$logFC_nb)
        regdf$zdir = (c1 + c2) /2
        if (nrow(regdf) > 0){
            regdf$set = set
            fulldf = rbind(fulldf, regdf)
        } else { print(paste(set, path, "missing")) } 
    }

    # Reduce to genes tested in all sets and with the same direction:
    fulldf$dir = ifelse(fulldf$zdir > 0, 1, -1)
    dirdf = aggregate(dir ~ gene, fulldf, sum)
    const.genes = dirdf$gene[abs(dirdf$dir) == length(vuln.sets)]

    fulldf = fulldf[fulldf$gene %in% const.genes,]
    fulldf = fulldf[order(fulldf$log10p_nm, decreasing=T),]
    fulldf = fulldf[order(fulldf$col_nm, decreasing=T),]
    fulldf$signif = fulldf$col_nm != 0

    # Aggregate scores and pick genes significant in 4/5 sets:
    # --------------------------------------------------------
    sigcutoff = 0.8
    meandf = aggregate(cbind(zdir, log10p_nm, signif) ~ gene, fulldf, mean)
    meandf = meandf[order(meandf$log10p_nm, decreasing=T),]
    meandf$col = ifelse(meandf$signif >= sigcutoff,
                        ifelse(meandf$zdir > 0, 2, 1), 0)
    updf = meandf[meandf$col == 2,]
    dwdf = meandf[meandf$col == 1,]
    # head(updf, 20)
    # head(dwdf, 20)
    meandf$path = path
    topdegdf = rbind(topdegdf, meandf)
}

# Save this table:
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
write.table(topdegdf, gzfile(topdeg.file), quote=F, row.names=F, sep="\t")


# Plots of concordance:
# ---------------------
zmat = pivot.tomatrix(topdegdf[,c('gene','zdir','path')], 'path','zdir')
png(paste0(imgpref, 'DE_scores_concordance.png'), res=450, units='in', width=5, height=5)
pairs(zmat, pch='.')
dev.off()


# Correlation + order.optimal:
cr = cor(zmat, use='pairwise')
cr = reord(cr)
cr = cr[, rownames(cr)]

plt = Heatmap(cr,
              col=colb,
              use_raster=TRUE,
              cluster_rows=FALSE,
              cluster_columns=FALSE
)

w = 3
png(paste0(imgpref, 'DE_scores_concordance_correlation.png'), res=450, units='in', width=w, height=w)
print(plt)
dev.off()
png(paste0(imgpref, 'DE_scores_concordance_correlation.pdf'), width=w, height=w)
print(plt)
dev.off()
