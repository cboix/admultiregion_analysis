#!/usr/bin/R
# ----------------------------------
# Plot individual-vs-neurons heatmap
# Updated: 12/06/2022
# ----------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(patchwork)
library(ggrastr)

library(ComplexHeatmap)
library(circlize)
options(width=175)

# Directories:
srdir = paste0(sdbdir, 'subtype_reg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'vuln_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Get the relative abundances for all subtypes:
# ---------------------------------------------
commandArgs <- function(trailingOnly=TRUE){c('Exc', TRUE)}
source(paste0(sbindir, 'metadata_markers/load_proportions_data.R'))
ctdf$frac = ctdf$count / ctdf$total
ctdf$rc = paste0(ctdf$region, ':', ctdf$cls)

# Filter down to tested excitatory sets (region-matched)
kdf = merge(data.frame(cls=c('Exc NRGN', exc.sets[['CTXneurons']])), data.frame(region=c('AG','MT','PFC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['ECneurons']], region=c('EC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['HCneurons']], region=c('HC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['THneurons']], region=c('TH')))


# Load the regression estimates of fraction changes:
# --------------------------------------------------
qbreg.file = paste0(fracdir, 'quasibinom_contrasts_Exc_byregion.tsv')
qbdf = read.delim(qbreg.file, sep='\t')

path = 'braaksc.ad'
sub.qbdf = qbdf[qbdf$path == path,]
sub.qbdf = merge(sub.qbdf[,c('cls','region','odds.ratio')], kdf)
sub.qbdf$Est = log2(sub.qbdf$odds.ratio)
sub.qbdf = sub.qbdf[,c('region','cls','Est')]
names(sub.qbdf)[2] = 'cell_type_high_resolution'



# Plot heatmap of the fraction of cells:
# --------------------------------------
subctdf = merge(ctdf, kdf)
value = 'frac'
# value = 'count'
subctdf = subctdf[,c('cls','projid','region', 'rc','count','total', 'frac')]
fmat = pivot.tomatrix(subctdf[,c('rc','projid',value)], 'rc',value)

# Aggregate non-vulnerable together:
agg.sets = FALSE
if (agg.sets){
    vuln.sets = c(vuln.neurons, 'Exc L2-3 CBLN2 LINC02306', 'Exc NRGN')
    ind = subctdf$cls %in% vuln.sets
    nvdf = aggregate(count ~ projid + total + region, subctdf[!ind, ], sum)
    nvdf$cls = 'Other'
    nvdf$rc = paste0(nvdf$region, ':', nvdf$cls)
    nvdf$frac = nvdf$count / nvdf$total
    subctdf = rbind(subctdf[ind,], nvdf[,colnames(subctdf)])
    fmat = pivot.tomatrix(subctdf[,c('rc','projid',value)], 'rc',value)
}


# Collect individual-level metadata:
# TODO: Order the individuals based on the scores:
# ------------------------------------------
advars = c('gpath', 'nrad','niareagansc','cogdx','cogdxad','cogn_global_lv','braaksc.ad','braaksc', 'amyloid','tangles')
covars = c('msex','age_death','pmi','Apoe_e4')
umeta = metadata[metadata$region == 'PFC', c('projid',advars, covars)]
umeta = umeta[umeta$projid %in% rownames(fmat),]
rownames(umeta) = as.character(umeta$projid)

# Order and split based on global pathology + NIA-Reagan, respectively
umeta = umeta[order(umeta$gpath),]
umeta = umeta[order(umeta$braaksc),]
umeta = umeta[order(-umeta$niareagansc),]
fmat = fmat[as.character(umeta$projid),]
indsplit = umeta[as.character(rownames(fmat)), 'nrad']

age.col_fun = colorRamp2(range(umeta$age_death), c("white", "slateblue")) 
pmi.col_fun = colorRamp2(c(2, 15), c("white", "indianred")) 
gpath.col_fun = colorRamp2(c(0, max(umeta$gpath)), c("white", "indianred")) 
gcog.col_fun = colorRamp2(c(min(umeta$cogn_global_lv), max(umeta$cogn_global_lv)),
    c("red", 'white')) 
# mat.col_fun = colorRamp2(c(0, max(pmat, na.rm=T)), c("white", "blue")) 

# Create heatmap annotation:
# --------------------------
ux = 1.5
ha = HeatmapAnnotation(
    annotation_name_gp = gpar(fontsize=5),
    simple_anno_size = unit(ux, 'mm'),
    Sex=ifelse(umeta$msex == 0, 'female','male'), 
    # PMI=umeta$pmi,
    Age=umeta$age_death,
    Apoe_e4=umeta$Apoe_e4,
    GPath=umeta$gpath,
    Braak=umeta$braaksc,
    AD=umeta$niareagansc,
    Cognition=umeta$cogdx,
    GlobalCog=umeta$cogn_global_lv,
    col=list(AD=colvals[['niareagansc']],
        Apoe_e4=c('no'='grey95','yes'='grey70'),
        Age=age.col_fun,
        GPath=gpath.col_fun,
        GlobalCog=gcog.col_fun,
        # PMI=pmi.col_fun,
        Braak=colvals[['braaksc']],
        Cognition=colvals[['cogdx']],
        Sex=colvals[['sex']]), which='column')


# Process and plot matrix:
# ------------------------
# pltmat = t(fmat)
pltmat = t(scale(fmat))
pltmat = t(fmat)
pltmat = sweep(pltmat, 1, apply(pltmat,1, mean, na.rm=T), '/')
pltmat = log2(pltmat)
pltmat[is.infinite(pltmat)] = 0


sets = c('^EC','^HC','NRGN','L2-3', 'Other')
ind = unlist(sapply(sets, function(x){ grep(x, colnames(fmat))}))
# ind = c(grep("^EC", colnames(fmat)))
pltmat = t(fmat[, ind])
pltmat = sweep(pltmat, 1, apply(pltmat,1, max, na.rm=T), '/')
# pltmat[is.na(pltmat)] = 0
rowsplit = sub(":.*","", rownames(pltmat))

mx = 2.5
col_fun = colorRamp2(c(-mx, 0, mx), c('blue', "white", 'red'))
col_fun = rev(colrb)
col_fun = viridis(100)
col_fun = colb

ux = 1.5
ht = Heatmap(pltmat,
    col=col_fun,
    use_raster=FALSE,
    # cluster_columns=FALSE,
    bottom_annotation=ha,
    row_split = rowsplit,
    column_split = indsplit,
    width = ncol(pltmat)*unit(ux, "mm"), 
    height = nrow(pltmat)*unit(ux, "mm"),
    border_gp = gpar(col="black", lty = 1, lwd=.5),
    # cell_fun = function(j, i, x, y, w, h, col){ # Add the p-value text
    #     p = pmat[i,j]
    #     ann = ifelse(p < 0.05, ifelse(p < 0.01, ifelse(p < 0.001, '***','**'),'*'),'')
    #     grid.text(ann, x, y)}
)

h = 3 + 1 / 15 * nrow(pltmat)
w = 5 + 1 / 15 * ncol(pltmat)
pltprefix = paste0(imgpref, 'exc_fraction_heatmap_', value)
saveHeatmap(ht, pltprefix, w=w, h=h)


