#!/usr/bin/R
# -------------------------------------------------------
# Plots for the integrated neuronal trajectory from DEGs:
# Updated: 03/01/2022
# -------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)


library(ComplexHeatmap)
library(circlize)
options(width=175)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'detraj_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load the metadata for the DE trajectory:
# ----------------------------------------
usefull = TRUE
if (usefull){
    useprefix = 'testedgenes_combat'
} else {
    useprefix = 'DEGpartitions_combat'
}
imgpref = paste0(plotdir, 'detraj_', useprefix, '_')
df.file = paste0(sdbdir, 'multiregion_majorctUMAP_Exc_log1p_')
df.file = paste0(df.file, useprefix, '_subsetUMAP.tsv')

df = read.delim(df.file, header=T)
keep.cols = c('barcode', 'projid', 'region', 'celltype', 'C1','C2',
    'dpt_pseudotime','leiden', 'nft','plaq_n','plaq_d','cogdxad','nrad', 'niareagansc', 'braaksc')
# df = df[,keep.cols]
gc()

if (usefull){
    y = max(df$C2) - df$C2
    df$dpt_pseudotime = y / max(y)
}


sdf = unique(df[,c('projid','braaksc')])
table(sdf$braaksc)
df$braak.cls = '5-6'
df$braak.cls[df$braaksc < 5] = '3-4'
df$braak.cls[df$braaksc < 3] = '0-2'
# df$braak.cls[df$braaksc == 0] = '0'


# Plot density plots for cognition, AD, and stage:
# ------------------------------------------------
plotPoly = function(df, form, palette='Spectral', grid=TRUE){
    gp = ggplot(df, aes(x=C1, y=C2)) +
        stat_density_2d(aes(fill = ..level..), geom = "polygon") +
        scale_fill_distiller(palette=palette, direction=-1) +
        theme_pubr() + theme(legend.position='none')
    if (grid){
        gp = gp + facet_grid(as.formula(form))
    } else {
        gp = gp + facet_wrap(as.formula(form))
    }
    return(gp)
}

savePolyPlot = function(df, facet, grid=TRUE){
    NF = length(unique(df[[facet]]))
    gp = plotPoly(df, paste0('.~ ', facet), grid=grid)
    if (grid){
        w = .5 + 1.25 * NF
        h = .75 + 1.25 * 1
    } else {
        nr = ceiling(sqrt(NF))
        nc = (NF %/% nr) + 1
        w = .5 + 1.25 * nc
        h = .75 + 1.25 * nr
    }
    saveGGplot(gp, paste0(imgpref, 'polygons_', facet), w=w, h=h)
    return(gp)
}

# Using polygons, plot 
vars = c('braak.cls','cogdx','cogdxad','nrad',
    'region', 'msex', 'Apoe_e4', 'niareagansc','braaksc')
for (var in vars){
    gp = savePolyPlot(df, var)
}

# gp = savePolyPlot(df[df$braaksc != 0,], 'braaksc')
gp = savePolyPlot(df, 'celltype', grid=FALSE)

gp = plotPoly(df, 'braaksc ~ region')  # braak stage vs. region
saveGGplot(gp, paste0(imgpref, 'polygons_', 'braaksc_region'),
    w=.5 + 1.25 * 6, h=.75 + 1.25 * 7)

gp = plotPoly(df, 'braak.cls ~ region')  # braak stage vs. region
saveGGplot(gp, paste0(imgpref, 'polygons_', 'braakcls_region'),
    w=.5 + 1.25 * 6, h=.75 + 1.25 * 3)

# Massive individual by region plot:
gp = plotPoly(df, 'projid ~ region')  # individual vs. region
saveGGplot(gp, paste0(imgpref, 'polygons_', 'projid_region'),
    w=.5 + 1.25 * 6 / 2, h=.75 + 1.25 * 48 / 2)

# Alternatively, use raster:
gp = ggplot(df, aes(x=C1, y=C2)) +
    facet_wrap(~cogdxad) + 
    stat_density_2d(aes(fill = ..density..), geom = "raster", contour = FALSE) +
    scale_fill_continuous(type = 'viridis') +
    theme_pubr() + 
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme(legend.position='none')
w = .5 + 1.25 * 2
h = .75 + 1.25 * 1
saveGGplot(gp, paste0(imgpref, 'rasterdensity_', 'cogdxad'), w=w, h=h)


# Plot the umap, with appropriate proportions:
# --------------------------------------------
palette = viridis(100)
col_fun = function(x, pal=palette, mx=NULL){
    if (is.null(mx)){mx=max(x)} else {x[x > mx] = mx}
    bin <- cut(x, seq(0, mx, length.out=length(palette)), include.lowest=T) 
    palette[bin]  }

cex = 0.025
sp = 0.1
w=1; h=1

for (path in c('nft','plaq_n','plaq_d', 'dpt_pseudotime')){
    ind = which(!is.na(df[[path]]))
    ind = ind[order(df[ind,path])]
    png(paste0(imgpref, 'umap_', path, '.png'), units='in', res=450, width=w, height=h)
    par(xaxs='i',yaxs='i')
    par(mar=rep(sp,4))
    plot(df$C1[ind], df$C2[ind], 
        col=col_fun(df[ind, path]), pch='.', cex=cex, axes=F)
    dev.off()
}


# Plot leiden clusters and cell types as well:
# --------------------------------------------
j = 38
leiden.lvls = sort(unique(df$leiden))
leiden.cols = snap.cols[(j+1):(j+length(leiden.lvls))]
names(leiden.cols) = as.character(leiden.lvls)

# Panel by panel:
ldf = aggregate(cbind(C1, C2) ~ leiden, df, median)

png(paste0(imgpref, 'umap_leiden.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=leiden.cols[as.character(df$leiden)], pch='.', cex=cex, axes=F)
with(ldf, text(C1, C2, leiden, cex=.5, font=2))
dev.off()

w = 1; h=1
png(paste0(imgpref, 'umap_ct.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=tcols[as.character(df$celltype)], pch='.', cex=cex, axes=F)
dev.off()

png(paste0(imgpref, 'umap_projid.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=projid.cols[as.character(df$projid)], pch='.', cex=cex, axes=F)
dev.off()


png(paste0(imgpref, 'umap_region.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=reg.cols[as.character(df$region)], pch='.', cex=cex, axes=F)
dev.off()


png(paste0(imgpref, 'umap_sex.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=c('grey80','red')[df$msex + 1], pch='.', cex=cex, axes=F)
dev.off()


png(paste0(imgpref, 'umap_e4.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=c('no'='grey80','yes'='royalblue')[df$Apoe_e4], pch='.', cex=cex, axes=F)
dev.off()

png(paste0(imgpref, 'umap_cog.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1, df$C2, 
    col=c('CTRL'='grey80','AD'='red')[df$cogdxad], pch='.', cex=cex, axes=F)
dev.off()



# Aggregate-level metadata for belonging to specific clusters:
# ------------------------------------------------------------
ctdf = agg.rename(barcode ~ projid + region + leiden, df, length, 'count')
totdf = agg.rename(barcode ~ projid + region, df, length, 'total')
ctdf = merge(ctdf, totdf)
ctdf$frac = ctdf$count / ctdf$total
ctdf$rl = with(ctdf, paste0(region, '_', leiden))

lcol = c('0', '1', '4','2','3','5','6','7')
lcol = c('0', '1', '2', '4')
lstr = paste(sort(lcol), collapse='-')
subdf = ctdf[ctdf$leiden %in% lcol,]
mat = pivot.tomatrix(subdf[, 
    c('projid','rl','frac')], 'rl','frac')
mat = reord(mat)
ll = diag.mat2(mat)
mat = mat[,ll[[2]]]

# Make annotation:
umeta = unique(metadata[metadata$region == 'PFC',
    c('projid','nrad','cogdxad','cogdx', 'niareagansc', 'age_death',
        'msex', 'braaksc', 'Apoe_e4','gpath','tangles','amyloid', 'cogn_global_lv')])
rownames(umeta) = umeta$projid
umeta = umeta[as.character(rownames(mat)),]


# Per-region metadata:
# --------------------
pqdf = merge(pqdf, unique(metadata[,c('projid','region','rind')]))
pqdf$rind = NULL
plong = gather(pqdf, path, val, -projid, -region)
plong$pr = paste0(plong$region, "_", plong$path)
pwide = spread(plong[,c('pr','projid','val')], pr, val)
pmat = as.matrix(pwide[,-1])
rownames(pmat) = pwide$projid
pmat = pmat[as.character(rownames(mat)),]

age.col_fun = colorRamp2(range(umeta$age_death), c("white", "slateblue")) 
pmi.col_fun = colorRamp2(c(2, 15), c("white", "indianred")) 
gpath.col_fun = colorRamp2(c(0, max(umeta$gpath)), c("white", "indianred")) 
gcog.col_fun = colorRamp2(c(min(umeta$cogn_global_lv), max(umeta$cogn_global_lv)),
    c("red", 'white')) 
# mat.col_fun = colorRamp2(c(0, max(pmat, na.rm=T)), c("white", "blue")) 

# Make matrix and annotations:
# clsplit = umeta$region
ha = HeatmapAnnotation(
    Sex=ifelse(umeta$msex == 0, 'female','male'), 
    # PMI=umeta$pmi,
    Age=umeta$age_death,
    Apoe_e4=umeta$Apoe_e4,
    GPath=umeta$gpath,
    Braak=umeta$braaksc,
    AD=umeta$niareagansc,
    Cognition=umeta$cogdx,
    GlobalCog=umeta$cogn_global_lv,
    col=list(AD=colvals[['niareagansc']],
        Apoe_e4=c('no'='grey95','yes'='grey70'),
        Age=age.col_fun,
        GPath=gpath.col_fun,
        GlobalCog=gcog.col_fun,
        # PMI=pmi.col_fun,
        Braak=colvals[['braaksc']],
        Cognition=colvals[['cogdx']],
        Sex=colvals[['sex']]), which='row')


ux = 1.5
ht = Heatmap(mat, 
    width=ncol(mat) * unit(ux, 'mm'),
    height=nrow(mat) * unit(ux, 'mm'),
    right_annotation=ha,
    column_split=sub(".*_","", colnames(mat)), 
    border_gp = gpar(color='black', lwd=.5),
    cluster_columns=FALSE,
    cluster_rows=FALSE,
    col=colb)

htpath = Heatmap(pmat, 
    name='Path.\nDensity', 
    width=ncol(pmat) * unit(1.25 * ux, 'mm'),
    height=nrow(pmat) * unit(ux, 'mm'),
    col=colb,
    use_raster=FALSE,
    column_split=sub("_.*","", colnames(pmat)), 
    cluster_columns=FALSE,
    cluster_rows=FALSE,
    border_gp = gpar(color='black', lwd=.5)
)

w = 5 + (ncol(mat) + ncol(pmat)) / 15 
h = 2 + nrow(mat) / 15 
pltprefix = paste0(imgpref, 'heatmap_leiden', lstr)
saveHeatmap(ht + htpath, pltprefix, w=w, h=h)


# Boxplots of pseudotime by pathology order:
# ------------------------------------------
plvls = umeta$projid[order(umeta$gpath)]
df$projid = factor(df$projid, levels=plvls)
df$gpath = umeta[as.character(df$projid), 'gpath']
df$cogdxad = umeta[as.character(df$projid), 'cogdxad']

gp = ggplot(df, aes(projid, C2, fill=cogdxad)) + 
    geom_boxplot() + 
    geom_violin() + 
    theme_pubr() 

ctdf = merge(umeta, ctdf, all.y=TRUE)
sub.ctdf = ctdf[ctdf$leiden %in% lcol,]
gp = ggplot(sub.ctdf, aes(gpath, frac, color=Apoe_e4)) + 
    facet_wrap(~factor(leiden), scales='free') +
    geom_point(cex=.75) + 
    geom_smooth(method='lm', se=TRUE) + 
    stat_cor(output.type='text', label.sep="\n") + 
    stat_cor(color='black', label.x.npc=0.5, output.type='text', label.sep="\n") + 
    theme_pubr()
pltprefix = paste0(imgpref, 'scatter_Apoe4', lstr)
saveGGplot(gp, pltprefix, h=5, w=5)

gp = ggplot(sub.ctdf, aes(gpath, frac, color=region)) + 
    facet_wrap(~factor(leiden), scales='free') +
    geom_point(cex=.75) + 
    geom_smooth(method='lm', se=TRUE) + 
    scale_color_manual(values=reg.cols) +
    stat_cor(output.type='text', label.sep="\n") + 
    stat_cor(color='black', label.x.npc=0.5, output.type='text', label.sep="\n") + 
    theme_pubr()
pltprefix = paste0(imgpref, 'scatter_region', lstr)
saveGGplot(gp, pltprefix, h=5, w=5)


# Pathology measurements:
# -----------------------
ctrdf = merge(ctdf, unique(metadata[,c('projid','region','rind')]))
ctrdf = merge(ctrdf, pqdf)

ggplot(ctrdf, aes(log1p(plaq_d), frac, color=region)) + 
    facet_wrap(~factor(leiden), scales='free') +
    geom_point() + 
    scale_color_manual(values=reg.cols) + 
    geom_smooth(method='lm', se=FALSE) + 
    # geom_smooth(method='loess', se=FALSE) + 
    stat_cor() + 
    theme_pubr()


# Get the non-pseudobulk data for plotting on a cell-level (only EC for now):
# ---------------------------------------------------------------------------
source(paste0(sbindir, 'auxiliary_pseudobulk_loading_fns.R'))
nmat = load_full_dataset('Exc', exc.sets[['ECneurons']], 'EC')
# all.exc = unlist(exc.sets)
# nmat = load_full_dataset('Exc', all.exc, reg.nomb)
rownames(df) = df$barcode
subdf = df[colnames(nmat),]

# Plot the genes on the trajectory umap:
# --------------------------------------
genes = c('CLTB', 'AP2M1', 'NRGN', 'PRNP', 'PKM', 'CALR', 'FAIM2', 'DHFR',
    'SLC27A6', 'YPEL1', 'CRK', 'NCAM2', 'ABCA7', 'UBTF', 'MT-CO3',
    'MT-ND3', 'PLCG2', 'CLU', 'NEUROD2', 'NOXA1', 'KAZN', 'PSEN1', 'APP',
    'CHN1','HSP90AA1','PEBP1')
submat = log1p(as.matrix(nmat[genes,]))

w = 1; h=1
for (gene in genes){
    x = submat[gene,]
    ind = which(!is.na(x))
    ind = ind[order(x[ind])]
    png(paste0(imgpref, 'umap_gene_', gene, '.png'), units='in', res=450, width=w, height=h)
    par(xaxs='i',yaxs='i')
    par(mar=rep(sp,4))
    plot(subdf$C1[ind], subdf$C2[ind], 
        col=col_fun(x[ind]), pch=19, cex=cex, axes=F)
    mtext(gene, side=1, line=-1, font=2)
    dev.off()
}




