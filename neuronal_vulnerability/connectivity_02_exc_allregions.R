#!/usr/bin/R
# --------------------------------------------------------------------------------------
# Investigate the co-variation of selective vulnerability across all excitatory neurons:
# TODO: Neurons alone and neurons + glia
# Updated 12/21/2021
# --------------------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(betareg)

library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)
options(width=150)

# Directories:
plotdir = paste0(imgdir, 'vuln/')
fracdir = paste0(sdbdir, 'fractions/')
imgpref = paste0(plotdir, 'conn_')
cmd = paste('mkdir -p', imgdir, plotdir)
system(cmd)

# ---------------------------------------------
# Get the relative abundances for all subtypes:
# ---------------------------------------------
totdf = agg.rename(barcode ~ projid + region, cellmeta, length, 'total')
etotdf = agg.rename(barcode ~ projid + region, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'exc.total')

# analysis = 'EXC'
analysis = 'All'
if (analysis =='EXC'){
    submeta = cellmeta[cellmeta$major.celltype == 'Exc',]
    ctdf = agg.rename(barcode ~ projid + region + cell_type_high_resolution, submeta, length, 'count')
    combdf = expand.grid(cell_type_high_resolution=unique(submeta$cell_type_high_resolution), 
                         region=unique(submeta$region), projid=unique(submeta$projid))
} else {
    ctdf = agg.rename(barcode ~ projid + region + major.celltype, cellmeta, length, 'count')
    combdf = expand.grid(major.celltype=unique(cellmeta$major.celltype), 
                         region=unique(cellmeta$region), projid=unique(cellmeta$projid))
}

ctdf = merge(ctdf, combdf, all.y=TRUE)
ctdf$count[is.na(ctdf$count)] = 0
ctdf = merge(ctdf, totdf) # Removes a couple missing projid x region comb.
ctdf = merge(ctdf, etotdf)
ctdf$other = ctdf$total - ctdf$count
names(ctdf)[3] = 'celltype'
ctdf$frac = ctdf$count / ctdf$total


# Make a matrix with all of the possible fractions:
# -------------------------------------------------
# Keep only celltypes with > 500 cells in the region
nregdf = aggregate(count ~ region + celltype, ctdf, sum)
nregdf = nregdf[nregdf$count >= 500, c('region', 'celltype')]
ctdf = merge(ctdf, nregdf)

# Make matrix, individual against celltype + region
ctdf$cr = with(ctdf, paste0(celltype, '-', region))
cwide = spread(ctdf[,c('projid','cr','frac')], cr, frac)
cmat = as.matrix(cwide[,2:ncol(cwide)])
cdf = cwide[,c('projid'), drop=F]
cdf = merge(cdf, unique(metadata[,c('projid','msex','age_death','pmi','Apoe_e4', 'nrad','cogdxad')]))
rownames(cmat) = cwide$projid
rownames(cdf) = cdf$projid
cdf = cdf[rownames(cmat),]

# # Keep all for now, 
# keepind = rownames(cmat)[!(is.na(apply(cmat, 1, sum)))]
# cdf = cdf[keepind,]
# cmat = cmat[keepind,]
# # Reorder for plotting:
# if (analysis == 'ECHC'){ cmat = cmat[,c(topec, tophc)] }

# Run regressions if not already computed:
# ----------------------------------------
use.adonly = TRUE
use.betareg = TRUE

suffix = analysis
if (use.betareg){ suffix = paste0(suffix, '_betareg') }
if (use.adonly){ suffix = paste0(suffix, '_adonly') }

conn.reg.tsv = paste0(fracdir, 'connectivity_regressions_', suffix, '.tsv')
conn.reg.file = paste0(fracdir, 'connectivity_regressions_', suffix, '.rda')

if (!file.exists(conn.reg.file)){
    # Initialize regression + cor.test outputs:
    # -----------------------------------------
    NC = ncol(cmat)
    dn = list(colnames(cmat), colnames(cmat))
    cr1mat = matrix(0, nrow=NC, NC, dimnames=dn)
    p1mat = matrix(0, nrow=NC, NC, dimnames=dn)
    conndf = c()

    # Run regressions on each pair:
    # -----------------------------
    for (i in 1:NC){
        for (j in 1:NC){
            # 1: Correlation test (using ranked test for percentages):
            if (use.adonly){ ind = (cdf$nrad == 'AD') } else { ind = 1:nrow(cdf) }
            ct = cor.test(cmat[ind,i], cmat[ind,j], method='kendall')
            p1mat[i,j] = ct$p.value
            cr1mat[i,j] = ct$estimate
            # 2: Regression:
            if (use.betareg){
                # Add offset for beta regression to be in (0,1)
                cdf$ci = cmat[,i] + 1e-3
                cdf$cj = cmat[,j] + 1e-3
            } else {
                # Log transform for low percentages (othw. logit)
                cdf$ci = log10(cmat[,i] + 1e-3)
                cdf$cj = log10(cmat[,j] + 1e-3)
            }
            fracform = as.formula('ci ~ cj + msex + Apoe_e4 + pmi + age_death')
            if (use.betareg){
                fit = betareg(fracform, cdf[ind,])
                cfit = coefficients(summary(fit))$mean
                colnames(cfit) = c('est','SE','z','p')
            } else {
                fit = lm(fracform, cdf[ind,])
                cfit = coefficients(summary(fit))
                colnames(cfit) = c('est','SE','t','p')
            }
            out = cfit['cj',]
            out$cti = colnames(cmat)[i]
            out$ctj = colnames(cmat)[j]
            out$i = i
            out$j = j
            conndf = rbind(conndf, data.frame(out))
        }
    }
    conndf$padj = p.adjust(conndf$p, 'fdr')
    conndf = conndf[order(conndf$p),]

    cr2mat = matrix(1, NC, NC, dimnames=dn)
    p2mat = matrix(1, NC, NC, dimnames=dn)
    # NOTE: Not symmetric:
    cr2mat[as.matrix(conndf[,c('i','j')])] = conndf$est
    p2mat[as.matrix(conndf[,c('i','j')])] = conndf$padj

    save(conndf, cr1mat, p1mat, cr2mat, p2mat, file=conn.reg.file)
    write.table(conndf, conn.reg.tsv, quote=F, row.names=F, sep="\t")
} else {
    load(conn.reg.file)
}

col_fun = colorRamp2(c(-.5, 0, .5), c('blue', 'white', 'red'))
# col_fun = colorRamp2(c(-1, 0, 1), c('blue', 'white', 'red'))

if (analysis == 'EXC'){
    kept.sets = outer(exc.sets[['CTXneurons']], c('-AG','-MT','-PFC'), paste0)
    kept.sets = c(kept.sets, paste0(exc.sets[['HCneurons']], '-HC'))
    kept.sets = c(kept.sets, paste0(exc.sets[['ECneurons']], '-EC'))
    kept.sets = c(kept.sets, paste0(exc.sets[['THneurons']], '-TH'))
    kept.cols = colnames(cr1mat)[colnames(cr1mat) %in% kept.sets]
    pltmat = cr1mat[kept.cols, kept.cols]
    plt.pmat = p2mat[kept.cols, kept.cols]
} else {
    pltmat = cr1mat
    plt.pmat = p2mat
}

plt = Heatmap(pltmat,
              use_raster=TRUE,
              cluster_columns=FALSE, 
              cluster_rows=FALSE, 
              col=col_fun,
              column_split=sub(".*-","", colnames(pltmat)),
              row_split=sub(".*-","", rownames(pltmat)),
              width = ncol(pltmat)*unit(5, "mm"), 
              height = nrow(pltmat)*unit(5, "mm"),
              rect_gp = gpar(type = "none"), column_dend_side = "bottom",
              cell_fun = function(j, i, x, y, w, h, fill) {
                  # cond1 = (as.numeric(x) > 1 - as.numeric(y) + 1e-6)
                  # cond2 = (i <= length(topec) & j > length(topec))
                  # cond3 = (i > length(topec) & j <= length(topec))
                  # if((cond1 | cond2) & (!cond3)) {
                      grid.rect(x, y, w, h, gp = gpar(fill = fill, col = fill))
                      if (i != j){
                          p = plt.pmat[i,j] # Adjusted p-values from regression.
                          ann = ifelse(p < 0.05, ifelse(p < 0.01, ifelse(p < 0.001, '***','**'),'*'),'')
                          grid.text(ann, x, y)
                      }
                  # }
              })


# Correlation + p-value from regression accounting for covariates
pltprefix = paste0(imgpref, 'correlation_regrpvals_', suffix, '_heatmap')
w = 18
pdf(paste0(pltprefix, '.pdf'), width=w, height=w)
print(plt)
dev.off()
png(paste0(pltprefix, '.png'), units='in', res=400, width=w, height=w)
print(plt)
dev.off()



# Plot the top correlated neuronal subtypes across regions:
# ---------------------------------------------------------
conndf$regi = sub(".*-","", conndf$cti)
conndf$regj = sub(".*-","", conndf$ctj)
crossdf = conndf[conndf$regi != conndf$regj,]

head(crossdf, 20)

if (analysis == 'Exc'){
    pairlist = list(c('Exc AGBL1 GPC5-EC', 'Exc L6 CT-MT'),
                    c('Exc TOX3 INO80D-EC', 'Exc L4-5 RORB GABRG1-PFC'),
                    c('CA1 pyramidal cells-HC', 'Exc L2-3 CBLN2 LINC02306-MT'))
} else {
    # NOTE: Not really appropriate for major cell types - fractions are huge 
    # and outsize influence on other for the same region.
    pairlist = list(c('Exc-PFC', 'Oli-PFC'),
                    c('Exc-AG', 'Oli-AG'),
                    c('Ast-HC', 'Ast-EC'),
                    c('Opc-HC', 'Oli-HC'),
                    c('Opc-MT', 'Opc-AG'))
}

for (pair in pairlist){
    c1 = pair[1] 
    c2 = pair[2]
    suffstr = gsub(" ", "_", paste0(c1, '_vs_', c2))
    print(suffstr)
    cdf$ci = cmat[,c1] + 1e-3
    cdf$cj = cmat[,c2] + 1e-3

    gp = ggplot(cdf, aes(ci, cj, color=nrad)) + 
        geom_point() + 
        scale_color_manual(values=colvals[['nrad']]) + 
        geom_smooth(method='lm') + 
        scale_y_log10(labels=scales::percent) +
        scale_x_log10(labels=scales::percent) +
        # scale_y_continuous(labels=scales::percent) +
        # scale_x_continuous(labels=scales::percent) +
        stat_cor(method='kendall') + 
        # stat_cor(method='kendall', color='black') + 
        labs(x=c1, y=c2) + 
        theme_pubr()
    pltprefix = paste0(imgpref, 'example_', suffstr, '_scatter')
    ggsave(paste0(pltprefix, '.pdf'), units='in', width=3, height=3)
}


