#!/usr/bin/R
# ----------------------------------------
# Plot neuron counts in entorhinal cortex:
# Updated: 12/06/2021
# ----------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
if (!exists("cellmeta")){ source(paste0(sbindir, 'load_metadata.R')) }
source(paste0(sbindir, 'auxiliary_pseudobulk_loading_fns.R'))

library(tidyr)

# Arguments:
args=(commandArgs(TRUE))
if (length(args)==0) {
    stop("No arguments supplied: load.fracs load.counts load.psbulk")
} else {
    load.fracs = args[1]
    load.counts = args[2]
    load.psbulk = args[3]
}


srdir = paste0(sdbdir, 'subtype_reg/')

# EC-specific arguments:
runset = 'ECneurons'
remove.batches = TRUE
ststr = gsub("/","_", runset)
subtypes = exc.sets[[runset]]
celltype = 'Exc'


# Load abundances data:
# ---------------------
if (load.fracs){
    print("Loading EC abundances")
    # Load in and process data (saves to matrices):
    commandArgs <- function(trailingOnly=TRUE){c(runset, remove.batches)}
    source(paste0(sbindir, 'metadata_markers/load_proportions_data.R'))

    ctdf = merge(ctdf, unique(metadata[,c('projid','nft_ec','plaq_d_ec','plaq_n_ec', 'braaksc','cogdx','niareagansc','msex','age_death','pmi', 'Apoe_e4', 'nrad','cogdxad')]))
}


# Load counts matrices:
# ---------------------
if (load.counts){
    print("Loading EC counts")
    fulldata.rda = paste0(srdir, 'full_norm_data_', ststr, '.rda')
    if (!file.exists(fulldata.rda)){
        nmat = load_full_dataset('Exc', subtypes, 'EC', normalize=TRUE)
        save(nmat, file=fulldata.rda)
    } else { load(fulldata.rda) }
}


# Load pseudobulk data:
# ---------------------
if (load.psbulk){
    print("Loading EC pseudobulk")
    psdata.rda = paste0(srdir, 'pseudobulk_data_', ststr, '.rda')
    if (!file.exists(psdata.rda)){
        ps.data = load_pseudobulk_dataset('Exc', subtypes, 'EC')
        save(ps.data, file=psdata.rda)
    } else { load(psdata.rda) }
}


topec = sort(exc.sets[[runset]])
eid = c(1,0,0,1,1,0,0,0,1)
names(eid) = topec


