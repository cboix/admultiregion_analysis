#!/usr/bin/R
# ------------------------------------------------------------------------------
# Investigate the fractional content in EC/HC and other celltypes with cognition
# Plot the boxplots and scatter plots for top vuln cell types
# Updated 12/08/2022
# ------------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(lme4)
library(qvalue)

library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)

# Directories:
plotdir = paste0(imgdir, 'metadata/')
imgpref = paste0(plotdir, 'cogn_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

# --------------------------------------
# Select neuronal subtypes in EC and HC:
# --------------------------------------
rdf = agg.rename(barcode ~ region + cell_type_high_resolution, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'count')
rdf = spread(rdf, region, count, fill=0)
rmat = as.matrix(rdf[,-1])
rownames(rmat) = rdf[,1]
topec = apply(rmat,1, max) == rmat[,'EC']
topec = names(topec)[topec]
topec = topec[topec != 'Exc SV2C LINC02137']
topec = topec[topec != 'Exc SOX11 NCKAP5'] # Very few cells
tophc = apply(rmat,1, max) == rmat[,'HC']
tophc = names(tophc)[tophc]

# ---------------------------------------------
# Get the relative abundances for all subtypes:
# ---------------------------------------------
totdf = agg.rename(barcode ~ projid + region, cellmeta, length, 'total')
etotdf = agg.rename(barcode ~ projid + region, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'exc.total')
ctypes = unique(cellmeta$major.celltype)

analysis = 'ECHC'
# analysis = 'All'
# analysis = 'Exc'
# analysis = 'Inh'
if (analysis == 'ECHC'){
    submeta = cellmeta[cellmeta$major.celltype == 'Exc' & cellmeta$region %in% c('EC', 'HC'),]
    ctdf = agg.rename(barcode ~ projid + region + cell_type_high_resolution, submeta, length, 'count')
    combdf = merge(data.frame(cell_type_high_resolution=unique(submeta$cell_type_high_resolution)),
                   unique(submeta[,c('region','projid')]))
} else if (analysis %in% ctypes){
    submeta = cellmeta[cellmeta$major.celltype == analysis ,]
    ctdf = agg.rename(barcode ~ projid + region + cell_type_high_resolution, submeta, length, 'count')
    combdf = merge(data.frame(cell_type_high_resolution=unique(submeta$cell_type_high_resolution)),
                   unique(submeta[,c('region','projid')]))
} else {
    ctdf = agg.rename(barcode ~ projid + region + major.celltype, cellmeta, length, 'count')
    combdf = merge(data.frame(major.celltype=unique(cellmeta$major.celltype)),
                   unique(cellmeta[,c('region','projid')]))
}

ctdf = merge(ctdf, combdf, all.y=TRUE)
ctdf$count[is.na(ctdf$count)] = 0
ctdf = merge(ctdf, totdf) # Removes a couple missing projid x region comb.
ctdf = merge(ctdf, etotdf)
ctdf$other = ctdf$total - ctdf$count
names(ctdf)[3] = 'celltype'
ctdf$frac = ctdf$count / ctdf$total


# ----------------------------------------
# Merge with the extended ROSMAP metadata: 
# ----------------------------------------
cog.cols = colnames(metadata)[grep("^cogn", colnames(metadata))]
cog.cols = cog.cols[grep("_lv",cog.cols)]
covarcols = c('msex','Apoe_e4', 'age_death', 'apoe_genotype', 'pmi')
advars = c('niareagansc','nrad','cogdxad','braaksc56', 'ceradsc','braaksc','cogdx')
pathvars = c('nft','plaq_n','plaq_d')
metadata$braaksc56 = 'CTRL'
metadata$braaksc56[metadata$braaksc %in% c(5,6)] = 'AD'
metadata$braaksc56 = factor(metadata$braaksc56, levels=c('CTRL','AD'))

# Merge onto counts table:
ctdf = merge(ctdf, unique(metadata[,c('projid','rind','region',
                                      cog.cols, covarcols, advars)]), all.x=TRUE)
ctdf = merge(ctdf, pqdf, all.x=TRUE)
ctdf$nft = log1p(ctdf$nft)
ctdf$plaq_n = log1p(ctdf$plaq_n)
ctdf$plaq_d = log1p(ctdf$plaq_d)

if (analysis == 'ECHC'){
    df1 = ctdf[ctdf$celltype %in% topec & ctdf$region == 'EC',]
    df2 = ctdf[ctdf$celltype %in% tophc & ctdf$region == 'HC',]
    df1 = rbind(df1, df2)
} else {
    df1 = ctdf
}

# TODO: if cogdx, remove cogdx=6


# ----------------------------------------------
# Run independent regressions for each variable:
# ----------------------------------------------
df1$lfrac = log10(df1$frac + 1e-3)
frac.var = 'lfrac'
outdf = c()
extra = '+ age_death + msex + pmi + Apoe_e4'
# for (advar in c(cog.cols)){
for (advar in c(cog.cols, advars, pathvars)){
    cdf = c()
    for (ct in unique(df1$celltype)){
        df = df1[df1$celltype == ct,]
        if (advar %in% c('nrad','cogdxad','braaksc56')){
            family = 'binomial' 
            adstr = paste0(advar,'AD')
        } else {
            family = 'gaussian'
            adstr = advar
        }
        # Overall fraction or neuronal or CLR?
        if (analysis == 'ECHC'){
            # fit = glm(asform(c('frac ~',advar, extra)), df, family='gaussian')
            fit = glm(asform(c(advar, '~ ', frac.var, extra)), df, family=family)
        } else {
            # fit = glm(asform(c('frac ~',advar, '+ region', extra)), df, family='gaussian')
            fit = glm(asform(c(advar, '~', frac.var, '+ region', extra)), df, family=family)
        }
        cfit = coefficients(summary(fit))
        colnames(cfit) = c('est','SE','t','p')
        out = cfit[frac.var,]
        out$celltype = ct
        out$advar = advar
        cdf = rbind(cdf, data.frame(out))
    }
    # cdf$padj = p.adjust(cdf$p, 'fdr')
    outdf = rbind(outdf, cdf)
}
outdf = outdf[order(outdf$p),]
outdf$padj = p.adjust(outdf$p, 'fdr')
# outdf$padj = qvalue(outdf$p)$q
# Flip signs for certain scores:
ind = outdf$advar %in% c(cog.cols, c('ceradsc','niareagansc'))
outdf$est[ind] = -outdf$est[ind]

# p-value histogram for outputs:
png(paste0(imgpref, 'fulladvars_eff_',analysis,'_pvalhist.png'), res=400, units='in', width=5, height=5)
par(mar=c(3,3,1,.5), yaxs='i', yaxs='i')
hist(outdf$p)
dev.off()

load.colors()
col_fun = colorRamp2(c(-0.02, 0, 0.02), c('blue', "white", 'red'))

# Matrix of estimates:
for (pcol in c('p','padj')){
    cmat = pivot.tomatrix(outdf[,c('est','celltype','advar')], 'advar', 'est')
    pmat = pivot.tomatrix(outdf[,c(pcol,'celltype','advar')], 'advar', pcol)
    # Coefficient relative to percentage points:
    cmat = cmat / 100
    cmat[cmat > 1] = 1
    cmat[cmat < -1] = -1

    # Splits for matrix:
    csplit = rep('Pathology', ncol(cmat))
    csplit[grep("^cogn", colnames(cmat))] = 'Cognition'
    csplit[colnames(cmat) %in% c('cogn_global_lv','cogdx','cogdxad')] = 'Global Cog.'
    if (analysis == 'ECHC'){
        rsplit = ifelse(rownames(cmat) %in% tophc, 'Hippocampus','Entorhinal Cortex')
    } else {
        rsplit = NULL
    }

    plt = Heatmap(cmat,
                  use_raster=TRUE,
                  col=col_fun,
                  column_split=csplit,
                  row_split=rsplit,
                  width = ncol(cmat)*unit(5, "mm"), 
                  height = nrow(cmat)*unit(4, "mm"),
                  border_gp = gpar(col="black", lty = 1),
                  cell_fun = function(j, i, x, y, w, h, col){ # Add the p-value text
                      p = pmat[i,j]
                      ann = ifelse(p < 0.1, 
                                   ifelse(p < 0.05, 
                                          ifelse(p < 0.01,
                                                 ifelse(p < 0.001, '***','**'),
                                                 '*'),'.'),'')
                      grid.text(ann, x, y)}
    )

    h = 2.5 + 2.5 / 15 * nrow(cmat)
    pdf(paste0(imgpref, 'fulladvars_eff_',analysis,'_heatmap_', frac.var, '_' ,pcol, '.pdf'), width=7, height=h)
    print(plt)
    dev.off()

    png(paste0(imgpref, 'fulladvars_eff_',analysis,'_heatmap_',frac.var, '_', pcol, '.png'), units='in', res=400, width=7, height=h)
    print(plt)
    dev.off()
}



# TODO: Separate analysis of fraction of celltype given APOE genotype:
# --------------------------------------------------------------
if (analysis == 'ECHC'){
    gplot = ggplot(unique(df1), aes(lfrac, cogn_global_lv, color=celltype)) + 
        facet_wrap(~celltype, scales='free_x') + 
        scale_color_manual(values=tcols) + 
        stat_cor(label.x=-2) +
        # stat_regline_equation(label.x=-2) + 
        geom_point() + 
        labs(x='log10 Fraction of cells',y='Global Cognition at last visit') +
        geom_smooth(method='lm') + 
        theme_pubr() + theme(legend.position='none')
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'.png'), gplot, units='in', dpi=400, width=7, height=8)
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'.pdf'), gplot, units='in', dpi=400, width=7, height=8)


    gplot = ggplot(unique(df1), aes(nrad, frac, fill=nrad)) + 
        facet_wrap(~celltype, scales='free_x') + 
        scale_fill_manual(values=colvals$nrad) + 
        stat_compare_means(label.y=0.01) + coord_flip() +
        scale_y_continuous(labels=scales::percent) + 
        # stat_regline_equation(label.x=-2) + 
        geom_boxplot() + 
        labs(x='Percent of cells',y='NIA-Reagan') +
        theme_pubr() + theme(legend.position='none')
    ggsave(paste0(imgpref, 'boxplot_nrad_eff_',analysis,'_raw.png'), gplot, units='in', dpi=400, width=7, height=5)
    ggsave(paste0(imgpref, 'boxplot_nrad_eff_',analysis,'_raw.pdf'), gplot, units='in', dpi=400, width=7, height=5)

    gplot = ggplot(unique(df1), aes(frac, cogn_global_lv, color=nrad)) + 
        facet_wrap(~celltype, scales='free_x') + 
        scale_color_manual(values=colvals$nrad) + 
        stat_cor(label.x=0.01, color='black') +
        geom_smooth(method='lm', color='black') + 
        scale_x_continuous(labels=scales::percent) + 
        # stat_regline_equation(label.x=-2) + 
        geom_point() + 
        labs(x='Percent of cells',y='Global Cognition at last visit') +
        theme_pubr() + theme(legend.position='none')
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'_raw.png'), gplot, units='in', dpi=400, width=7, height=8)
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'_raw.pdf'), gplot, units='in', dpi=400, width=7, height=8)


    gplot = ggplot(unique(df1), aes(lfrac, cogn_ep_lv, color=celltype)) + 
        facet_wrap(~celltype, scales='free_x') + 
        scale_color_manual(values=tcols) + 
        stat_cor(label.x=-2) +
        # stat_regline_equation(label.x=-2) + 
        geom_point() + 
        labs(x='log10 Fraction of cells',y='Episodic Cognition at last visit') +
        geom_smooth(method='lm') + 
        theme_pubr() + theme(legend.position='none')
    ggsave(paste0(imgpref, 'scatter_cogneplv_eff_',analysis,'.png'), gplot, units='in', dpi=400, width=7, height=8)
    ggsave(paste0(imgpref, 'scatter_cogneplv_eff_',analysis,'.pdf'), gplot, units='in', dpi=400, width=7, height=8)

    gplot = ggplot(unique(df1), aes(lfrac, cogn_global_lv, color=factor(Apoe_e4))) + 
        facet_wrap(~celltype, scales='free_x') + 
        labs(x='log10 Fraction of cells',y='Global Cognition at last visit') +
        geom_point() + 
        geom_smooth(method='lm') + 
        theme_pubr() + theme(legend.position='top')
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'_e4.png'), gplot, units='in', dpi=400, width=7, height=8)
} else {

    gplot = ggplot(unique(df1), aes(lfrac, cogn_global_lv, color=celltype)) + 
        facet_grid(region~celltype, scales='free_x') + 
        scale_color_manual(values=major.col) + 
        geom_point(cex=.5) + 
        labs(x='log10 Fraction of cells',y='Global Cognition at last visit') +
        geom_smooth(method='lm') + 
        stat_cor(color='black', output.type='latex', label.sep='\n', cex=2, label.y.npc=1) + 
        theme_pubr() + theme(legend.position='none') + 
        theme(axis.text.x = element_text(size=8, angle=90, hjust=1, vjust=.5), axis.text.y = element_text(size=8)) 
    ggsave(paste0(imgpref, 'scatter_log10frac_cogngloballv_eff_',analysis,'.png'), gplot, units='in', dpi=400, width=8, height=5)
    ggsave(paste0(imgpref, 'scatter_log10frac_cogngloballv_eff_',analysis,'.pdf'), gplot, units='in', dpi=400, width=8, height=5)


    gplot = ggplot(unique(df1), aes(lfrac, cogn_global_lv, color=region)) + 
        facet_wrap(~celltype, scales='free_x') + 
        scale_color_manual(values=reg.cols) + 
        geom_point(cex=.5) + 
        labs(x='log10 Fraction of cells',y='Global Cognition at last visit') +
        geom_smooth(method='lm') + 
        stat_cor(color='black', output.type='latex', label.sep='\n', cex=2, label.y.npc=1) + 
        stat_cor(output.type='latex', label.sep='; ', cex=2, label.y.npc=0) + 
        theme_pubr() + theme(legend.position='none') + 
        theme(axis.text.x = element_text(size=8, angle=90, hjust=1, vjust=.5), axis.text.y = element_text(size=8)) 

    ggsave(paste0(imgpref, 'scatter_log10frac_cogngloballv_eff_allregion_',analysis,'.png'), gplot, units='in', dpi=400, width=7, height=8)
    ggsave(paste0(imgpref, 'scatter_log10frac_cogngloballv_eff_allregion_',analysis,'.pdf'), gplot, units='in', dpi=400, width=7, height=8)



    gplot = ggplot(unique(df1), aes(frac, cogn_global_lv, color=celltype)) + 
        facet_grid(region~celltype, scales='free_x') + 
        scale_color_manual(values=major.col) + 
        geom_point(cex=.5) + 
        labs(x='log10 Fraction of cells',y='Global Cognition at last visit') +
        geom_smooth(method='lm') + 
        stat_cor(color='black', output.type='latex', label.sep='\n', cex=2, label.y.npc=1) + 
        theme_pubr() + theme(legend.position='none') + 
        theme(axis.text.x = element_text(size=8, angle=90, hjust=1, vjust=.5), axis.text.y = element_text(size=8)) 
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'.png'), gplot, units='in', dpi=400, width=8, height=5)
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'.pdf'), gplot, units='in', dpi=400, width=8, height=5)


    gplot = ggplot(unique(df1), aes(lfrac, cogn_global_lv, color=factor(Apoe_e4))) + 
        facet_grid(region~celltype, scales='free_x') + 
        labs(x='log10 Fraction of cells',y='Global Cognition at last visit') +
        geom_point() + 
        geom_smooth(method='lm') + 
        theme_pubr() + theme(legend.position='top')
    ggsave(paste0(imgpref, 'scatter_cogngloballv_eff_',analysis,'_e4.png'), gplot, units='in', dpi=400, width=9, height=6)

}


# Slices for OPC validation:
# --------------------------
if (analysis == 'All'){
    hdf = read.delim("Annotation/multiregion_slices_id_region.tsv", header=T)
    subdf = df1[df1$region %in% c('EC','HC') & df1$celltype %in% 'Opc',]
    subdf = subdf[subdf$projid %in% hdf$projid,]
    subdf$frac.adj = subdf$count / (subdf$total - subdf$exc.total)

    gplot = ggplot(unique(subdf), aes(frac.adj, cogn_global_lv, label=projid, color=plaq_n)) + 
        facet_wrap(~region, scales='free_x') + 
        scale_color_viridis_c() + 
        geom_point(cex=.5) + 
        geom_text_repel(cex=2) + 
        labs(x='% OPCs of all non-excitatory neuron cells',y='Global Cognition at last visit') +
        scale_x_continuous(labels=scales::percent) + 
        geom_smooth(method='lm', color='black') + 
        stat_cor(color='black', output.type='latex', label.sep='\n', cex=2, label.y.npc=1) + 
        theme_pubr() + theme(legend.position='top')
    ggsave(paste0(imgpref, 'scatter_frac_cogngloballv_slices_',analysis,'_plaq_n.png'), gplot, units='in', dpi=400, width=7, height=5)

    gplot = ggplot(unique(subdf), aes(frac.adj, cogn_global_lv, label=projid, color=nft)) + 
        facet_wrap(~region, scales='free_x') + 
        scale_color_viridis_c() + 
        geom_point(cex=.5) + 
        geom_text_repel(cex=2) + 
        labs(x='% OPCs of all non-excitatory neuron cells',y='Global Cognition at last visit') +
        scale_x_continuous(labels=scales::percent) + 
        geom_smooth(method='lm', color='black') + 
        stat_cor(color='black', output.type='latex', label.sep='\n', cex=2, label.y.npc=1) + 
        theme_pubr() + theme(legend.position='top')
    ggsave(paste0(imgpref, 'scatter_frac_cogngloballv_slices_',analysis,'_nft.png'), gplot, units='in', dpi=400, width=7, height=5)

    # Write out the table for slice selection:
    ext.meta = read.delim('Annotation/metadata_PFC_all_individuals_092520.tsv', header=T)
    corevar = c('frac.adj','nft','plaq_n','plaq_d')
    othervar = c('cogn_global_lv', 'niareagansc','cogdx', 'msex', 'apoe_genotype')
    ecdf = unique(subdf[subdf$region == 'EC',c('projid', corevar)])
    hcdf = unique(subdf[subdf$region == 'HC',c('projid', corevar)])
    names(ecdf) = c('projid', paste0(corevar, '.EC'))
    names(hcdf) = c('projid', paste0(corevar, '.HC'))
    slicedf = merge(ecdf, hcdf)
    slicedf = merge(slicedf, unique(ext.meta[,c('projid',othervar)]))
    slicedf = slicedf[order(slicedf$cogn_global_lv), ]
    write.table(slicedf, 'multiRegion/fractions/opc_fraction_slice_selection_table.tsv', quote=F, row.names=F, sep="\t")


    # Adjust by removing number of neurons:
    subdf = df1[df1$region %in% c('EC','HC') & df1$projid %in% hdf$projid & df1$celltype == 'Exc',]

}
