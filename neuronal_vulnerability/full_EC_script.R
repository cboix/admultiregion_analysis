#!/usr/bin/R
# -----------------------------------------------------
# Investigate selective vulnerability of the EC neurons
# NOTE: taking chunks out of this to split up and clean analysis.
# Updated: 03/08/2021 
# Cleaned: 12/06/2021 +
# -----------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(lme4)
library(emmeans)

library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)

# Directories:
topimgdir = paste0(img, 'multiRegion/')
plotdir = paste0(img, 'multiRegion/metadata/')
imgpref = plotdir
cmd = paste('mkdir -p', topimgdir, plotdir)
system(cmd)



frac.reg.file = paste0(fracdir, 'estimated_fraction_changes_ECneurons.tsv')
frac.regdf = read.delim(frac.reg.file, sep="\t")


# ----------------------------------------
# Create average matrices; calculate corr:
# ----------------------------------------
tform = make.tform(lbs, u=topec, norm=TRUE)
tform.ctrl = make.tform(lbs[bind], u=topec, norm=TRUE)
tform.ad = make.tform(lbs[!bind], u=topec, norm=TRUE)
# Normalized to median or not:
use.norm=TRUE
if (!use.norm){
    avgmat = as.matrix(amat %*% tform)
    avgmat.ctrl = as.matrix(amat[,bind] %*% tform.ctrl)
    avgmat.ad = as.matrix(amat[,!bind] %*% tform.ad)
} else {
    avgmat = as.matrix(nmat %*% tform)
    avgmat.ctrl = as.matrix(nmat[,bind] %*% tform.ctrl)
    avgmat.ad = as.matrix(nmat[,!bind] %*% tform.ad)
}

# Calculate the correlation between the averages + vulnerable cells
cv = cor(t(avgmat.ctrl), t(t(eid)))
cdf = data.frame(cor=cv, im=apply(avgmat.ctrl[,eid ==1],1, mean),
                 om=apply(avgmat.ctrl[,eid == 0],1, mean), 
                 tm=apply(avgmat.ctrl,1, mean))
cdf = cdf[!is.na(cdf$cor),]
cdf = cdf[order(cdf$cor, decreasing=T),, drop=FALSE]
cdf$symbol = rownames(cdf)
cdf$diff = cdf$im - cdf$om

labdf = rbind(head(cdf[cdf$im > 1,], 20),
              tail(cdf[cdf$om > 1,], 20))

# Plot MA plot - average/difference
g3 = ggplot(cdf, aes(log2(im+om), log2(im/om))) +
    geom_point(col='grey85', cex=.5) + 
    geom_smooth(method='gam') + 
    geom_point(data=labdf, aes(log2(im+om), log2(im/om)), cex=.5) +
    geom_text_repel(data=labdf, aes(log2(im+om), log2(im/om), label=symbol), max.overlaps=20) +
    theme_pubr()
ggsave(paste0(imgpref, 'ECcorr_differences_basic_maplot.png'), g3, dpi=450, units='in', width=8, height=6)
ggsave(paste0(imgpref, 'ECcorr_differences_basic_maplot.pdf'), g3, dpi=450, units='in', width=8, height=6)


# Plot:
lab2df = rbind(head(cdf[cdf$im > 1,], 20),
               tail(cdf[cdf$om > 1,], 20))
smat = avgmat[lab2df$symbol,]
smat = log(smat + 1)
smat = t(scale(t(smat)))

ad.diff = ifelse(eid==1,'Depleted','No Change')
udsplit = ifelse(lab2df$cor > 0 ,'Up','Down')
ha = HeatmapAnnotation(AD.Diff=ad.diff, 
                       col=list(AD.Diff=c('Depleted'='slateblue',
                                          'No Change'='grey75')))

col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "indianred"))
# ha = HeatmapAnnotation(foo = 1:10, col = list(foo = col_fun))
hb = rowAnnotation(Cor=lab2df$cor,
                   col=list(Cor=col_fun))

if (use.norm){
    png(paste0(imgpref, 'EC_topcorr_heatmap_normalized.png'), res=400, units='in', width=8, height=10)
} else {
    png(paste0(imgpref, 'EC_topcorr_heatmap_unnormalized.png'), res=400, units='in', width=8, height=10)
}
Heatmap(smat, name='log counts', column_names_rot=45, 
        # col=viridis(100), 
        top_annotation=ha, column_split=ad.diff, 
        row_split=udsplit,
        right_annotation=hb)
dev.off()

# Plot heatmap by braak stage / nft:
lab2df = rbind(head(cdf[cdf$im > 1,], 50),
               tail(cdf[cdf$om > 1,], 20))
if (use.norm){
    smat = as.matrix(pmat[lab2df$symbol,])
} else {
    smat = as.matrix(apmat[lab2df$symbol,])
}

# Individual + CT annotations:
indmap = unique(metadata[,c('projid','cogdx','niareagansc', 'braaksc','nft_ec', 'nrad','cogdxad')])
rownames(indmap) = as.character(indmap$projid)
cn = colnames(pmat)
pids = sub("_.*","",cn)
pmeta = indmap[as.character(pids),]
cts = gsub("_"," ", sub(".*_Exc","Exc",cn))
ad.diff = ifelse(cts %in% topec[eid==1],'Depleted','No Change')
clsplit = paste0(pmeta$nrad, ", ", ad.diff)
ha = HeatmapAnnotation(AD.Diff=ad.diff, CT=cts, 
                       Braak=pmeta$braaksc,
                       NFT=pmeta$nft_ec,
                       AD=pmeta$niareagansc,
                       col=list(AD=colvals[['niareagansc']],
                                Braak=colvals[['braaksc']],
                                CT=type.cols[topec],
                                AD.Diff=c('Depleted'='slateblue',
                                          'No Change'='grey75')))


col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "indianred"))
udsplit = ifelse(lab2df$cor > 0 ,'Up','Down')
hb = rowAnnotation(Cor=lab2df$cor,
                   col=list(Cor=col_fun))

if (use.norm){
    png(paste0(imgpref, 'EC_topcorr_heatmap_normalized_individ.png'), res=400, units='in', width=11, height=12)
} else {
    png(paste0(imgpref, 'EC_topcorr_heatmap_unnormalized_individ.png'), res=400, units='in', width=11, height=12)
}
smat.scaled = t(scale(t(log(smat+1))))
Heatmap(smat.scaled, name='scaled\n logcounts', 
        top_annotation=ha, 
        column_split=clsplit, 
        show_column_names=FALSE,
        row_split=udsplit,
        right_annotation=hb)
dev.off()


# --------------------------------------------------------
# Plot the heparan sulfate associated genes in particular:
# --------------------------------------------------------
pathway='heparan_sulfate'
# pathway='inositol'
# pathway='oglycan_biosynthesis'
hsgenes = scan(paste0(pathway,'_genes.txt'),'c')
hsdf = read.delim(paste0(pathway, '_ECde.txt'), header=T)
# hsgenes = scan('inositol_genes.txt','c')
rownames(hsdf) = hsdf$symbol
# Plot heatmap by braak stage / nft:
kgenes = hsgenes[hsgenes %in% rownames(pmat)]
if (use.norm){
    smat = as.matrix(pmat[kgenes,])
} else {
    smat = as.matrix(apmat[kgenes,])
}
smat = smat[apply(smat,1,sum) != 0,]
kgenes = rownames(smat)

col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "indianred"))
udsplit = ifelse(hsdf[kgenes,'Est'] > 0 ,'Up','Down')
hb = rowAnnotation(Est=hsdf[kgenes,'Est'],
                   log10q=hsdf[kgenes,'log10q'],
                   Signif=ifelse(hsdf[kgenes,'padj'] < 0.001, 'Yes','No'),
                   col=list(Est=col_fun,
                            Signif=c('Yes'='goldenrod1','No'='white')))


if (use.norm){
    imgfile = paste0(imgpref, 'EC_',pathway,'_heatmap_normalized_individ')
} else {
    imgfile = paste0(imgpref, 'EC_',pathway,'_heatmap_unnormalized_individ')
}
png(paste0(imgfile,'.png'), res=400, units='in', width=12, height=10)
# pdf(paste0(imgfile,'.pdf'), width=12, height=10)
smat.scaled = t(scale(t(log(smat+1))))
Heatmap(smat.scaled, name='scaled\n logcounts', 
        top_annotation=ha, 
        column_split=clsplit, 
        row_split=udsplit,
        show_column_names=FALSE,
        right_annotation=hb
)
dev.off()

# -----------------------------------------------------------
# Create a regression score for the heparan sulfate gene set:
# -----------------------------------------------------------
sdf = data.frame(t(as.matrix(pmat[hsgenes,])))
cn = rownames(sdf)
cts = gsub("_"," ", sub(".*_Exc","Exc",cn))
sdf$celltype = cts
rdf = frac.regdf[frac.regdf$region == 'EC' & frac.regdf$reg == 'nrad',]
sdf = merge(sdf, rdf[,c('celltype','Est')])
sdf$celltype=NULL
hs.fit = lm(Est ~ ., sdf)
summary(hs.fit)
# HS6ST3 is most signif, followed by GPC5, SDC2/3/4, NDST3, and HS3ST3A1


# -----------------------------------------------
# Plot boxplots/violins of the genes of interest:
# -----------------------------------------------
pltgenes = c('HS6ST1','HS6ST2','HS6ST3','NDST1','NDST3','NDST4','EXTL1','EXTL2','GPC5','GPC6','SULF1', 'SULF2', 'INPP4B','SLC2A13')
sdf = data.frame(as.matrix(pmat[pltgenes,]))
sdf$symbol = rownames(sdf)
slong = gather(sdf, ptype, val, -symbol)
slong$ptype = sub("^X","", slong$ptype)
hdf = data.frame(ptype=cn,
                 ad=pmeta$niareagansc, ct=cts, 
                 ad.diff=ad.diff)
slong = merge(slong, hdf)

gplot = ggplot(slong, aes(ad.diff, log(val + 1), fill=ad.diff)) + 
    facet_wrap(~symbol, scales='free_y') + 
    scale_fill_manual(values=c('slateblue','grey85')) +
    geom_violin(alpha=.5) + 
    geom_boxplot(width=.25, outlier.shape=NA, alpha=.5) + 
    geom_jitter(cex=.25) + 
    # stat_compare_means() + 
    labs(x='Individuals x Subtypes depleted in AD or not', y='log(Expression + 1)') +
    theme_pubr() + theme(legend.position='none')

if (use.norm){
    imgfile = paste0(imgpref, 'EC_heparan_boxplots_normalized_individ')
} else {
    imgfile = paste0(imgpref, 'EC_heparan_boxplots_unnormalized_individ')
}
ggsave(paste0(imgfile, '.png'), gplot, dpi=450, units='in', width=8.5, height=7)
ggsave(paste0(imgfile, '.pdf'), gplot, dpi=450, units='in', width=8.5, height=7)


# ---------------------------------------------------------------------
# Differential gene expression on vulnerable + non-vulnerable subtypes:
# ---------------------------------------------------------------------
# Pseudo-bulk metadata:
smeta = submeta[submeta$cell_type_high_resolution %in% topec,] 
umeta = agg.rename(barcode ~ projid + cell_type_high_resolution + region, smeta, length, 'count')
umeta$ptype = with(umeta, paste0(projid, '_', gsub("/","_",gsub(" ","_", cell_type_high_resolution))))
umeta = merge(umeta, unique(metadata[,c('projid','region','braaksc','cogdx','niareagansc','msex','age_death','pmi', 'Apoe_e4', 'nrad','cogdxad')]))
umeta$age_rescaled = umeta$age_death / 100
rownames(umeta) = umeta$ptype
umeta$vuln = umeta$cell_type_high_resolution %in% topec[eid==1]
umeta = umeta[colnames(pmat),]
umeta = umeta[umeta$count > 10,] # Remove + will weight

# Filter by avg. expr:
ecut = 0.5
pmean = apply(pmat, 1, mean)
kept.genelist = names(pmean)[pmean > ecut]
avgidf = data.frame(symbol=names(pmean), val=pmean)

gene = 'PRNP'
est.ddf = c()
for (gene in kept.genelist){
    x = pmat[gene, umeta$ptype]
    umeta$val = x
    # Regression - general effects of covariates on expression:
    fit = glm(val ~ nrad + cell_type_high_resolution + Apoe_e4 + age_rescaled + msex + pmi, umeta,
              weights=log(umeta$count), family='gaussian') # Corrects for cell ct. but not inflated
    # Alt:
    cfit = coefficients(summary(fit))
    df = data.frame(cfit)
    colnames(df) = c('Est','SE','t','p')
    pval = df['nradAD','p']
    if (!is.na(pval)){
        if (pval < 1e-2){ cat(gene,'\t', sprintf('%0.2e',pval), '\n') }
    }
    df$var = rownames(df)
    rownames(df) = NULL
    df$symbol = gene
    est.ddf = rbind(est.ddf, df)
}


# Plot volcano of these assoc. with depletions:
adf = est.ddf[est.ddf$var == 'nradAD',]
adf = merge(adf, avgidf)
adf = adf[!is.na(adf$p),]
adf = adf[adf$val > 1.5,]
adf = adf[order(adf$p), ]
adf$padj = p.adjust(adf$p, 'fdr')
adf$log10q = -log10(adf$padj)
adf$Est[adf$Est > 1] = 1
adf$Est[adf$Est < -1] = -1

pcut = 1e-3
adf$color = 0
adf$color[adf$padj < pcut] = 1
adf$color[adf$padj < pcut & adf$Est > 0] = 2

labdf = rbind(head(adf[adf$color == 1,],15),
              head(adf[adf$color == 2,],10))

pcols = brewer.pal(12, 'Paired')
gplot = ggplot(adf, aes(Est, log10q, col=factor(color))) + 
    scale_color_manual(values=c('grey85',pcols[1],pcols[5])) + 
    geom_vline(xintercept=0, lwd=.25, lty='dashed') + 
    geom_point(cex=.25, alpha=1) + theme_pubr() + 
    geom_text_repel(data=labdf, aes(Est, log10q, label=symbol), max.overlaps=30, size=2, segment.size=.5) + 
    scale_y_continuous(expand=c(0,0)) + 
    labs(x='Coefficient * Average Expression') + 
    theme(legend.position = 'none')
w = 7; h=7
ggsave(paste0(imgpref, 'EC_nrad_subtypes_pseudobulk_ct_genes_',sub(" ", "_", st), '_volcano.png'), gplot, dpi=450, units='in', width=w, height=h)
ggsave(paste0(imgpref, 'EC_nrad_subtypes_pseudobulk_ct_genes_',sub(" ", "_", st), '_volcano.pdf'), gplot, dpi=450, units='in', width=w, height=h)





# --------------------------------------------------------------
# Load in all neuronal cell types to look at heparan metabolism:
# --------------------------------------------------------------
# Load in average tracks for each cell type, regardless of individual:
avg.file.rda = 'multiRegion/neuronal_average_profiles.Rda'
if (!file.exists(avg.file.rda)){
    avgdf = c()
    for (celltype in c('Exc','Inh')){
        fns = list.files(path=mtxdir, paste0(rawpref,'.majorcelltype.', celltype,'..*rda'))
        for (fn in fns[62:length(fns)]){
            rdafile = paste0(mtxdir, fn)
            basename = sub(".rda", "", sub(paste0(".*.majorcelltype.", celltype,'.'),"",fn))
            subtype = gsub("_"," ",sub("\\.[A-Z]*","",basename))
            region = sub(".*\\.","",basename)
            # Load data, normalize and average:
            load(rdafile)
            if (nrow(mat) != 1 && ncol(mat) > 0){
                print(paste("[STATUS] Loaded", subtype, 'in', 
                            region,'with',ncol(mat), 'cells'))
                barcodes = colnames(mat)
                genes = rownames(mat)
                # Normalize:
                amarg = marg[barcodes,'count']
                fact = amarg / 15000  # Rough median for all neurons
                mat@x <- mat@x / rep.int(fact, diff(mat@p))
                # gc()
                # Average:
                avg.profile = rowMeans(mat)
                df = data.frame(major.celltype=celltype,
                                celltype=subtype,
                                region=region,
                                ncell=ncol(mat),
                                symbol=names(avg.profile),
                                val=avg.profile)
                avgdf = rbind(avgdf, df)
                cat(subtype,'\t', region,'\t',avg.profile[c('HS6ST1','HS6ST2','HS6ST3','SLC2A13')],'\n')
                rm(mat)
                gc()
            }
        }
    }
    # Also spread the matrix:
    genelist = unique(avgdf$symbol)
    avgdf$celltype = sub("L5 6 NP","L5/6 NP",avgdf$celltype)
    avgdf$celltype = sub("L5 6 IT","L5/6 IT",avgdf$celltype)
    avgwide = spread(avgdf, symbol, val)
    save(avgdf, avgwide, genelist, file=avg.file.rda)
} else {
    load(avg.file.rda)
}


# -----------------------------------------------------------------
# Plot subtype profiles in the heparan sulfate + inositol pathways:
# -----------------------------------------------------------------
# Heparan
# Inositol
# Differential (Re-run difftl...)
stmat = as.matrix(avgwide[,genelist])
pathway='heparan_sulfate'
# pathway='inositol'
hsgenes = scan(paste0(pathway,'_genes.txt'),'c')
hsdf = read.delim(paste0(pathway, '_ECde.txt'), header=T)
rownames(hsdf) = hsdf$symbol
# Plot heatmap by braak stage / nft:
kgenes = hsgenes[hsgenes %in% genelist]
smat = t(stmat[,kgenes])
smat = smat[apply(smat,1,sum) != 0,]
kgenes = rownames(smat)

colnames(smat) = paste0(avgwide$celltype, '; ', avgwide$region)

# Region + CT annotations:
ha = HeatmapAnnotation(Major=avgwide$major.celltype,
                       CT=avgwide$celltype, 
                       Region=avgwide$region,
                       col=list(Region=reg.cols,
                                CT=type.cols,
                                Major=c('Exc'='slateblue',
                                        'Inh'='grey75')))

# Gene annotations:
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "white", "indianred"))
udsplit = ifelse(hsdf[kgenes,'Est'] > 0 ,'Up','Down')
hb = rowAnnotation(Est=hsdf[kgenes,'Est'],
                   log10q=hsdf[kgenes,'log10q'],
                   Signif=ifelse(hsdf[kgenes,'padj'] < 0.001, 'Yes','No'),
                   col=list(Est=col_fun,
                            Signif=c('Yes'='goldenrod1','No'='white')))

imgfile = paste0(imgpref, 'ECdriven_allsubtypes_',pathway,'_heatmap_normalized')
png(paste0(imgfile, '.png'), res=400, units='in', width=25, height=10)
smat.scaled = t(scale(t(log(smat+1))))
Heatmap(smat.scaled, name='scaled\n logcounts', 
        top_annotation=ha, 
        column_split=avgwide$major.celltype, 
        show_column_names=TRUE,
        column_names_gp = gpar(fontsize=7),
        row_split=udsplit,
        right_annotation=hb)
dev.off()

sdf = avgdf[avgdf$region == 'TH' & avgdf$symbol == 'HS6ST3',]
sdf = sdf[sdf$ncell > 100,]


# --------------------------------
# Plot genes against coefficients:
# --------------------------------
regset = 'nrad'
# regset = 'nrad.rel'
# regset = 'cogdxad'
rdf = frac.regdf[frac.regdf$reg == regset,]
if (regset == 'nrad'){
    ecut = 0.0075
} else if (regset == 'cogdxad.rel'){
    ecut = 0.01
} else if (regset == 'cogdxad'){
    ecut = 0.01
} else { 
    ecut = 0.0005
}

mfracdf = aggregate(cbind(count, total) ~ region + celltype, ctdf, sum)
mfracdf$frac = mfracdf$count / mfracdf$total

ecdriven=FALSE
if (ecdriven){
    genes = c('HS6ST1','HS6ST2','HS6ST3', 'SULF1', 'SULF2', 'GPC5') # Heparan + EC
} else {
    genes = c('HS6ST3','TRPS1','CDH20', 'MAN1A1','SGCD','OXR1', 'PIK3CB', 'HS6ST2') # Discovered across all
    # genes = c('HS6ST3','MAN1A1','SPOCK3', 'FILIP1L') # Discovered across all
}
subdf = avgdf[avgdf$symbol %in% genes,]
subdf = merge(subdf, rdf)
subdf = merge(subdf, mfracdf[,c('region','celltype','frac')])
subdf = subdf[subdf$frac > 0.005,] # Can include/ or not - removes noisy estimates
subdf = subdf[subdf$major.celltype == 'Exc',]
subdf = subdf[subdf$celltype != 'Exc SV2C LINC02137',]

# Add p-values, fit lines:
# regs = c('PFC','AG','MT')
regs = c('EC','HC','TH')
# regs = names(reg.cols)
if (length(grep('rel', regset)) ==  0){ subdf$rel.Est = subdf$Est / subdf$frac } else { subdf$rel.Est = subdf$Est }

lmdf = c()
for (gene in genes){
    sdf = subdf[subdf$symbol == gene & subdf$region %in% regs,]
    fit = lm(Est ~ val,sdf)
    cfit = coefficients(summary(fit))
    df = data.frame(cfit['val',c(1,4), drop=F])
    names(df) = c('lm.est','p')
    df$intercept = cfit['(Intercept)',1]
    df$symbol = gene
    lmdf = rbind(lmdf,df)
}
lmdf$eqn = sprintf("y = %0.2f%% - %0.2f%% * Expression\np = %0.3f",
                   round(lmdf$intercept * 100,2),
                   round(lmdf$lm.est * -100,2), round(lmdf$p,3))

labdf = subdf[abs(subdf$Est) > ecut | subdf$val > 30,]
gplot = ggplot(subdf[subdf$region %in% regs,], aes(val, Est, color=region, size=ncell)) +
    facet_wrap(~symbol, scale='free_x') +
    geom_hline(yintercept=0,lwd=.25, lty='dashed') + 
    geom_smooth(method='lm', color='black') + 
    geom_point() + 
    geom_text_repel(data=labdf[labdf$region %in% regs,], aes(val, Est, label=paste0(celltype, '; ', region)), max.overlaps=30, size=3) + 
    geom_text(data=lmdf, aes(x=1,y=-.02, label=eqn), size=3, color='black') + 
    scale_color_manual(values=reg.cols) + 
    scale_y_continuous(label=scales::percent)+
    labs(x='Average Expression Level (Normalized)', y='Absolute change vs. all cells') +
    theme_pubr()

if (ecdriven){
    ggsave(paste0(imgpref, 'ECdriven_allsubtypes_est_expr_scatter_comparison_',regset,'.png'), gplot, dpi=450, units='in', width=15, height=10)
    ggsave(paste0(imgpref, 'ECdriven_allsubtypes_est_expr_scatter_comparison_',regset,'.pdf'), gplot, dpi=450, units='in', width=15, height=10)
} else {
    ggsave(paste0(imgpref, 'fromall4_allsubtypes_est_expr_scatter_comparison_',regset,'.png'), gplot, dpi=450, units='in', width=7, height=7)
    ggsave(paste0(imgpref, 'fromall4_allsubtypes_est_expr_scatter_comparison_',regset,'.pdf'), gplot, dpi=450, units='in', width=7, height=7)
}


    # ----------------------------------------------------------------
    # Perform an EC/HC/TH screen for the best predictors of depletion:
    # ----------------------------------------------------------------
    # Load in all neuronal cell types in these regions, by individual:
    indavg.file.rda = 'multiRegion/neuronal_exc_ECHCTH_ind_average_profiles.Rda'
    rownames(cellmeta) = cellmeta$barcode
    if (!file.exists(indavg.file.rda)){
        celltype = 'Exc'
        fns = c(list.files(path=mtxdir, paste0(rawpref,'.majorcelltype.', celltype,'..*.EC.rda')),
                list.files(path=mtxdir, paste0(rawpref,'.majorcelltype.', celltype,'..*.HC.rda')),
                list.files(path=mtxdir, paste0(rawpref,'.majorcelltype.', celltype,'..*.TH.rda')))
        indavgdf = c()
        for (fn in fns[1:length(fns)]){
            rdafile = paste0(mtxdir, fn)
            basename = sub(".rda", "", sub(paste0(".*.majorcelltype.", celltype,'.'),"",fn))
            subtype = gsub("_"," ",sub("\\.[A-Z]*","",basename))
            region = sub(".*\\.","",basename)
            # Load data, normalize and average:
            load(rdafile)
            if (nrow(mat) != 1 && ncol(mat) > 0){
                cat(paste("[STATUS] Loaded", subtype, 'in', region,'with',ncol(mat), 'cells\n'))
                barcodes = colnames(mat)
                genes = rownames(mat)
                # Normalize:
                amarg = marg[barcodes,'count']
                fact = amarg / 15000  # Rough median for all neurons
                mat@x <- mat@x / rep.int(fact, diff(mat@p))
                pid = cellmeta[barcodes,'projid']
                # Average across individuals:
                tform = make.tform(as.character(pid), norm=TRUE)
                pid.mat = mat %*% tform
                df = data.frame(as.matrix(pid.mat))
                colnames(df) = sub("^X","", colnames(df))
                df$symbol = rownames(pid.mat)
                df = gather(df, projid, val,-symbol)
                df$celltype = subtype 
                df$region = region
                # df$major.celltype = celltype
                # df$ncell=ncol(mat),
                indavgdf = rbind(indavgdf, df)
                rm(mat, df, pid.mat, tform)
                gc()
            }
        }

        # Also spread the matrix:
        genelist = unique(indavgdf$symbol)
        indavgdf$celltype = sub("L5 6 NP","L5/6 NP",indavgdf$celltype)
        indavgdf$celltype = sub("L5 6 IT","L5/6 IT",indavgdf$celltype)
        indavgwide = spread(indavgdf, symbol, val)
        save(indavgdf, indavgwide, genelist, file=indavg.file.rda)
    } else {
        load(indavg.file.rda)
    }
    rm(indavgwide); gc()

    # For filtering genes:
    avgidf = aggregate(val ~ symbol, indavgdf, mean)

    # ---------------------------------------------
    # Merge with the estimates; perform regression:
    # ---------------------------------------------
    # For weighted regression:
    ptdf = agg.rename(barcode ~ cell_type_high_resolution + projid + region, cellmeta, length, 'count')
    names(ptdf)[1] = 'celltype'

    # Faster indexing:
    rdf$cr = paste0(rdf$celltype, '_',rdf$region)
    ptdf$pcr = paste0(ptdf$projid,'_',ptdf$celltype, '_',ptdf$region)
    rownames(rdf) = rdf$cr
    rownames(ptdf) = ptdf$pcr
    rownames(pqdf) = pqdf$rind

    # gene = 'HS6ST3'
    ecut = 0.5
    kept.genelist = avgidf[avgidf$val > ecut, 'symbol']
    est.regfile.rda = 'multiRegion/gene_fraction_reg_association_table.Rda'
    if (!file.exists(est.regfile.rda)){
        est.regdf = c()
        est.expdf = c()
        # How many cells:
        NGENE = length(genelist) # Full genelist, for use in indexing.
        for (gene in kept.genelist){ 
            # Subset to gene:
            gidx = which(genelist == gene)
            gind = ((1:1953) -1) * NGENE + gidx
            subdf = indavgdf[gind,]
            gene = unique(subdf$symbol)
            # Add info:
            subdf$cr = paste0(subdf$celltype, '_',subdf$region)
            subdf$pcr = paste0(subdf$projid,'_',subdf$celltype, '_',subdf$region)
            subdf$pr = paste0(subdf$projid,'_',subdf$region)
            subdf$Est = rdf[subdf$cr, 'Est']
            subdf$count = ptdf[subdf$pcr, 'count']
            # Add attributes:
            nrmeta = unique(ctdf[,c('rind','projid','region','nrad','cogdxad','nft_ec','plaq_n_ec', 'Apoe_e4','msex','pmi','age_death')])
            rownames(nrmeta) = paste0(nrmeta$projid,"_",nrmeta$region)
            subdf$nrad = nrmeta[as.character(subdf$pr),'nrad']
            subdf$nft_ec = nrmeta[as.character(subdf$pr),'nft_ec'] # NOTE: EC NFT proxy for others
            subdf$cogdxad = nrmeta[as.character(subdf$pr),'cogdxad']
            subdf$pmi = nrmeta[as.character(subdf$pr),'pmi']
            subdf$age_rescaled = nrmeta[as.character(subdf$pr),'age_death'] / 100
            subdf$msex = nrmeta[as.character(subdf$pr),'msex']
            subdf$Apoe_e4 = nrmeta[as.character(subdf$pr),'Apoe_e4']
            subdf$rind = nrmeta[as.character(subdf$pr),'rind']
            subdf$nft = pqdf[as.character(subdf$rind),'nft']
            subdf$nft[is.na(subdf$nft)] = subdf$nft_ec[is.na(subdf$nft)] # Proxy for TH
            # subdf$plaq_n = pqdf[as.character(subdf$rind),'plaq_n']
            # Remove very small counts:
            subdf = subdf[subdf$count > 10,]

            # Regression - effect of expression on depletion:
            fit = glm(Est ~ val * nrad + Apoe_e4 + age_rescaled + msex + pmi, subdf, 
                      weights=log(subdf$count), family='gaussian') # Corrects for cell ct. but not inflated
                      # weights=sqrt(subdf$count), family='gaussian') # Corrects for cell ct., still oddly inflated
                      # weights=subdf$count, family='gaussian') # Way inflated
            # Regression - general effects of covariates on expression:
            fit2 = glm(val ~ nft * Est + celltype + Apoe_e4 + age_rescaled + msex + pmi, subdf, 
                      weights=log(subdf$count), family='gaussian') # Corrects for cell ct. but not inflated
            cfit = coefficients(summary(fit))
            cfit2 = coefficients(summary(fit2))
            df = data.frame(cfit)
            df2 = data.frame(cfit2)
            colnames(df) = c('Est','SE','t','p')
            colnames(df2) = c('Est','SE','t','p')
            pval = df['val','p']
            if (!is.na(pval)){
                if (pval < 1e-4){ cat(gene,'\t', sprintf('%0.2e',pval), '\n') }
            }
            df$var = rownames(df)
            df2$var = rownames(df2)
            rownames(df) = NULL
            rownames(df2) = NULL
            df$symbol = gene
            df2$symbol = gene
            est.regdf = rbind(est.regdf, df)
            est.expdf = rbind(est.expdf, df2)
        }
        save(est.regdf, est.expdf, file=est.regfile.rda)
    } else { 
        load(est.regfile.rda)
    }

    est.regdf[est.regdf$symbol == 'OXR1',]
    # genes = c('SGCD','SGCE','SGCZ','SGCG','DMD','ANO5', 'DYSF') # SGCE perturbed in other direction
    # genes = c('WNT3A','DKK1','LRP6','CTNNB1','LRP5') # WNT assoc.
    # est.regdf[est.regdf$symbol %in% genes & est.regdf$var == 'val',]

    # Plot volcano of these assoc. with depletions:
    adf = est.regdf[est.regdf$var == 'val',]
    adf = merge(adf, avgidf)
    adf = adf[!is.na(adf$p),]
    adf = adf[adf$val > 1.5,]
    adf = adf[order(adf$p), ]
    adf$padj = p.adjust(adf$p, 'fdr')
    adf$log10q = -log10(adf$padj)
    pcut = 1e-3
    adf$color = 0
    adf$color[adf$padj < pcut] = 1
    adf$color[adf$padj < pcut & adf$Est > 0] = 2

    labdf = rbind(head(adf[adf$color == 1,],15),
                  head(adf[adf$color == 2,],10))
    # cat(head(adf[adf$color == 1,'symbol'],50)) # GO enrichment turns up nothing of note
    # adf[adf$symbol == 'HS6ST3',]

    # adf[adf$symbol == 'MTERF1',]
    # adf[adf$Est == min(adf$Est),]

    tcols = brewer.pal(12, 'Paired')
    gplot = ggplot(adf, aes(Est * val, log10q, col=factor(color))) + 
        scale_color_manual(values=c('grey85',tcols[1],tcols[5])) + 
        geom_vline(xintercept=0, lwd=.25, lty='dashed') + 
        geom_point(cex=.25, alpha=1) + theme_pubr() + 
        geom_text_repel(data=labdf, aes(Est * val, log10q, label=symbol), max.overlaps=30, size=2, segment.size=.5) + 
        scale_y_continuous(expand=c(0,0)) + 
        labs(x='Coefficient * Average Expression') + 
        theme(legend.position = 'none')
    w = 7; h=7
    ggsave(paste0(imgpref, 'ECHCTH_exc_subtypes_ind_pseudobulk_vuln_genes_volcano.png'), gplot, dpi=450, units='in', width=w, height=h)
    ggsave(paste0(imgpref, 'ECHCTH_exc_subtypes_ind_pseudobulk_vuln_genes_volcano.pdf'), gplot, dpi=450, units='in', width=w, height=h)

# ---------------------------------------------------------------
# Plot the effect on expression from AD/non-AD for the top genes:
# ---------------------------------------------------------------
unique(est.expdf$var)
est.expdf[est.expdf$symbol == 'SYT1',c('var','p','Est')]

# vars = paste0("nradAD:celltype",topec[eid == 1])
vars = c('nft', 'Est','age_rescaled','msex','pmi','nft:Est')
edf = est.expdf[est.expdf$var == 'nft',]
# vars = 'age_rescaled'
# edf = est.expdf[est.expdf$var %in% vars,]
edf = merge(edf, avgidf)
edf = edf[!is.na(edf$p),]
edf = edf[edf$val > 1.5,]
edf = edf[order(edf$p), ]

head(edf[edf$Est > 0,], 20)

dgenes = head(adf$symbol,50)
dwdf = edf[edf$symbol %in% dgenes,]

head(dwdf[dwdf$Est > 0,], 20)

# Add in the nrad effect:
ndf = est.expdf[est.expdf$var == 'nradAD',c('Est','p','symbol')]
names(ndf)[1:2] = c('nrad.est', 'nrad.p')

adf = merge(adf, ndf)
adf$Est2 = adf$Est + adf$nrad.est

adf = adf[order(adf$Est2, decreasing=F), ]
head(adf[,c('symbol','Est2','p','nrad.p')], 50)

adf[adf$symbol == 'HS6ST3',]


adf$padj = p.adjust(adf$p, 'fdr')
adf$log10q = -log10(adf$padj)
pcut = 1e-3
adf$color = 0
adf$color[adf$padj < pcut] = 1
adf$color[adf$padj < pcut & adf$Est > 0] = 2

# -------------------------------------
# Plot some of these genes as boxplots:
# -------------------------------------
subdf = indavgdf[indavgdf$symbol %in% c('LRP1B','MT-ND3','NRXN3','HS6ST3','CDH20'),]
subdf = merge(subdf, rdf[,c('Est','region','celltype')])
subdf = merge(subdf, ptdf)
subdf = merge(subdf, mfracdf[,c('region','celltype','frac')])
nrmeta = unique(ctdf[,c('projid','nrad','cogdxad','nft_ec','plaq_n_ec', 'Apoe_e4','msex','pmi','age_death')])
rownames(nrmeta) = nrmeta$projid
subdf$nrad = nrmeta[as.character(subdf$projid),'nrad']
subdf$nft_ec = nrmeta[as.character(subdf$projid),'nft_ec']
subdf$cogdxad = nrmeta[as.character(subdf$projid),'cogdxad']
subdf$pmi = nrmeta[as.character(subdf$projid),'pmi']
subdf$age_rescaled = nrmeta[as.character(subdf$projid),'age_death'] / 100
subdf$msex = nrmeta[as.character(subdf$projid),'msex']
subdf$Apoe_e4 = nrmeta[as.character(subdf$projid),'Apoe_e4']
# Remove very small counts:
subdf = subdf[subdf$count > 10,]

gplot = ggplot(subdf[subdf$celltype %in% topec & subdf$region == 'EC',], aes(nft_ec, val, size=count)) +
    facet_grid(symbol~celltype, scale='free_y') +
    geom_point() + 
    geom_smooth(method='lm') + 
    scale_color_manual(values=colvals[['nrad']]) + 
    scale_y_continuous(expand=c(0,1))+
    theme_pubr() + 
    theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))


# -------------------------------------------------------
# Plot all the pseudobulk samples (+ split by AD/non-AD):
# -------------------------------------------------------
regset = 'nrad'
rdf = frac.regdf[frac.regdf$reg == regset,]
if (regset == 'nrad'){
    ecut = 0.0075
} else if (regset == 'cogdxad.rel'){
    ecut = 0.01
} else if (regset == 'cogdxad'){
    ecut = 0.01
} else { 
    ecut = 0.0005
}

mfracdf = aggregate(cbind(count, total) ~ region + celltype, ctdf, sum)
mfracdf$frac = mfracdf$count / mfracdf$total

ecdriven=FALSE
if (ecdriven){
    genes = c('HS6ST1','HS6ST2','HS6ST3', 'SULF1', 'SULF2', 'GPC5') # Heparan + EC
} else {
    genes = c('HS6ST3','TRPS1','CDH20', 'MAN1A1','SGCD','OXR1') # Discovered across all
    # genes = c('HS6ST3','MAN1A1','SPOCK3', 'FILIP1L') # Discovered across all
}
subdf = indavgdf[indavgdf$symbol %in% genes,]
subdf = merge(subdf, rdf[,c('Est','region','celltype')])
subdf = merge(subdf, ptdf)
subdf = merge(subdf, mfracdf[,c('region','celltype','frac')])
nrmeta = unique(ctdf[,c('projid','nrad','cogdxad','nft_ec','plaq_n_ec', 'Apoe_e4','msex','pmi','age_death')])
rownames(nrmeta) = nrmeta$projid
subdf$nrad = nrmeta[as.character(subdf$projid),'nrad']
subdf$nft_ec = nrmeta[as.character(subdf$projid),'nft_ec']
subdf$cogdxad = nrmeta[as.character(subdf$projid),'cogdxad']
subdf$pmi = nrmeta[as.character(subdf$projid),'pmi']
subdf$age_rescaled = nrmeta[as.character(subdf$projid),'age_death'] / 100
subdf$msex = nrmeta[as.character(subdf$projid),'msex']
subdf$Apoe_e4 = nrmeta[as.character(subdf$projid),'Apoe_e4']
# Remove very small counts:
subdf = subdf[subdf$count > 10,]


# subdf = subdf[subdf$frac > 0.005,] # Can include/ or not - removes noisy estimates
# subdf = subdf[subdf$major.celltype == 'Exc',]
# subdf = subdf[subdf$celltype != 'Exc SV2C LINC02137',]

# subdf = indavgdf[indavgdf$symbol %in% genes,]
# # Add info:

# Add p-values, fit lines:
# regs = c('PFC','AG','MT')
regs = c('EC','HC','TH')
# regs = names(reg.cols)
if (length(grep('rel', regset)) ==  0){ subdf$rel.Est = subdf$Est / subdf$frac } else { subdf$rel.Est = subdf$Est }

# lmdf = c()
# for (gene in genes){
#     sdf = subdf[subdf$symbol == gene & subdf$region %in% regs,]
#     fit = lm(Est ~ val,sdf)
#     cfit = coefficients(summary(fit))
#     df = data.frame(cfit['val',c(1,4), drop=F])
#     names(df) = c('lm.est','p')
#     df$intercept = cfit['(Intercept)',1]
#     df$symbol = gene
#     lmdf = rbind(lmdf,df)
# }
# lmdf$eqn = sprintf("y = %0.2f%% - %0.2f%% * Expression\np = %0.3f",
#                    round(lmdf$intercept * 100,2),
#                    round(lmdf$lm.est * -100,2), round(lmdf$p,3))

labdf = subdf[abs(subdf$Est) > ecut | subdf$val > 30,]
gplot = ggplot(subdf[subdf$region %in% regs,], aes(val, Est, color=region, size=count)) +
    facet_wrap(~symbol, scale='free_x') +
    geom_hline(yintercept=0,lwd=.25, lty='dashed') + 
    geom_smooth(method='lm', color='black') + 
    geom_point() + 
    # geom_text_repel(data=labdf[labdf$region %in% regs,], aes(val, Est, label=paste0(celltype, '; ', region)), max.overlaps=30, size=3) + 
    # geom_text(data=lmdf, aes(x=1,y=-.02, label=eqn), size=3, color='black') + 
    scale_color_manual(values=reg.cols) + 
    scale_y_continuous(label=scales::percent)+
    labs(x='Average Expression Level (Normalized)', y='Absolute change vs. all cells') +
    theme_pubr()



labdf = subdf[abs(subdf$Est) > ecut | subdf$val > 30,]
gplot = ggplot(subdf[subdf$region %in% regs,], aes(val, Est, color=region, size=count, fill=nrad)) +
    facet_wrap(~symbol, scale='free_x') +
    geom_hline(yintercept=0,lwd=.25, lty='dashed') + 
    geom_smooth(method='lm', color='black') + 
    geom_point(pch=22) + 
    # geom_text_repel(data=labdf[labdf$region %in% regs,], aes(val, Est, label=paste0(celltype, '; ', region)), max.overlaps=30, size=3) + 
    # geom_text(data=lmdf, aes(x=1,y=-.02, label=eqn), size=3, color='black') + 
    scale_color_manual(values=reg.cols) + 
    scale_y_continuous(label=scales::percent)+
    labs(x='Average Expression Level (Normalized)', y='Absolute change vs. all cells') +
    theme_pubr()


# Ask if these genes have difftl expr in AD/CTRL:
dedf = c()
for (gene in genes){
    sdf = subdf[subdf$symbol == gene,]
    fit = glm(val ~ nrad + Apoe_e4 + age_rescaled + msex + pmi + celltype, sdf, 
              weights=log(sdf$count), family='gaussian') # Corrects for cell ct. but not inflated
    cfit = data.frame(coefficients(summary(fit)))
    colnames(cfit) = c('Est','SE','t','p')
    cfit$symbol = gene
    cfit$var = rownames(cfit)
    rownames(cfit) = NULL
    dedf = rbind(dedf, cfit)
}

dedf[dedf$var == 'nradAD',]
dedf[dedf$var == 'age_rescaled',]



















# Plot these genes as well:
genes = labdf$symbol
subdf = avgdf[avgdf$symbol %in% genes,]
subdf = merge(subdf, rdf)
# subdf = subdf[subdf$celltype != 'Exc L2-3 CBLN2 LINC02306',] # Removing this completely = better signal tbh..
labdf = subdf[abs(subdf$Est) > ecut | subdf$val > 40,]

gplot = ggplot(subdf, aes(val, Est, color=region, size=ncell)) +
    facet_wrap(~symbol, scale='free_x') +
    geom_hline(yintercept=0,lwd=.25, lty='dashed') + 
    geom_smooth(method='lm', color='black') + 
    geom_point() + 
    geom_text_repel(data=labdf, aes(val, Est, label=paste0(celltype, '; ', region)), max.overlaps=30, size=3) + 
    scale_color_manual(values=reg.cols) + 
    theme_pubr()

ggsave(paste0(imgpref, 'fromall_allsubtypes_est_expr_scatter_comparison.png'), gplot, dpi=450, units='in', width=15, height=10)
ggsave(paste0(imgpref, 'fromall_allsubtypes_est_expr_scatter_comparison.pdf'), gplot, dpi=450, units='in', width=15, height=10)


# ----------------------------------------------------------
# Plot a score computed from the heparan sulfate regression:
# ----------------------------------------------------------
hsmat = avgwide[,c('celltype','region','ncell','major.celltype',hsgenes)]
hsmat$pred = predict(hs.fit, hsmat)
subdf = merge(hsmat[,c('celltype','region','ncell','major.celltype','pred')], rdf, all.x=TRUE)
subdf = merge(subdf, mfracdf[mfracdf$nrad == 'CTRL',])
subdf = subdf[subdf$frac > 0.005,]
# subdf = subdf[subdf$celltype != 'Exc L2-3 CBLN2 LINC02306',] # Removing this completely = better signal tbh..
subdf = subdf[!is.na(subdf$Est),]
labdf = subdf[abs(subdf$Est) > ecut | abs(subdf$pred) > ecut,]

gplot = ggplot(subdf, aes(pred, Est, color=region, size=ncell)) +
    facet_wrap(~major.celltype) + 
    geom_hline(yintercept=0,lwd=.25, lty='dashed') + 
    geom_smooth(method='lm', color='black') + 
    geom_point() + 
    geom_text_repel(data=labdf, aes(pred, Est, label=paste0(celltype, '; ', region)), max.overlaps=30, size=3) + 
    labs(x='Predicted absolute decrease', y='Actual absolute decrease') + 
    scale_color_manual(values=reg.cols) + 
    theme_pubr()

ggsave(paste0(imgpref, 'ECheparanscore_allsubtypes_est_expr_scatter_comparison.png'), gplot, dpi=450, units='in', width=12, height=7)
ggsave(paste0(imgpref, 'ECheparanscore_allsubtypes_est_expr_scatter_comparison.pdf'), gplot, dpi=450, units='in', width=12, height=7)


# --------------------------------------------------------------------------
# UMAP plots of the EC neurons only; colored by vulnerability and HS markers
# --------------------------------------------------------------------------
# TODO: Make separate UMAP for the EC neurons only?
submeta = cellmeta[cellmeta$cell_type_high_resolution %in% topec & cellmeta$region %in% 'EC',]
xr = range(submeta$U1)
yr = range(submeta$U2)
yr = c(-4,9)
xr = c(15,25)
dx = diff(xr)
dy = diff(yr)
dd = max(c(dx, dy)) / 2
xr = c(mean(xr) - dd, mean(xr) + dd)
yr = c(mean(yr) - dd, mean(yr) + dd)
submeta = cellmeta[cellmeta$U1 <= xr[2] & cellmeta$U1 >= xr[1],]
submeta = submeta[submeta$U2 <= yr[2] & submeta$U2 >= yr[1],]
submeta$celltype = as.character(submeta$cell_type_high_resolution)
submeta$celltype[!(submeta$celltype %in% topec)] = 'None'
submeta$celltype[submeta$region != 'EC'] = 'None'
submeta = merge(submeta, unique(metadata[c('projid','nrad')]))

# Shuffle points for plotting:
ind = 1:nrow(submeta)
ad.ind = which(submeta$nrad == 'AD')
ctrl.ind = which(submeta$nrad == 'CTRL')
full.ind = sample(ind, length(ind), replace=FALSE)
ad.ind = sample(ad.ind, length(ad.ind), replace=FALSE)
ctrl.ind = sample(ctrl.ind, length(ctrl.ind), replace=FALSE)

# Labels + colors:
tcols = c('None'='grey97',type.cols[topec])
labdf = aggregate(cbind(U1, U2) ~ cell_type_high_resolution, submeta, mean)
labdf$celltype = labdf$cell_type_high_resolution
labdf$celltype[!(labdf$celltype %in% topec)] = 'None'
labdf = labdf[labdf$celltype != 'None',]

w = 6
cex = 0.02
sp = 0.1
png(paste0(imgpref, 'EC_vuln_neurons_umap.png'), units='in', res=450, width=w, height=w)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(submeta$U1[full.ind], submeta$U2[full.ind], 
     col=tcols[submeta$celltype[full.ind]], pch=19, cex=cex, axes=F)
text(labdf$U1, labdf$U2, labdf$cell_type_high_resolution, font=2, cex=.8,
     col=ifelse(labdf$celltype == 'None', 'grey75','black'), xpd=TRUE)
mtext('UMAP 1', side=1, line=-1, cex=1.25)
mtext('UMAP 2', side=2, line=-1, cex=1.25)
dev.off()

png(paste0(imgpref, 'EC_vuln_neurons_umap_AD.png'), units='in', res=450, width=w, height=w)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(submeta$U1[ad.ind], submeta$U2[ad.ind], 
     col=tcols[submeta$celltype[ad.ind]],
     pch=19, cex=cex, axes=F)
text(labdf$U1, labdf$U2, labdf$cell_type_high_resolution, font=2, cex=.8,
     col=ifelse(labdf$celltype == 'None', 'grey75','black'), xpd=TRUE)
mtext('UMAP 1', side=1, line=-1, cex=1.25)
mtext('UMAP 2', side=2, line=-1, cex=1.25)
mtext('AD Individuals', side=3, line=-1.5, cex=1.5)
dev.off()

png(paste0(imgpref, 'EC_vuln_neurons_umap_CTRL.png'), units='in', res=450, width=w, height=w)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(submeta$U1[ctrl.ind], submeta$U2[ctrl.ind], 
     col=tcols[submeta$celltype[ctrl.ind]],
     pch=19, cex=cex, axes=F)
text(labdf$U1, labdf$U2, labdf$cell_type_high_resolution, font=2, cex=.8,
     col=ifelse(labdf$celltype == 'None', 'grey75','black'), xpd=TRUE)
mtext('UMAP 1', side=1, line=-1, cex=1.25)
mtext('UMAP 2', side=2, line=-1, cex=1.25)
mtext('Non-AD Individuals', side=3, line=-1.5, cex=1.5)
dev.off()

# -------------------------------
# Plot UMAP with gene expression:
# -------------------------------
palette = c('grey90',viridis(100))
col_fun = function(x, pal=palette){
    bin <- cut(x, seq(0, max(x), length.out=length(palette)), include.lowest=T) 
    palette[bin] 
}

# genes = c('HS6ST3','TRPS1','CDH20', 'MTERF1') # Discovered across all
# for (gene in genes){

gene = 'HS6ST3'
x = rep(0, nrow(submeta))
bind = which(submeta$barcode %in% colnames(nmat))
x[bind] = log(nmat[gene,submeta$barcode[bind]] + 1)

cex = 0.02
w = 6
png(paste0(imgpref, 'EC_vuln_neurons_umap_',gene,'.png'), units='in', res=450, width=w, height=w)
par(xaxs='i')
par(yaxs='i')
sp = 0.1
bsp = 1.5
par(mar=c(sp,sp,sp, sp))
plot(submeta$U1[full.ind], submeta$U2[full.ind], 
     col=col_fun(x[full.ind]),
     pch=19, cex=cex, axes=F)
text(labdf$U1, labdf$U2, labdf$cell_type_high_resolution, font=2, cex=.8,
     col=ifelse(labdf$celltype == 'None', 'grey75','black'), xpd=TRUE)
mtext('UMAP 1', side=1, line=-1, cex=1.25)
mtext('UMAP 2', side=2, line=-1, cex=1.25)
mtext(gene, side=3, font=2, line=-1.5, cex=1.5)
dev.off()

# All four jointly:

cex = 0.01
w = 6
png(paste0(imgpref, 'EC_vuln_neurons_umap_',gene,'_2x2.png'), units='in', res=450, width=w, height=w)
par(xaxs='i', yaxs='i')
layout(matrix(1:4, nrow=2))
par(mar=rep(0,4))
plot(submeta$U1[full.ind], submeta$U2[full.ind], 
     col=tcols[submeta$celltype[full.ind]], pch=19, cex=cex, axes=F)
text(labdf$U1, labdf$U2, labdf$cell_type_high_resolution, font=2, cex=.6,
     col=ifelse(labdf$celltype == 'None', 'grey75','black'), xpd=TRUE)
mtext('UMAP 1', side=1, line=-1, cex=.8)
mtext('UMAP 2', side=2, line=-1, cex=.8)
mtext('All Individuals', side=3, line=-1.25, cex=1)
box(lwd=.5)
# Gene:
plot(submeta$U1[full.ind], submeta$U2[full.ind], 
     col=col_fun(x[full.ind]),
     pch=19, cex=cex, axes=F)
mtext(gene, side=3, line=-1.25, cex=1)
box(lwd=.5)
# AD:
plot(submeta$U1[ad.ind], submeta$U2[ad.ind], 
     col=tcols[submeta$celltype[ad.ind]],
     pch=19, cex=cex, axes=F)
mtext('AD Individuals', side=3, line=-1.25, cex=1)
box(lwd=.5)
# CTRL
plot(submeta$U1[ctrl.ind], submeta$U2[ctrl.ind], 
     col=tcols[submeta$celltype[ctrl.ind]],
     pch=19, cex=cex, axes=F)
mtext('Non-AD Individuals', side=3, line=-1.25, cex=1)
box(lwd=.5)
dev.off()


