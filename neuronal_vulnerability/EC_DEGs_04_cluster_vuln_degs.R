#!/usr/bin/R
# -------------------------------------------------------------
# Cluster the DEGs consistently up/down in vulnerable subtypes:
# Plot the DEGs as volcano plots + their GO enrichments
# Updated: 12/06/2021
# -------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)
library(ggrastr)

library(gprofiler2)

library(ComplexHeatmap)
library(circlize)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load everything (including full matrix dataset):
# ------------------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, TRUE, TRUE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))

# Metadata for the pseudobulk matrix:
umeta = ps.data$meta
pmat = ps.data$mat
umeta = umeta[umeta$cell_type_high_resolution != 'Exc SOX11 NCKAP5',]
umeta = umeta[umeta$ncell > 10,]


# Matched metadata to the full matrix:
# ------------------------------------
rownames(cellmeta) = cellmeta$barcode
submeta = cellmeta[colnames(nmat),]
advars = c('cogdx','cogdxad','niareagansc','nrad','braaksc')
covars = c('age_death','msex','pmi', 'Apoe_e4')
submeta = merge(submeta, unique(metadata[,c('projid','region', advars, covars)]))
rownames(submeta) = submeta$barcode
submeta = submeta[colnames(nmat),]


# Load in regression results for subtypes:
# ----------------------------------------
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
topdegdf = read.delim(gzfile(topdeg.file), sep="\t")
topdegdf = topdegdf[order(topdegdf$log10p_nm, decreasing=T),]
upgene = unique(topdegdf$gene[topdegdf$col == 2])
dwgene = unique(topdegdf$gene[topdegdf$col == 1])


# Gene sets by type:
# ------------------
pathlist = unique(topdegdf$path)
uplist = list()
dwlist = list()
for (path in pathlist){
    uplist[[path]] = topdegdf$gene[(topdegdf$col == 2) & (topdegdf$path == path)]
    dwlist[[path]] = topdegdf$gene[(topdegdf$col == 1) & (topdegdf$path == path)]
}

png(paste0(imgpref, 'barplot_consistent_degs_up.png'), res=400, units='in', width=5, height=4)
barplot(sapply(uplist, length), horiz=TRUE)
dev.off()

png(paste0(imgpref, 'barplot_consistent_degs_down.png'), res=400, units='in', width=5, height=4)
barplot(sapply(dwlist, length), horiz=TRUE)
dev.off()

pdf(paste0(imgpref, 'barplot_consistent_degs_up.pdf'), width=5, height=4)
barplot(sapply(uplist, length), horiz=TRUE)
dev.off()

pdf(paste0(imgpref, 'barplot_consistent_degs_down.pdf'), width=5, height=4)
barplot(sapply(dwlist, length), horiz=TRUE)
dev.off()

# Core set of genes:
ctgene = table(unlist(uplist))
coreup = names(ctgene)[ctgene == 4]

ctgene = table(unlist(dwlist))
coredw = names(ctgene)[ctgene == 4]

length(coreup)
length(coredw)


# Enumerate AD GWAS genes in these:
# ---------------------------------
ad.df = read.delim(paste0(sdbdir, 'ADGENES_Tanzi_20210915.tsv'), header=T, sep="\t")
adgenes = sort(ad.df$GENE)

# Up: CLU
sapply(uplist, function(x){x[x %in% adgenes]})

# Down: ICA1, SORL1, TPCN1, APH1B, IQCK
# NOTE: ICA1 is in all of the consistently down DEG sets.
sapply(dwlist, function(x){x[x %in% adgenes]})


# Plot the DEG lists as a simple heatmap first:
# ---------------------------------------------
updf = topdegdf[topdegdf$gene %in% upgene, ]
upmat = pivot.tomatrix(updf[,c('gene','col','path')], 'gene','col')
upmat[is.na(upmat)] = 0
plt = Heatmap(upmat,
              width = ncol(upmat)*unit(5, "mm"), 
              height = nrow(upmat)*unit(5, "mm"),
              col=colb,
              use_raster=TRUE)


dwdf = topdegdf[topdegdf$gene %in% dwgene, ]
dwmat = pivot.tomatrix(dwdf[,c('gene','col','path')], 'gene','col')
dwmat[is.na(dwmat)] = 0
plt = Heatmap(dwmat,
              col=colb,
              use_raster=TRUE)


topdegdf[topdegdf$gene == 'YWHAH',]


# Functional enrichments for the (up) DEGs by where/when they are called:
# -----------------------------------------------------------------------
sources = c("GO:CC","GO:BP","GO:MF","REAC","WP","KEGG","CORUM")
sub.sources = c('REAC','WP','KEGG','CORUM')
gp2.result = gprofiler2::gost(uplist, organism='hsapiens',
                              ordered_query=FALSE, multi_query=TRUE,
                              sources = sources)
gp2df = gp2.result$result
pmat = t(as.matrix(data.frame(gp2df$p_values)))
rownames(pmat) = NULL  # Format 
pvals = c()
gp2df$col = ''
for (j in 1:length(uplist)){
    pstr = paste0('p_', names(uplist)[j])
    gp2df[[pstr]] = pmat[,j]
    pvals = c(pvals, pstr)
    # Significant:
    sind = gp2df[[pstr]] < 0.05
    gp2df$col[sind] = paste0(gp2df$col[sind], names(uplist)[j])
}
gp2cols = c('term_id',pvals,'source','term_name', 'col', 'term_size')
gp2df = gp2df[,gp2cols]

# What are they:
head(gp2df[gp2df$term_size < 500,], 25)
dim(gp2df[gp2df$term_size < 500,])


# Get the intersecting genes for the same terms:
gpall = gprofiler2::gost(unlist(uplist), organism='hsapiens',
                         ordered_query=FALSE, multi_query=FALSE,
                         user_threshold = 0.9,  # Make sure we capture all terms from above
                         sources = sub.sources, evcodes=TRUE)
gpalldf = gpall$result
rownames(gpalldf) = gpalldf$term_id


# Plot a reduced version of these enrichments:
subdf = gp2df[(gp2df$term_size < 500) & (gp2df$source %in% sub.sources),]
subdf$intersection = gpalldf[subdf$term_id, 'intersection']
pmat = -log10(subdf[,pvals])
colnames(pmat) = sub("^p_","", colnames(pmat))
rownames(pmat) = paste0(subdf$source, ": ", subdf$term_name)

# Gene annotation:
labgenes = subdf$intersection
ha = rowAnnotation(int = anno_mark(at=1:nrow(subdf), labels = labgenes))

plt = Heatmap(pmat,
              # use_raster=TRUE,
              width = ncol(pmat)*unit(5, "mm"), 
              height = nrow(pmat)*unit(5, "mm"),
              row_names_side = 'left',
              right_annotation=ha,
              col=colb)

pltprefix = paste0(imgpref, 'enrichments_consistent_degs_subsources')
png(paste0(pltprefix, '.png'), res=450, units='in', width=10, height=10)
print(plt)
dev.off()
pdf(paste0(pltprefix, '.pdf'), width=10, height=10)
print(plt)
dev.off()


# Subsets by where they are called (AD status vs. cog, etc.)
# ----------------------------------------------------------


# Plot top up/down DEGs as a volcano plot:
# ----------------------------------------
path = 'cogdxad'
for (path in pathlist){
    subdf = topdegdf[topdegdf$path == path,]
    subdf = subdf[order(subdf$col, decreasing=F),]
    subdf$log10p_nm[subdf$log10p_nm > 75] = 75
    degcols = c('0'='grey90','1'=col.paired[1],'2'=col.paired[5])
    labdf = rbind(head(subdf[subdf$col == 2,],35),
                  head(subdf[subdf$col == 1,],10))

    gp = ggplot(subdf, aes(zdir, log10p_nm, color=factor(col))) + 
        scale_color_manual(values=degcols) +
        geom_point(cex=.25) +
        scale_y_continuous(expand=c(0,0)) + 
        geom_vline(xintercept=0) + 
        geom_text_repel(data=labdf, aes(zdir, log10p_nm, label=gene, color=factor(col)), cex=2, max.overlaps=100) + 
        theme_pubr() + theme(legend.position = 'none')
    gp2 = rasterize(gp, layers='Point', dpi=450)

    pltprefix = paste0(imgpref, 'volcano_consistent_degs_', path)
    w = 4; h = 4
    ggsave(paste0(pltprefix, '.png'), gp2, dpi=400, units='in', width=w, height=h)
    ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=400, units='in', width=w, height=h)
}


# Functional enrichments for these DEGs:
# --------------------------------------
upmat = as.matrix(t(nmat[upgene,]))
cr = cor(log1p(upmat))

col_fun = colorRamp2(c(-.5, 0, .5), c("blue","white", "red"))
Heatmap(cr,
        use_raster=TRUE,
        col=col_fun)


# Craziness:
upmat = as.matrix(t(nmat[upgene,]))
svup = svd(upmat, nv=50)

diag(svup$d) ** 1

crest = svup$v %*% (diag(svup$d[1:ncol(svup$v)]) %*% t(svup$v))
# crest = svup$v %*% t(svup$v)
rownames(crest) = colnames(upmat)
cv = sqrt(diag(crest))
xcv = cv %*% t(cv)
crest = crest / xcv


col_fun = colorRamp2(c(-1, 0, 1), c("blue","white", "red"))
plt = Heatmap(crest,
              width = ncol(crest)*unit(4, "mm"), 
              height = nrow(crest)*unit(4, "mm"),
              use_raster=TRUE,
              col=col_fun)


pltprefix = paste0(imgpref, 'svd_est_correlation')
w = 15
png(paste0(pltprefix, '.png'), res=450, units='in', width=w, height=w)
print(plt)
dev.off()
pdf(paste0(pltprefix, '.pdf'), width=w, height=w)
print(plt)
dev.off()





