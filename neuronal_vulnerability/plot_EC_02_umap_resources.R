#!/usr/bin/R
# -------------------------------------------------------
# Plot UMAP resources for figure panels + other analysis:
# Updated: 12/02/2021
# -------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)

# Directories:
plotdir = paste0(imgdir, 'metadata/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Plot the separate UMAPs for EC neurons:
# ---------------------------------------
tab = read.delim('multiRegion/metadata_test_mrad_Exc_EC_combat_filthvg.tsv', header=T)
tab = tab[,c('barcode','projid','celltype','U1','U2')]
tab = merge(tab, unique(metadata[,c('projid','nrad')]))

# Shuffle points for plotting:
ind = 1:nrow(tab)
ad.ind = which(tab$nrad == 'AD')
ctrl.ind = which(tab$nrad == 'CTRL')
full.ind = sample(ind, length(ind), replace=FALSE)
ad.ind = sample(ad.ind, length(ad.ind), replace=FALSE)
ctrl.ind = sample(ctrl.ind, length(ctrl.ind), replace=FALSE)
xr = diff(range(tab$U1))
yr = diff(range(tab$U2))

# Plot the umap, with appropriate proportions:
w = 3
h = w * yr / xr
cex = 0.025
sp = 0.1
png(paste0(imgpref, 'EC_vuln_neurons_umap_alone.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(tab$U1[full.ind], tab$U2[full.ind], 
     col=tcols[tab$celltype[full.ind]], pch=19, cex=cex, axes=F)
dev.off()

png(paste0(imgpref, 'EC_vuln_neurons_umap_alone_CTRL.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(tab$U1[ctrl.ind], tab$U2[ctrl.ind], 
     col=tcols[tab$celltype[ctrl.ind]], pch=19, cex=cex, axes=F)
dev.off()

png(paste0(imgpref, 'EC_vuln_neurons_umap_alone_AD.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(tab$U1[ad.ind], tab$U2[ad.ind], 
     col=tcols[tab$celltype[ad.ind]], pch=19, cex=cex, axes=F)
dev.off()

png(paste0(imgpref, 'EC_vuln_neurons_umap_alone_NRAD.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(tab$U1[full.ind], tab$U2[full.ind], 
     col=colvals[['nrad']][tab$nrad[full.ind]], pch=19, cex=cex, axes=F)
dev.off()
