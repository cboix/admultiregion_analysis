#!/usr/bin/R
# -------------------------------------------------------------------------
# Determine consistent up / down patterns for each covariate
# Determine unique subtypes of DEGs for each pathology / AD measurement
# Plot coeff. + clusters of these DEGs across EC neurons
# Updated: 12/06/2021
# -------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(ComplexHeatmap)

library(ggplot2)
library(ggpubr)
library(ggrepel)
library(ggrastr)
options(width=175)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load in the aggregated top DEGs and results across all runs:
# ------------------------------------------------------------
aggneu.rda = paste0(regdir, 'allmethods.excitatory_subsets.merged.aggtop.rda')
load(aggneu.rda)


# Load the regression estimates of fraction changes:
# --------------------------------------------------
nvdir = paste0(sbindir, 'neuronal_vulnerability/')
source(paste0(nvdir, 'load_exc_OR_estimates.R'))
path = 'braaksc.ad'
sub.qbdf = getqb(path)


# Correlation - rank all genes relative to depletion:
# ---------------------------------------------------
path = 'braaksc.ad'
# path = 'braaksc.early' # APLP1 BACE1 MAP1A, NCS (calcium) AP2M1 (clathrin/picalm)
# path = 'plaq_d' # IL34? TOP2B!? CDK5R2
# path = 'nft'
# path = 'cogdxad'
subdf = alldf[alldf$path == path,]
sub.qbdf = getqb('braaksc.ad')

subdf = merge(subdf, sub.qbdf[,c('set','Est')])
zdf = spread(subdf[,c('set','gene', 'Est', 'logFC_nb')], gene, logFC_nb)
zmat = as.matrix(zdf[,-c(1,2)])

nc = apply(!(is.na(zmat)), 2, sum)
zmat = zmat[,nc >= max(nc) * .8]

cr = cor(zmat, zdf$Est, use='pairwise.complete.obs')
cr = cr[!is.na(cr), , drop=F]
cr = cr[order(cr),]
cr = data.frame(corr=cr)
cr$gene = rownames(cr)

cr$p.corr = NULL
for (i in 1:nrow(cr)){
    gene = cr$gene[i]
    cr.tt = cor.test(zmat[,gene], zdf$Est, use='pairwise.complete.obs')
    cr$p.corr[i] = cr.tt$p.value
}
cr$padj.corr = p.adjust(cr$p.corr, 'fdr')

# Compare gene coefficient in late AD to depletion:
# -----------------------------------------
subdf = topdegdf[topdegdf$path == path,]
subdf = merge(subdf, cr)
subdf$col = ifelse(subdf$signif > 0.25,  #  LATE AD USED 0.4
                   ifelse(subdf$zdir > 0, 2, 1), 0)

subdf$zdir[subdf$zdir > 3] = 3
subdf$col2 = subdf$col + 0.5 * (subdf$padj.corr < 0.05)
subdf = subdf[order(subdf$col2),]
labdf = subdf[subdf$col2 >= 1,]
labdf = labdf[!(labdf$col2 %in% c(1,2) & (abs(labdf$zdir) < 1.5)),]

pcols = brewer.pal(12, 'Paired')
degvals = c('0'='grey90','0.5'='grey50','1'=pcols[1],'1.5'=pcols[2],'2'=pcols[5], '2.5'=pcols[6])
gp = ggplot(subdf, aes(zdir, corr, label=gene, color=factor(col2))) + 
    # geom_point(cex=.25) + 
    geom_point() + 
    geom_smooth(method='lm', color='black') + 
    geom_abline(lty='dashed') + 
    scale_color_manual(values=degvals) +
    stat_cor(color='black') + 
    geom_hline(yintercept=0, lty='dotted') + 
    geom_vline(xintercept=0, lty='dotted') + 
    labs(x='Average Effect Size (z-scored)', y='Correlation with log2OR') +
    # geom_text_repel(data=labdf, aes(zdir, corr, label=gene, color=factor(col2)), max.overlaps=30, size=2) +  # For pdf
    geom_text_repel(data=labdf, aes(zdir, corr, label=gene, color=factor(col2))) +  # For vis
    theme_pubr() + theme(legend.position='none')

gp2 = rasterize(gp, layers='Point', dpi=450)
w = 7; h=6
pltprefix = paste0(imgpref, 'DEGs_vulnassoc_scatter_', path)
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)

write.table(subdf, paste0(regdir, 'allmethods.excitatory_subsets.comparison_depletion.tsv'), quote=F, row.names=F, sep="\t")

# cat(subdf$gene[subdf$col2 == 1.5 & subdf$corr > 0])
# cat(subdf$gene[subdf$col2 == 2.5 & subdf$corr < 0])
# subdf[subdf$col2 == 2.5,]


# Compare gene coefficient in late AD to depletion:
# -----------------------------------------
genes = c('NCDN', 'CHRM1','CLU','CDK5R1','CANX','CHGA','SNTG1', 'CX3CL1', 'CLU', 'MT-ND3', 'MT-CO3')
          # 'PRNP','H1FX','CDK5R1','HSP90AA1','NCDN','MT-ND3', 'CANX', 'CHGA', 'LDAH','LEPR')
# genes = c('PRNP','H1FX','CDK5R1','HSP90AA1','NCDN','MT-ND3', 'CANX', 'CHGA', 'LDAH','LEPR')
# genes = head(cr$gene, 20)
subdf = alldf[alldf$gene %in% genes,]
subdf = subdf[subdf$path %in% c(path),]
zdf = spread(subdf[,c('set','gene','logFC_nb','path')], path, logFC_nb)
cdf = spread(subdf[,c('set','gene', 'col_nm','path')], path, col_nm)
zdf$col = factor(cdf[[path]])
zdf = zdf[order(zdf$col),]
zdf = zdf[!is.na(zdf$col),]
zdf = merge(zdf, sub.qbdf[,c('set','Est')])

ggplot(zdf, aes_string(path,'Est', label ='set', color='col')) + 
    facet_wrap(~gene, scales='free_x') + 
    geom_smooth(method='lm', color='black') + 
    geom_point() + 
    geom_abline(lty='dashed') + 
    scale_color_manual(values=c('0'='grey50','1'='royalblue','2'='firebrick')) +
    stat_cor(color='black') + 
    geom_hline(yintercept=0, lty='dotted') + 
    geom_vline(xintercept=0, lty='dotted') + 
    geom_text_repel() + 
    theme_pubr()

# Go enr:
cat(tail(cr$gene, 200))
cat(head(cr$gene, 200))

