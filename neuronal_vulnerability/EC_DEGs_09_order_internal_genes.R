#!/usr/bin/R
# --------------------------------------------------------------
# Score cells in all regions/EC for now using the internal DEGs:
# Updated: 12/31/2021
# --------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)

# Directories:
fracdir = paste0(sdbdir, 'fractions/')
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load everything (including full matrix dataset):
# ------------------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, TRUE, TRUE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))

# Metadata for the pseudobulk matrix:
umeta = ps.data$meta
pmat = ps.data$mat
umeta = umeta[umeta$cell_type_high_resolution != 'Exc SOX11 NCKAP5',]
# umeta = umeta[umeta$ncell > 10,]


# Matched metadata to the full matrix:
# ------------------------------------
rownames(cellmeta) = cellmeta$barcode
submeta = cellmeta[colnames(nmat),]
advars = c('cogdx','cogdxad','niareagansc','nrad','braaksc')
covars = c('age_death','msex','pmi', 'Apoe_e4')
submeta = merge(submeta, unique(metadata[,c('projid','region', advars, covars)]))
rownames(submeta) = submeta$barcode
submeta = submeta[colnames(nmat),]


# Load in regression results for subtypes:
# ----------------------------------------
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
topdegdf = read.delim(gzfile(topdeg.file), sep="\t")
topdegdf = topdegdf[order(topdegdf$log10p_nm, decreasing=T),]


# Save correlation estimates:
# TODO: also get p-values?
write.table(subcr, paste0(regdir, 'expression.excitatory_subsets.comparison_depletion.tsv'), quote=F, row.names=F, sep="\t")


# Load the regression estimates of fraction changes:
# --------------------------------------------------
nvdir = paste0(sbindir, 'neuronal_vulnerability/')
source(paste0(nvdir, 'load_exc_OR_estimates.R'))
path = 'braaksc.ad'
sub.qbdf = getqb(path)

umeta = merge(umeta, sub.qbdf)
umeta = merge(umeta, unique(metadata[,c('projid','region','rind','nrad','cogdxad','braaksc.ad')]))
umeta = merge(umeta, pqdf)
# umeta = umeta[umeta$ptype != '70625336_Exc_TOX3_INO80D_EC',]

# Select covariate of interest, make score:
# -----------------------------------------
genes = c('FAIM2','CDK5R1','APLP1', 'FASTK','DFFA','HYOU1','PRNP','SNCB','CX3CL1', 'CLU', 'CALR','CANX','B4GAT1','MT-ND3','MT-CO3', 'H1FX','UBB','CLSTN1','PCSK1N', 'PLCG2','DHFR', 'AP2M1','MAP1A', 'CDK5R2','HSP90AA1', 'GAPDH', 'CHGA')
# Scores (pseudobulk for now):
submat = as.matrix(pmat[genes,umeta$ptype])

# g1 = 'APLP1'
g1 = 'FAIM2'
# g2 = 'CDK5R1'
g2 = 'CHGA'
umeta$g1 = submat[g1,]
umeta$g2 = submat[g2,]
umeta$vuln = umeta$cell_type_high_resolution %in% vuln.neurons

mndf = aggregate(cbind(g1, g2) ~ cell_type_high_resolution, umeta, mean)
names(mndf) = c('cell_type_high_resolution','m1','m2')
subdf = merge(umeta, mndf)


ggplot(subdf, aes(g1-m1, g2-m2, label=cell_type_high_resolution, color=nrad)) + 
    geom_smooth(method='lm', color='black') + 
    geom_point() + 
    stat_cor(color='black') + 
    # scale_color_manual(values=tcols[unique(umeta$cell_type_high_resolution)]) + 
    # geom_text_repel() +
    theme_pubr()

ggplot(subdf, aes(g1-m1, g2-m2, label=cell_type_high_resolution, color=nrad)) + 
    facet_wrap(~projid, scales='free') + 
    geom_smooth(method='lm', color='black') + 
    # geom_smooth(color='black') + 
    geom_point() + 
    stat_cor(color='black') + 
    labs(x=g1, y=g2) + 
    # scale_color_manual(values=tcols[unique(umeta$cell_type_high_resolution)]) + 
    # geom_text_repel() +
    theme_pubr()


# UMAP for genes alone:
# ---------------------
library(uwot)
submat = log1p(as.matrix(t(nmat[genes,])))

udf = umap(submat)
udf = data.frame(udf)
udf$barcode = rownames(submat)
udf$cls = submeta$cell_type_high_resolution
udf$projid = submeta$projid
udf$nrad = submeta$nrad
udf$cogdxad = submeta$cogdxad
udf$braaksc = submeta$braaksc
udf$braaksc.stage = ifelse(submeta$braaksc <= 2, 'Early','Late')

g1 = 'CDK5R1'
# g1 = 'FAIM2'
g1 = 'H1FX'
g1 = 'CHGA'
udf$g1 = submat[,g1]
ggplot(udf, aes(X1, X2, color=g1)) + 
    facet_wrap(~cls) + 
    geom_point() + 
    scale_colour_viridis() + 
    theme_pubr()

g1 = 'MT-ND3'
ggplot(udf[udf$braaksc <= 2,], aes(X1, X2, color=g1)) + 
    facet_wrap(~cls) + 
    geom_point() + 
    scale_colour_viridis() + 
    theme_pubr()

g1 = 'CDK5R1'
udf$g1 = submat[,g1]
subdf = udf[order(udf$g1),]
ggplot(subdf, aes(X1, X2, color=g1)) + 
    facet_grid(braaksc.stage~cls) + 
    geom_point() + 
    scale_colour_viridis() + 
    theme_pubr()



ggplot(udf, aes(X1, X2, color=nrad)) + 
    facet_wrap(~cls) + 
    geom_point() + 
    theme_pubr()

ggplot(udf, aes(X1, X2, color=cls)) + 
    geom_point() + 
    scale_color_manual(values=tcols[unique(udf$cls)]) + 
    theme_pubr()

ggplot(udf, aes(X1, X2, color=cls)) + 
    facet_wrap(~cls) + 
    geom_point() + 
    scale_color_manual(values=tcols[unique(udf$cls)]) + 
    theme_pubr()

