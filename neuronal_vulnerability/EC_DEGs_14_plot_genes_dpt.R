#!/usr/bin/R
# -------------------------------------------------------
# Plots for the integrated neuronal trajectory from DEGs:
# Updated: 03/11/2022
# -------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)


library(ComplexHeatmap)
library(circlize)
options(width=175)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'detraj_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load the metadata for the DE trajectory:
# ----------------------------------------
usefull = TRUE
if (usefull){
    useprefix = 'testedgenes_combat'
} else {
    useprefix = 'DEGpartitions_combat'
}
imgpref = paste0(plotdir, 'detraj_', useprefix, '_')
df.pref = paste0(sdbdir, 'multiregion_majorctUMAP_Exc_log1p_')
df.file = paste0(df.pref, useprefix, '_subsetUMAP.tsv')

df = read.delim(df.file, header=T)
keep.cols = c('barcode', 'projid', 'region', 'celltype', 'C1','C2',
    'dpt_pseudotime','leiden', 'nft','plaq_n','plaq_d','cogdxad','nrad', 'niareagansc', 'braaksc')
# df = df[,keep.cols]
gc()

if (usefull){
    y = max(df$C2) - df$C2
    df$dpt_pseudotime = y / max(y)
}
rownames(df) = df$barcode


# Get the non-pseudobulk data for plotting on a cell-level:
# ---------------------------------------------------------
source(paste0(sbindir, 'auxiliary_pseudobulk_loading_fns.R'))
all.exc = unlist(exc.sets)
nmat = load_full_dataset('Exc', all.exc, reg.nomb)
rownames(df) = df$barcode
subdf = df[colnames(nmat),]


# TODO: function to average score NFT, etc. 

# Plot the genes on the trajectory umap:
# --------------------------------------
palette = viridis(100)
col_fun = function(x, pal=palette, mx=NULL){
    if (is.null(mx)){mx=max(x)} else {x[x > mx] = mx}
    bin <- cut(x, seq(0, mx, length.out=length(palette)), include.lowest=T) 
    palette[bin]  }

cex = 0.025
sp = 0.1
w=1; h=1

genes = c('NRXN1','KCNIP4','CALM1','CALM3','MT-CO2','MT-ND4')  # Markers
# genes = c('CLTB', 'AP2M1', 'NRGN', 'PRNP', 'PKM', 'CALR', 'FAIM2', 'DHFR',
#     'SLC27A6', 'YPEL1', 'CRK', 'NCAM2', 'ABCA7', 'UBTF', 'MT-CO3',
#     'MT-ND3', 'PLCG2', 'CLU', 'NEUROD2', 'NOXA1', 'KAZN', 'PSEN1', 'APP',
#     'CHN1','HSP90AA1','PEBP1')
genes = c('SLC27A6','LPP','CLU','PKM','UBB','YWHAH')
    # 'PKM','PDE5A', 'DHFR','SLC27A6', 'PDE4D')  # Markers
submat = log1p(as.matrix(nmat[genes,]))

for (gene in genes){
    x = submat[gene,]
    ind = which(!is.na(x))
    ind = ind[order(x[ind])]
    sp=0.05
    png(paste0(imgpref, 'umap_gene_', gene, '.png'), units='in', res=450, width=w, height=h)
    par(xaxs='i',yaxs='i')
    par(mar=rep(sp,4))
    plot(subdf$C1[ind], subdf$C2[ind], 
        col=col_fun(x[ind]), pch='.', cex=.25, axes=F)
    mtext(gene, side=1, line=-1, font=2)
    dev.off()
}



# Read in the trajectories:
# -------------------------
group.file = paste0(df.pref, useprefix, '_subsetUMAP_branches.tsv')
horiz.group.file = paste0(df.pref, useprefix, '_subsetUMAP_horiz.tsv')
bdf = read.delim(group.file, header=T)
hdf = read.delim(horiz.group.file, header=T)
bdf$pst = max(bdf$C2) - bdf$C2
bdf$pst = bdf$pst / max(bdf$pst)
hdf$pst = (hdf$C1 - min(hdf$C1))
hdf$pst = hdf$pst / max(hdf$pst)

pstdf = rbind(bdf[,c('barcode','group','pst')],
    hdf[,c('barcode','group','pst')])
pstdf = pstdf[pstdf$barcode %in% colnames(submat),]
groups = unique(pstdf$group)


# Read in the predictions + intervals:
# ------------------------------------



# Plot gene expression along the pseudotime:
# ------------------------------------------
genes = c('NRXN1','KCNIP4','CALM1','CALM3','MT-CO2','MT-ND4',
    'PKM','PDE5A', 'DHFR','SLC27A6', 'PDE4D')  # Markers
submat = log1p(as.matrix(nmat[genes,]))
groups = c('left','horizontal', 'right')

for (gene in genes){

    nc = length(groups)
    h =0.75; w = nc * h;
    pstdf$x = submat[gene, pstdf$barcode]
    ylim = c(0, quantile(submat[gene,], .9999))
    # ind = which(!is.na(x))
    # ind = ind[order(x[ind])]
    sp=0.05
    png(paste0(imgpref, 'scatter_gene_', gene, '.png'), units='in', res=450, width=w, height=h)
    par(xaxs='i',yaxs='i', mar=rep(sp,4))
    layout(matrix(1:nc, ncol=nc, nrow=1))
    for (group in groups){
        ind = pstdf$group == group
        plot(pstdf$pst[ind], pstdf$x[ind], col='grey65',
            pch='.', cex=.4, axes=F, xlim=c(0,1), ylim=ylim)
        # col=col_fun(pstdf$pst[ind]), pch='.', cex=.25, axes=F)
        mtext(capitalize(group), side=3, line=-1, font=1, cex=.5)
        if (group == groups[1]){
            mtext(gene, side=2, line=-1, font=1, cex=.5)
        }
    }
    dev.off()

}






