#!/usr/bin/R
# -------------------------------------------------------------
# Score genes by their expression's correlation with depletion:
# Updated: 01/19/2022
# -------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)
library(ggrastr)

library(ComplexHeatmap)
library(circlize)

# Directories:
srdir = paste0(sdbdir, 'subtype_reg/')
fracdir = paste0(sdbdir, 'fractions/')
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load the pseudobulk data for all neurons:
# -----------------------------------------
source(paste0(sbindir, 'auxiliary_pseudobulk_loading_fns.R'))
# TODO: get all:
psdata.rda = paste0(srdir, 'pseudobulk_data_', 'Exc', '.rda')
load(psdata.rda)


# Load in the full pseudobulk data for these subtypes:
# ----------------------------------------------------
source(paste0(sbindir, 'auxiliary_pseudobulk_loading_fns.R'))
psdata.rda = paste0(srdir, 'pseudobulk_data_', 'Exc', '.rda')
neuronal.subtypes = unlist(exc.sets)
if (!file.exists(psdata.rda)){
    ps.data = load_pseudobulk_dataset('Exc', neuronal.subtypes, reg.nomb)
    save(ps.data, file=psdata.rda)
} else { load(psdata.rda) }


# # Metadata for the pseudobulk matrix:
umeta = ps.data$meta
pmat = ps.data$mat
umeta = umeta[umeta$cell_type_high_resolution != 'Exc SOX11 NCKAP5',]
# # umeta = umeta[umeta$ncell > 10,]
advars = c('braaksc.ad','braaksc.early','cogdxad', 'braaksc')
covars = c('msex','pmi','age_death')
umeta = merge(umeta, metadata[,c('projid','region', advars, covars)], all.x=TRUE)
pmat = pmat[, umeta$ptype]


# Reduce to estimates of gene expression in early/late/overall:
# -------------------------------------------------------------
late.ind = umeta$braaksc >= 5
early.ind = umeta$braaksc <= 2
cts = unique(umeta$cell_type_high_resolution)
makeExprReduced = function(ind, umeta, pmat){
    tform = make.tform(umeta$cell_type_high_resolution[ind], u=cts, norm=F)
    tform = sweep(tform, 1, umeta$ncell[ind], '*')
    tform = sweep(tform, 2, apply(tform, 2, sum), '/')
    avgmat = as.matrix(pmat[,ind] %*% tform)
    return(avgmat)
}

matlist = list()
matlist[['late']] = makeExprReduced(late.ind, umeta, pmat)
matlist[['early']] = makeExprReduced(early.ind, umeta, pmat)
matlist[['all']] = makeExprReduced(1:nrow(umeta), umeta, pmat)


# Load the regression estimates of fraction changes:
# --------------------------------------------------
nvdir = paste0(sbindir, 'neuronal_vulnerability/')
source(paste0(nvdir, 'load_exc_OR_estimates.R'))
path = 'braaksc.ad'
sub.qbdf = getqb(path)
sub.qbdf = sub.qbdf[!(sub.qbdf$set %in% c('Exc_Exc_SOX11_NCKAP5', 'Exc_Exc_TOX3_INO80D')),]
sub.qbdf$set = sub("^Exc_", "", sub.qbdf$set)
matcols = colnames(matlist[['late']])
colmap = data.frame(ct=matcols, set=gsub("[ ]", "_", matcols))
sub.qbdf = merge(sub.qbdf, colmap, all.x=TRUE)
# cts = cts[cts != 'Exc TOX3 INO80D']
rownames(sub.qbdf) = sub.qbdf$ct

cts = sub.qbdf$ct[sub.qbdf$ct %in% matcols]
dep.score = sub.qbdf[cts, 'Est']


# Compute the correlation between expression estimates + depletion:
# -----------------------------------------------------------------
# cr = cor(t(avg.mat[,cts]), dep.score, use='pairwise.complete.obs')
# cr = cor(t(early.mat[,cts]), dep.score, use='pairwise.complete.obs')
crdf = c()
for (stage in names(matlist)){
    mat = matlist[[stage]]
    cr = cor(t(mat[,cts]), dep.score, use='pairwise.complete.obs')
    cr = cr[!is.na(cr), , drop=F]
    cr = cr[order(cr),]
    cr = data.frame(corr=cr)
    cr$gene = rownames(cr)
    cr$time = stage
    rownames(cr) = NULL
    crdf = rbind(crdf, cr)
}

# Save correlation estimates:
# TODO: also get p-values?
write.table(crdf, paste0(regdir, 'expression.excitatory_subsets.comparison_depletion.tsv'), quote=F, row.names=F, sep="\t")


# Plot some of these genes:
# -------------------------
use.fullset = FALSE
if (use.fullset){
    genes = unique(c('FAIM2','CDK5R1','APLP1', 'FASTK','DFFA','HYOU1','PRNP','SNCB','CX3CL1', 'CLU', 'CALR','CANX','B4GAT1','MT-ND3','MT-CO3', 'H1FX','UBB','CLSTN1','PCSK1N', 'PLCG2','DHFR', 'AP2M1','MAP1A', 'CDK5R2','HSP90AA1', 'GAPDH', 'CHGA', 'CHRM1','PSAP','SNTG1', 'CRK', 'XIAP', 'NCDN','NEUROD2', 'HS6ST3','SESN3', 'SLC38A2', 'NRXN2', 'KAZN', 'NOXA1', 'LINGO1'))
} else {
    genes = c('MT-CO3', 'PLCG2', 'FAIM2', 'SLC38A2', 'CDK5R1', 'NRXN2', 'KAZN', 'NOXA1')
}
subcr = crdf[(crdf$gene %in% genes) & (crdf$time == 'late'),]

alldf = c()
for (gene in genes){
    pltdf = sub.qbdf
    pltdf$Late56 = matlist[['late']][gene, rownames(sub.qbdf)]
    pltdf$All = matlist[['all']][gene, rownames(sub.qbdf)]
    pltdf$Early012 = matlist[['early']][gene, rownames(sub.qbdf)]
    pltdf = gather(pltdf, time, expr, -set, -ct, -Est)
    pltdf = pltdf[pltdf$ct != 'Exc TOX3 INO80D',]
    pltdf$gene = gene
    alldf = rbind(alldf, pltdf)
}

load.colors()
stage.colors = c('All'='grey30', 'Early012'=col.paired[2], 'Late56'=col.paired[6])
alldf$gene = factor(alldf$gene, levels=subcr$gene)
gp = ggplot(alldf, aes(Est, expr, label=ct, color=time)) + 
    facet_wrap(~gene, scales='free') + 
    geom_smooth(method='lm', fill='grey90') + 
    geom_point(cex=.5) + 
    stat_cor(color='black',label.y.npc=1) + 
    stat_cor(label.y.npc=0.9) + 
    scale_color_manual(values=stage.colors, name='Braak') +
    theme_pubr()

gp2 = rasterize(gp, layers='Point', dpi=450)
if (use.fullset){
    w=18; h=12
    pltprefix = paste0(imgpref, 'exprexamp_vulnassoc_scatter_', path)
} else {
    w=7; h=7
    pltprefix = paste0(imgpref, 'exprexamp_figgenes_vulnassoc_scatter_', path)
}
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)




# TODO: Get pvalues:

# subdf = merge(subdf, sub.qbdf[,c('set','Est')])
# zdf = spread(subdf[,c('set','gene', 'Est', 'logFC_nb')], gene, logFC_nb)
# zmat = as.matrix(zdf[,-c(1,2)])

# nc = apply(!(is.na(zmat)), 2, sum)
# zmat = zmat[,nc >= max(nc) * .8]

# cr = cor(zmat, zdf$Est, use='pairwise.complete.obs')
# cr = cr[!is.na(cr), , drop=F]
# cr = cr[order(cr),]
# cr = data.frame(corr=cr)
# cr$gene = rownames(cr)

# cr$p.corr = NULL
# for (i in 1:nrow(cr)){
#     gene = cr$gene[i]
#     cr.tt = cor.test(zmat[,gene], zdf$Est, use='pairwise.complete.obs')
#     cr$p.corr[i] = cr.tt$p.value
# }
# cr$padj.corr = p.adjust(cr$p.corr, 'fdr')
