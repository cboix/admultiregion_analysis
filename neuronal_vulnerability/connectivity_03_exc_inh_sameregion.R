#!/usr/bin/R
# --------------------------------------------------------------------------------------
# Investigate the co-variation of selective vulnerability across all excitatory neurons:
# TODO: Neurons alone and neurons + glia
# Updated 12/21/2021
# --------------------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(betareg)

library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)
options(width=150)

# Directories:
plotdir = paste0(imgdir, 'vuln/')
fracdir = paste0(sdbdir, 'fractions/')
imgpref = paste0(plotdir, 'conn_')
cmd = paste('mkdir -p', imgdir, plotdir)
system(cmd)

# ---------------------------------------------
# Get the relative abundances for all subtypes:
# ---------------------------------------------
totdf = agg.rename(barcode ~ projid + region, cellmeta, length, 'total')
etotdf = agg.rename(barcode ~ projid + region, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'exc.total')

analysis = 'ExcInh'
submeta = cellmeta[cellmeta$major.celltype %in% c('Exc', 'Inh'), ]
ctdf = agg.rename(barcode ~ projid + region + cell_type_high_resolution, submeta, length, 'count')
combdf = expand.grid(cell_type_high_resolution=unique(submeta$cell_type_high_resolution), 
                     region=unique(submeta$region), projid=unique(submeta$projid))

ctdf = merge(ctdf, combdf, all.y=TRUE)
ctdf$count[is.na(ctdf$count)] = 0
ctdf = merge(ctdf, totdf) # Removes a couple missing projid x region comb.
ctdf = merge(ctdf, etotdf)
ctdf$other = ctdf$total - ctdf$count
names(ctdf)[3] = 'celltype'
ctdf$frac = ctdf$count / ctdf$total


# Make a matrix with all of the possible fractions:
# -------------------------------------------------
# Keep only subtypes with > 250 cells in the region
nregdf = aggregate(count ~ region + celltype, ctdf, sum)
nregdf = nregdf[nregdf$count >= 250, c('region', 'celltype')]
ctdf = merge(ctdf, nregdf)

# Make matrix, individual against celltype + region
ctdf$cr = with(ctdf, paste0(celltype, '-', region))
cwide = spread(ctdf[,c('projid','cr','frac')], cr, frac)
cmat = as.matrix(cwide[,2:ncol(cwide)])
cdf = cwide[,c('projid'), drop=F]
cdf = merge(cdf, unique(metadata[,c('projid','msex','age_death','pmi','Apoe_e4', 'nrad','cogdxad')]))
rownames(cmat) = cwide$projid
rownames(cdf) = cdf$projid
cdf = cdf[rownames(cmat),]


# Set up pairwise comparisons:
# ----------------------------
exc.runs = list()
inh.runs = list()
for (region in reg.nomb){
    ind = grep(paste0("-", region, "$"), colnames(cmat))
    cn = colnames(cmat)[ind]
    inh.runs[[region]] = cn[grep("^Inh", cn)]
    exc.runs[[region]] = cn[grep("^Inh", cn, invert=TRUE)]
}


# Run regressions if not already computed:
# ----------------------------------------
use.adonly = TRUE
use.betareg = TRUE

suffix = analysis
if (use.betareg){ suffix = paste0(suffix, '_betareg') }
if (use.adonly){ suffix = paste0(suffix, '_adonly') }

conn.reg.tsv = paste0(fracdir, 'connectivity_regressions_', suffix, '.tsv')
conn.reg.file = paste0(fracdir, 'connectivity_regressions_', suffix, '.rda')

if (!file.exists(conn.reg.file)){
    conndf = c()
    cr1list = list()
    cr2list = list()
    p1list = list()
    p2list = list()
    for (region in reg.nomb){
        print(region)
        # Initialize regression + cor.test outputs:
        # -----------------------------------------
        NE = length(exc.runs[[region]])
        NI = length(inh.runs[[region]])
        dn = list(exc.runs[[region]], inh.runs[[region]])
        cr1mat = matrix(0, nrow=NE, ncol=NI, dimnames=dn)
        p1mat = matrix(0, nrow=NE, ncol=NI, dimnames=dn)
        regdf = c()

        # Run regressions on each pair:
        # -----------------------------
        for (i in 1:NE){
            for (j in 1:NI){
                cti = exc.runs[[region]][i]
                ctj = inh.runs[[region]][j]
                # 1: Correlation test (using ranked test for percentages):
                if (use.adonly){ ind = (cdf$nrad == 'AD') } else { ind = 1:nrow(cdf) }
                ct = cor.test(cmat[ind,cti], cmat[ind,ctj], method='kendall')
                p1mat[i,j] = ct$p.value
                cr1mat[i,j] = ct$estimate
                # 2: Regression:
                if (use.betareg){
                    # Add offset for beta regression to be in (0,1)
                    cdf$ci = cmat[,cti] + 1e-3
                    cdf$cj = cmat[,ctj] + 1e-3
                } else {
                    # Log transform for low percentages (othw. logit)
                    cdf$ci = log10(cmat[,cti] + 1e-3)
                    cdf$cj = log10(cmat[,ctj] + 1e-3)
                }
                fracform = as.formula('ci ~ cj + msex + Apoe_e4 + pmi + age_death')
                if (use.betareg){
                    fit = betareg(fracform, cdf[ind,])
                    cfit = coefficients(summary(fit))$mean
                    colnames(cfit) = c('est','SE','z','p')
                } else {
                    fit = lm(fracform, cdf[ind,])
                    cfit = coefficients(summary(fit))
                    colnames(cfit) = c('est','SE','t','p')
                }
                out = cfit['cj',]
                out$cti = cti
                out$ctj = ctj
                out$i = i
                out$j = j
                out$region = region
                regdf = rbind(regdf, data.frame(out))
            }
        }
        regdf = regdf[order(regdf$p),]

        cr2mat = matrix(0, nrow=NE, ncol=NI, dimnames=dn)
        p2mat = matrix(0, nrow=NE, ncol=NI, dimnames=dn)
        # NOTE: Not symmetric:
        cr2mat[as.matrix(regdf[,c('i','j')])] = regdf$est
        p2mat[as.matrix(regdf[,c('i','j')])] = p.adjust(regdf$p, 'fdr')

        cr1list[[region]] = cr1mat
        cr2list[[region]] = cr2mat
        p1list[[region]] = p1mat
        p2list[[region]] = p2mat
        conndf = rbind(conndf, regdf)
    }
    conndf$padj = p.adjust(conndf$p, 'fdr')
    conndf = conndf[order(conndf$p),]

    save(conndf, cr1list, cr2list, p1list, p2list, file=conn.reg.file)
    write.table(conndf, conn.reg.tsv, quote=F, row.names=F, sep="\t")
} else {
    load(conn.reg.file)
}


# Subset to the main Exc subtypes for each:
kept.sets = outer(exc.sets[['CTXneurons']], c('-AG','-MT','-PFC'), paste0)
kept.sets = c(kept.sets, paste0(exc.sets[['HCneurons']], '-HC'))
kept.sets = c(kept.sets, paste0(exc.sets[['ECneurons']], '-EC'))
kept.sets = c(kept.sets, paste0(exc.sets[['THneurons']], '-TH'))
maindf = conndf[conndf$cti %in% kept.sets,]
head(maindf, 20)


# Plot region connections:
# ------------------------
for (region in reg.nomb){
    cr1mat = cr1list[[region]]
    p2mat = p2list[[region]]
    kept.exc = rownames(cr1mat)[rownames(cr1mat) %in% kept.sets]
    col_fun = colorRamp2(c(-.5, 0, .5), c('blue', 'white', 'red'))

    pltmat = cr1mat[kept.exc, ]
    plt.pmat = p2mat[kept.exc,]
    plt = Heatmap(pltmat,
                  use_raster=TRUE,
                  cluster_columns=TRUE, 
                  cluster_rows=TRUE, 
                  col=col_fun,
                  # column_split=sub(".*-","", colnames(pltmat)),
                  # row_split=sub(".*-","", rownames(pltmat)),
                  width = ncol(pltmat)*unit(5, "mm"), 
                  height = nrow(pltmat)*unit(5, "mm"),
                  rect_gp = gpar(type = "none"), column_dend_side = "bottom",
                  cell_fun = function(j, i, x, y, w, h, fill) {
                      grid.rect(x, y, w, h, gp = gpar(fill = fill, col = fill))
                      if (i != j){
                          p = plt.pmat[i,j] # Adjusted p-values from regression.
                          ann = ifelse(p < 0.05, ifelse(p < 0.01, ifelse(p < 0.001, '***','**'),'*'),'')
                          grid.text(ann, x, y) }
                  })

    # Correlation + p-value from regression accounting for covariates
    pltprefix = paste0(imgpref, 'correlation_regrpvals_', suffix, '_heatmap_', region)
    w = 9
    pdf(paste0(pltprefix, '.pdf'), width=w, height=w)
    print(plt)
    dev.off()
    png(paste0(pltprefix, '.png'), units='in', res=400, width=w, height=w)
    print(plt)
    dev.off()
}


# Plot the top correlated neuronal subtypes within regions:
# ---------------------------------------------------------
head(maindf[maindf$region == 'EC',], 10)

# pairlist = list(c('Exc AGBL1 GPC5-EC', 'Exc L6 CT-MT'),
#                 c('Exc TOX3 INO80D-EC', 'Exc L4-5 RORB GABRG1-PFC'),
#                 c('CA1 pyramidal cells-HC', 'Exc L2-3 CBLN2 LINC02306-MT'))

pair = unlist(maindf[,c('cti','ctj')][2,])
pair = unlist(maindf[maindf$region == 'EC', c('cti','ctj')][10,])
# pair = unlist(maindf[maindf$region == 'HC', c('cti','ctj')][3,])

for (pair in pairlist){
    c1 = pair[1] 
    c2 = pair[2]
    suffstr = gsub(" ", "_", paste0(c1, '_vs_', c2))
    print(suffstr)
    cdf$ci = cmat[,c1] + 1e-3
    cdf$cj = cmat[,c2] + 1e-3

    gp = ggplot(cdf, aes(ci, cj, color=nrad)) + 
        geom_point() + 
        scale_color_manual(values=colvals[['nrad']]) + 
        geom_smooth(method='lm') + 
        scale_y_log10(labels=scales::percent) +
        scale_x_log10(labels=scales::percent) +
        # scale_y_continuous(labels=scales::percent) +
        # scale_x_continuous(labels=scales::percent) +
        stat_cor(method='kendall') + 
        # stat_cor(method='kendall', color='black') + 
        labs(x=c1, y=c2) + 
        theme_pubr()

    pltprefix = paste0(imgpref, 'example_', suffstr, '_scatter')
    ggsave(paste0(pltprefix, '.pdf'), units='in', width=3, height=3)
}


