#!/usr/bin/R
# ----------------------------------------
# Calculate markers of vulnerable neurons:
# Updated: 12/23/2021
# ----------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)
library(ggrastr)

# Directories:
srdir = paste0(sdbdir, 'subtype_reg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Functions to process outputs of regression:
# -------------------------------------------
process.fit = function(fit, gene, pcut=1e-4){
    cfit = coefficients(summary(fit))
    df = data.frame(cfit)
    colnames(df) = c('Est','SE','t','p')
    pval = df['val','p']
    if (!is.na(pval)){
        if (pval < pcut){ 
            cat(gene,'\t', 
                sprintf('%0.2e',pval), '\n')
        }
    }
    df$var = rownames(df)
    rownames(df) = NULL
    df$symbol = gene
    return(df)
}


# Load the regression estimates of fraction changes:
# --------------------------------------------------
frac.reg.file = paste0(fracdir, 'estimated_fraction_changes_ECneurons.tsv')
frac.regdf = read.delim(frac.reg.file, sep="\t")
names(frac.regdf)[4] = 'cell_type_high_resolution'

subset = 'Exc'
qbreg.file = paste0(fracdir, 'quasibinom_contrasts_Exc_byregion.tsv')
qbdf = read.delim(qbreg.file, sep='\t')

# TODO: Filter down the odds ratios analysis:
kdf = merge(data.frame(cls=exc.sets[['CTXneurons']]), data.frame(region=c('AG','MT','PFC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['ECneurons']], region=c('EC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['HCneurons']], region=c('HC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['THneurons']], region=c('TH')))

path = 'braaksc.ad'
sub.qbdf = qbdf[qbdf$path == path,]
sub.qbdf = merge(sub.qbdf[,c('cls','region','odds.ratio')], kdf)
sub.qbdf$Est = log2(sub.qbdf$odds.ratio)
sub.qbdf = sub.qbdf[,c('region','cls','Est')]
names(sub.qbdf)[2] = 'cell_type_high_resolution'


# Load abundances data only (1st arg):
# ------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, FALSE, FALSE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))


# Load pseudobulk data for all neurons in any set of regions:
# -----------------------------------------------------------
# Set the used regions:
# use.regions = 'EC'
# use.regions = 'ECHCTH'
use.regions = 'allregions'
if (use.regions == 'EC'){ 
    runsets = c('ECneurons') 
} else if (use.regions == 'ECHCTH'){ 
    runsets = c('ECneurons', 'HCneurons','THneurons')
} else if (use.regions == 'allregions'){
    runsets = c('ECneurons', 'HCneurons','THneurons', 'CTXneurons')
}

# Load the pseudobulk data:
umeta = NULL
pmat = NULL
for (runset in runsets){
    psdata.rda = paste0(srdir, 'pseudobulk_data_', runset, '.rda')
    if (!file.exists(psdata.rda)){
        ps.data = load_pseudobulk_dataset('Exc', exc.sets[[runset]], exc.set.regions[[runset]])
        save(ps.data, file=psdata.rda)
    } else { load(psdata.rda) }
    # Metadata for the pseudobulk matrix:
    umeta = rbind(umeta, ps.data$meta)
    pmat = cbind(pmat, ps.data$mat)
}

umeta = umeta[umeta$cell_type_high_resolution != 'Exc SOX11 NCKAP5',]
umeta = umeta[umeta$ncell > 10,]


# Set up metadata and matrix for regression:
# ------------------------------------------
nrmeta = unique(metadata[,c('projid','region','rind', 'nrad','cogdxad', 
                            'Apoe_e4','msex','pmi','age_death')])
umeta = merge(umeta, nrmeta)
umeta = merge(umeta, pqdf, all.x=TRUE)
umeta$age_rescaled = umeta$age_death / 100
umeta$vuln = 1 * (umeta$cell_type_high_resolution %in% vuln.neurons)
umeta$lnft = log1p(umeta$nft)
pmat = pmat[, umeta$ptype]

# Average expr, for filtering genes:
avg.pdf = data.frame(val=apply(pmat, 1, mean))  # NOTE: Not avg by cell number
avg.pdf$symbol = rownames(avg.pdf)


# Run regression on all EC/HC/TH neurons to find top genes:
# NOTE: log1p of the average of normalized counts
# ---------------------------------------------------------
# path = 'nrad'  # Original, but odds ratios estimates are more stable
# rdf = frac.regdf[frac.regdf$reg == path,]
umeta$Est = NULL
umeta$p = NULL
umeta$reg = NULL
# umeta = merge(umeta, rdf, all.x=TRUE)  # Original, but odds ratios estimates are more stable
umeta = merge(umeta, sub.qbdf, all.x=TRUE)  # Odds ratios from fig 3a
pmat = pmat[, umeta$ptype]
umeta$est.vuln = ifelse(umeta$Est < 0, 1, 0)

use.ctrlonly = TRUE
# use.est = FALSE
use.est = TRUE
suffix = use.regions
if (use.ctrlonly){ suffix = paste0(suffix, '_ctrlonly') }
if (use.est){ 
    suffix = paste0(suffix, '_estvuln_', path)
} else {
    suffix = paste0(suffix, '_vuln')
}

ecut = 0.2
kept.genelist = sort(avg.pdf[avg.pdf$val > ecut, 'symbol'])
est.regfile.rda = paste0('multiRegion/vulnmarkers_regression_psbulk_', suffix, '.Rda')
# Run the pseudobulk differential expression:
if (!file.exists(est.regfile.rda)){
    est.regdf = c()

    # Set up regression:
    if (use.est){ form = 'Est ~ val' } else { form = 'vuln ~ val' }
    if (use.ctrlonly){ 
        ind = umeta$nrad == 'CTRL' 
    } else { 
        ind = 1:nrow(umeta) 
        form = paste0(form, ' * nrad')
    }
    form = paste0(form, ' + age_rescaled + msex + pmi')
    form = as.formula(form)
    regmeta = umeta[ind,]
    ncell_weights = log(regmeta$ncell)

    # Run regressions for each gene:
    for (gene in kept.genelist){
        regmeta$val = log1p(pmat[gene, ind])
        fit = glm(form, regmeta, family='gaussian', weights=ncell_weights)
        df = process.fit(fit, gene, pcut=1e-5)
        est.regdf = rbind(est.regdf, df)
    }
    est.regdf = merge(est.regdf, avg.pdf, all.x=TRUE)
    save(est.regdf, file=est.regfile.rda)
} else {
    load(est.regfile.rda)
}

genes = c('HS6ST3','RELN','GPC5','CDH20','DAB1')
est.regdf[(est.regdf$symbol %in% genes) & (est.regdf$var == 'val'),]

# Filter by top in any subtype:
mxexpr = apply(pmat, 1, max)

# Plot volcano of these assoc. with depletions:
adf = est.regdf[est.regdf$var == 'val',]
adf = merge(adf, avg.pdf)
adf = adf[!is.na(adf$p),]
adf$mx = mxexpr[adf$symbol]
# adf = adf[adf$val > .5,]
# adf = adf[adf$mx > 10,]
adf = adf[adf$mx > 5,]
adf = adf[order(adf$p), ]
adf$padj = p.adjust(adf$p, 'fdr')
adf$log10q = -log10(adf$padj)
pcut = 1e-3
adf$color = 0
adf$color[adf$padj < pcut] = 1
adf$color[adf$padj < pcut & adf$Est > 0] = 2

ntop = 20
labdf = rbind(head(adf[adf$color == 1,],ntop),
              head(adf[adf$color == 2,],ntop))

tcols = brewer.pal(12, 'Paired')
# gplot = ggplot(adf, aes(Est * log1p(val), log10q, col=factor(color))) + 
gplot = ggplot(adf, aes(Est, log10q, col=factor(color))) + 
    scale_color_manual(values=c('grey85',tcols[1],tcols[5])) + 
    geom_vline(xintercept=0, lwd=.25, lty='dashed') + 
    geom_point(cex=.25, alpha=1) + theme_pubr() + 
    # geom_text_repel(data=labdf, aes(Est * log1p(val), log10q, label=symbol), max.overlaps=30, size=2, segment.size=.5) + 
    geom_text_repel(data=labdf, aes(Est, log10q, label=symbol), max.overlaps=30, size=2, segment.size=.5) + 
    scale_y_continuous(expand=c(0,0)) + 
    labs(x='Coefficient') + 
    theme(legend.position = 'none')
w = 3; h=4
ggsave(paste0(imgpref, 'vuln_genes_ind_pseudobulk_volcano_', suffix, '.png'), gplot, dpi=450, units='in', width=w, height=h)
ggsave(paste0(imgpref, 'vuln_genes_ind_pseudobulk_volcano_', suffix, '.pdf'), gplot, dpi=450, units='in', width=w, height=h)


# Plot reversed - makes more sense in figure:
tcols = brewer.pal(12, 'Paired')
adf = adf[order(adf$color, decreasing=F),]
gplot = ggplot(adf, aes(-Est, log10q, col=factor(color))) + 
    scale_color_manual(values=c('grey85',tcols[5],tcols[1])) + 
    geom_vline(xintercept=0, lwd=.25, lty='dashed') + 
    geom_point(cex=.25, alpha=1) + theme_pubr() + 
    geom_text_repel(data=labdf, aes(-Est, log10q, label=symbol), max.overlaps=30, size=2, segment.size=.5) + 
    scale_y_continuous(expand=c(0,0)) + 
    labs(x='Coefficient') + 
    theme(legend.position = 'none')

gp2 = rasterize(gplot, layers='Point', dpi=450)
w = 4; h=4
pltprefix = paste0(imgpref, 'vuln_genes_ind_pseudobulk_volcano_', suffix, '_forfigure')
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)

table(adf$color)

res.regfile.rda = paste0('multiRegion/vulnmarkers_regression_psbulk_', suffix, '_full.Rda')
save(adf, est.regdf, pmat, umeta, file=res.regfile.rda)

# Write for supplement:
if (path == 'braaksc.ad' && (use.regions == 'allregions') && use.ctrlonly && use.est){
    resdf = adf[,c('symbol','Est','SE','t','p','padj','log10q','color')]
    names(resdf) = c('gene','Est','SE','t','p','p.adj','log10p.adj','signif')
    resdf = resdf[order(resdf$p),]
    write.table(resdf, paste0('multiRegion/vulnmarkers_regression_psbulk_forSupplementaryTable8_', suffix, '.tsv'), 
        quote=F, sep="\t", row.names=FALSE)

}

