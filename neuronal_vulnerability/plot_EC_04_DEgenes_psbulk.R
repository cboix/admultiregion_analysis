#!/usr/bin/R
# -------------------------------------------------------------------------
# Plot pseudobulk matrices vs. DE genes from subtypes in entorhinal cortex:
# Updated: 12/06/2021
# -------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load abundances data only and pseudobulk data:
# ----------------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, FALSE, TRUE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))

umeta = ps.data$meta
pmat = ps.data$mat
umeta = umeta[umeta$cell_type_high_resolution != 'Exc SOX11 NCKAP5',]
umeta = umeta[umeta$ncell > 10,]


# Load in regression results for subtypes:
# ----------------------------------------
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
topdegdf = read.delim(gzfile(topdeg.file), sep="\t")
topdegdf = topdegdf[order(topdegdf$log10p_nm, decreasing=T),]


# Select top DE genes:
# --------------------
path = 'nrad'
ntop = 30
subdf = topdegdf[topdegdf$path == path,]
upgene = head(subdf[subdf$col == 2, 'gene'], ntop)
dwgene = head(subdf[subdf$col == 1, 'gene'], ntop)


# Plot the differential genes on the pseudobulk matrices:
# -------------------------------------------------------
pgenes = c(upgene, dwgene)
pset = c(rep('Up',ntop), rep('Down',ntop))
use.norm=TRUE
smat = as.matrix(pmat[pgenes,umeta$ptype])

# Individual + CT annotations:
indmap = unique(metadata[,c('projid','cogdx','niareagansc', 'braaksc','nft_ec', 'nrad','cogdxad')])
rownames(indmap) = as.character(indmap$projid)
cn = sub("_EC$","",colnames(smat))
pids = sub("_.*","",cn)
pmeta = indmap[as.character(pids),]
cts = gsub("_"," ", sub(".*_Exc","Exc",cn))
ad.diff = ifelse(cts %in% topec[eid==1],'Depleted','No Change')
nft.col_fun = colorRamp2(range(pmeta$nft_ec), c("white", "indianred"))
if (path == 'cogdxad'){
    clsplit = paste0(pmeta$cogdxad, ", ", ad.diff)
} else {
    clsplit = paste0(pmeta$nrad, ", ", ad.diff)
}

full.projids = sort(unique(cellmeta$projid))
projid.cols = snap.cols[1:48]
names(projid.cols) = full.projids

ha = HeatmapAnnotation(AD.Diff=ad.diff, 
                       AD=pmeta$niareagansc,
                       COG=pmeta$cogdx,
                       CT=cts, 
                       Braak=pmeta$braaksc,
                       NFT=pmeta$nft_ec,
                       projid=as.character(pmeta$projid),
                       col=list(AD=colvals[['niareagansc']],
                                Braak=colvals[['braaksc']],
                                CT=type.cols[topec],
                                COG=colvals[['cogdx']],
                                projid=projid.cols,
                                NFT=nft.col_fun,
                                AD.Diff=c('Depleted'='slateblue',
                                          'No Change'='grey75')))

udsplit = pset
hb = rowAnnotation(Set=pset,
                   col=list(Set=c('Down'='blue','Up'='indianred')))

smat.scaled = t(scale(t(log(smat+1)), center=TRUE))
plt = Heatmap(smat.scaled, name='scaled\n logcounts', 
        use_raster=TRUE,
        top_annotation=ha, 
        column_split=clsplit, 
        show_column_names=FALSE,
        row_split=udsplit,
        right_annotation=hb)

h = 10
w = 18
pltprefix = paste0(imgpref, '_DEgenes_psbulk_heatmap_', path)
pdf(paste0(pltprefix, '.pdf'), width=w, height=h)
print(plt)
dev.off()
png(paste0(pltprefix, '.png'), res=400, units='in', width=w, height=h)
print(plt)
dev.off()

