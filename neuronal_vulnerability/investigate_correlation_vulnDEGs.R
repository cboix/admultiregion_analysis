#!/usr/bin/R
# --------------------------------------------------------------------------
# Follow up on cognitive impairment + CDK5R1/R2 as likely compositional DEGs
# for Exc TOX3 TTC6 and other EC neuronal subtypes
# Updated: 09/14/21
# --------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(Matrix)

# For nebula: 
library(nebula)
library(DESeq2)
library(RUVSeq)
library(qvalue)

# For plotting
library(ggplot2)
library(ggpubr)
library(ggrepel)
print(version)

celltype = 'Exc'
subtype = ec.exc.neurons
region = 'EC'

# Directories:
plotdir = paste0(imgdir, 'vuln/')
regdir = paste0(datadir,'dereg/')
imgpref = paste0(plotdir, 'EC_compDEGs_')
cmd = paste('mkdir -p', plotdir, regdir)
system(cmd)

# Load the expression data:
# -------------------------
commandArgs = function(x){ c('local') } # Load existing from local variable defs
source(paste0(sbindir, 'load_difftl_data.R'))


# Normalize:
# ----------
pctcut = 0.2
keep.genes = names(pctcells)[pctcells > pctcut]
keep.genes = keep.genes[grep("^RP[0-9]*-",keep.genes, invert=TRUE)] # Remove ribosomal genes
keep.genes = keep.genes[grep("^RP[SL]",keep.genes, invert=TRUE)]
mat = mat[keep.genes, pathdf$barcode]

norm = as.matrix(mat)
norm = sweep(norm, 2, colSums(norm) / 10000,'/')
norm = log(norm + 1)
gcout = gc()

pathdf$nc = paste0(pathdf$nrad, '-', pathdf$cogdxad)
pathdf$res = pathdf$nc == 'AD-CTRL'

# Read in the regression results:
# -------------------------------
path = 'nft'
prefstr = paste(celltype, subtype, region, path, sep="_")
outtsv = paste0(regdir, 'nebula_ruv.', prefstr,'.tsv.gz')
outrda = paste0(regdir, 'nebula_ruv.', prefstr,'.rda')
nsigfile = paste0(regdir, 'nebula_ruv.', prefstr,'.nsig.tsv')

load(outrda)
upgenes = head(fulldf[fulldf$col == 2,'gene'], 50)

adndf = c()
for (gene in upgenes){
    cind = mat[gene,pathdf$barcode] > 0
    pathdf$has.gene =  cind
    tab = table(pathdf[,c('res','has.gene')])
    tt = fisher.test(tab) # Signif.
    adndf = rbind(adndf,
                  data.frame(gene=gene, est=tt$estimate, p=tt$p.value))
}
adndf = adndf[order(adndf$p),]


# Split expression data by CDK5R1
# -------------------------------
gene = 'NEUROD2'
# gene = 'NCDN' 
cind = mat[gene,pathdf$barcode] > 0 # 63%
nind = mat[gene,pathdf$barcode] == 0 # 36.9%
pathdf$has.cdk5r1 =  cind

tab = table(pathdf[,c('nrad','has.cdk5r1')])
print(fisher.test(tab)) # Not signif.
tab = table(pathdf[,c('cogdxad','has.cdk5r1')])
print(fisher.test(tab)) # Signif.

pathdf$nc = paste0(pathdf$nrad, '-', pathdf$cogdxad)
tab = table(pathdf[,c('nc','has.cdk5r1')])
pathdf$res = pathdf$nc == 'AD-CTRL'
tab = table(pathdf[,c('res','has.cdk5r1')])
print(fisher.test(tab)) # Signif.



# Split into two + perform wilcoxon:
print("[STATUS] Running Wilcoxon test")
# NOTE: May not be able to fit into memory as matrix if huge.

# Running both at individual level and cell level, aggregate:
udf = unique(pathdf[,c('projid',path)])
rownames(udf) = udf$projid
pids = as.character(unique(pathdf$projid))
c.tform = make.tform(pathdf$projid[cind], u=pids, norm=TRUE)
n.tform = make.tform(pathdf$projid[nind], u=pids, norm=TRUE)
cavg.nmat = norm[,pathdf$barcode[cind]] %*% c.tform
navg.nmat = norm[,pathdf$barcode[nind]] %*% n.tform



path = 'cogdxad'
# Splits for different variables:
adid = which(pathdf[path] == 'AD')
ctid = which(pathdf[path] == 'CONTROL')

# Wilcoxon at cell level:
fulldf = c()
for (gene in keep.genes){
    # Cell level:
    xi = norm[gene,adid]
    xo = norm[gene,ctid]
    cp = wilcox.test(xi, xo)$p.value
    # Individual level:
    xi.ind = avg.nmat[gene,adid.ind]
    xo.ind = avg.nmat[gene,ctid.ind]
    ip = wilcox.test(xi.ind, xo.ind)$p.value
    # Collate:
    fulldf = rbind(fulldf, data.frame(gene=gene,
                                      AD = mean(xi), CTRL=mean(xo), 
                                      # e4=mean(xi), e3=mean(xo), 
                                      p_cell=cp, p_ind=ip))
}
