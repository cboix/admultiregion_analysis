#!/usr/bin/R
# ----------------------------------------------------------------------------
# Investigate the co-variation of selective vulnerability in EC/HC and others:
# TODO: Neurons alone and neurons + glia
# Updated 12/21/2021 to perform beta regression
# ----------------------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(betareg)

library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

library(ComplexHeatmap)
library(circlize)

# Directories:
plotdir = paste0(imgdir, 'vuln/')
fracdir = paste0(sdbdir, 'fractions/')
imgpref = paste0(plotdir, 'conn_')
cmd = paste('mkdir -p', imgdir, plotdir)
system(cmd)

# --------------------------------------
# Select neuronal subtypes in EC and HC:
# --------------------------------------
rdf = agg.rename(barcode ~ region + cell_type_high_resolution, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'count')
rdf = spread(rdf, region, count, fill=0)
rmat = as.matrix(rdf[,-1])
rownames(rmat) = rdf[,1]
topec = apply(rmat,1, max) == rmat[,'EC']
topec = names(topec)[topec]
topec = topec[topec != 'Exc SV2C LINC02137']
tophc = apply(rmat,1, max) == rmat[,'HC']
tophc = names(tophc)[tophc]

# ---------------------------------------------
# Get the relative abundances for all subtypes:
# ---------------------------------------------
totdf = agg.rename(barcode ~ projid + region, cellmeta, length, 'total')
etotdf = agg.rename(barcode ~ projid + region, cellmeta[cellmeta$major.celltype == 'Exc',], length, 'exc.total')

# analysis = 'NEU'
analysis = 'ECHC'
# analysis = 'All'
if (analysis == 'ECHC'){
    submeta = cellmeta[cellmeta$major.celltype == 'Exc' & cellmeta$region %in% c('EC', 'HC'),]
    ctdf = agg.rename(barcode ~ projid + region + cell_type_high_resolution, submeta, length, 'count')
    combdf = expand.grid(cell_type_high_resolution=unique(submeta$cell_type_high_resolution), region=unique(submeta$region), projid=unique(submeta$projid))
} else if (analysis =='NEU'){
    submeta = cellmeta[cellmeta$major.celltype == 'Exc',]
    ctdf = agg.rename(barcode ~ projid + region + cell_type_high_resolution, submeta, length, 'count')
    combdf = expand.grid(cell_type_high_resolution=unique(submeta$cell_type_high_resolution), region=unique(submeta$region), projid=unique(submeta$projid))
} else {
    ctdf = agg.rename(barcode ~ projid + region + major.celltype, cellmeta, length, 'count')
    combdf = expand.grid(major.celltype=unique(cellmeta$major.celltype), region=unique(cellmeta$region), projid=unique(cellmeta$projid))
}

ctdf = merge(ctdf, combdf, all.y=TRUE)
ctdf$count[is.na(ctdf$count)] = 0
ctdf = merge(ctdf, totdf) # Removes a couple missing projid x region comb.
ctdf = merge(ctdf, etotdf)
ctdf$other = ctdf$total - ctdf$count
names(ctdf)[3] = 'celltype'
ctdf$frac = ctdf$count / ctdf$total

if (analysis == 'ECHC'){
    df1 = ctdf[ctdf$celltype %in% topec & ctdf$region == 'EC',]
    df2 = ctdf[ctdf$celltype %in% tophc & ctdf$region == 'HC',]
    df1 = rbind(df1, df2)
} else {
    df1 = ctdf
}

if (analysis == 'ECHC'){
    cwide = spread(df1[,c('projid','celltype','frac')], celltype, frac)
    cmat = as.matrix(cwide[,2:ncol(cwide)])
    cdf = cwide[,c('projid'), drop=F]
    cdf = merge(cdf, unique(metadata[,c('projid','msex','age_death','pmi','Apoe_e4','nrad','cogdxad')]))
    rownames(cmat) = cwide$projid
    rownames(cdf) = cdf$projid
} else {
    cwide = spread(df1[,c('projid','region','celltype','frac')], celltype, frac)
    cmat = as.matrix(cwide[,3:ncol(cwide)])
    cdf = cwide[,c('projid','region')]
    cdf = merge(cdf, unique(metadata[,c('projid','msex','age_death','pmi','Apoe_e4', 'nrad','cogdxad')]))
    rownames(cmat) = paste0(cwide$projid, '_', cwide$region) # + region.
    rownames(cdf) = paste0(cdf$projid, '_', cdf$region) # + region.
}
keepind = rownames(cmat)[!(is.na(apply(cmat, 1, sum)))]
cdf = cdf[keepind,]
cmat = cmat[keepind,]
# Reorder for plotting:
if (analysis == 'ECHC'){ cmat = cmat[,c(topec, tophc)] }


# Run regressions if not already computed:
# ----------------------------------------
use.adonly = TRUE
use.betareg = TRUE

suffix = analysis
if (use.betareg){ suffix = paste0(suffix, '_betareg') }
if (use.adonly){ suffix = paste0(suffix, '_adonly') }

conn.reg.tsv = paste0(fracdir, 'connectivity_regressions_', suffix, '.tsv')
conn.reg.file = paste0(fracdir, 'connectivity_regressions_', suffix, '.rda')

if (!file.exists(conn.reg.file)){
    # Initialize regression + cor.test outputs:
    # -----------------------------------------
    NC = ncol(cmat)
    dn = list(colnames(cmat), colnames(cmat))
    cr1mat = matrix(0, nrow=NC, NC, dimnames=dn)
    p1mat = matrix(0, nrow=NC, NC, dimnames=dn)
    conndf = c()

    # Run regressions on each pair:
    # -----------------------------
    for (i in 1:NC){
        for (j in 1:NC){
            # 1: Correlation test (using ranked test for percentages):
            if (use.adonly){ ind = (cdf$nrad == 'AD') } else { ind = 1:nrow(cdf) }
            ct = cor.test(cmat[ind,i], cmat[ind,j], method='kendall')
            p1mat[i,j] = ct$p.value
            cr1mat[i,j] = ct$estimate
            # 2: Regression:
            if (use.betareg){
                # Add offset for beta regression to be in (0,1)
                cdf$ci = cmat[,i] + 1e-3
                cdf$cj = cmat[,j] + 1e-3
            } else {
                # Log transform for low percentages (othw. logit)
                cdf$ci = log10(cmat[,i] + 1e-3)
                cdf$cj = log10(cmat[,j] + 1e-3)
            }
            fracform = as.formula('ci ~ cj + msex + Apoe_e4 + pmi + age_death')
            if (use.betareg){
                fit = betareg(fracform, cdf[ind,])
                cfit = coefficients(summary(fit))$mean
                colnames(cfit) = c('est','SE','z','p')
            } else {
                fit = lm(fracform, cdf[ind,])
                cfit = coefficients(summary(fit))
                colnames(cfit) = c('est','SE','t','p')
            }
            out = cfit['cj',]
            out$cti = colnames(cmat)[i]
            out$ctj = colnames(cmat)[j]
            out$i = i
            out$j = j
            conndf = rbind(conndf, data.frame(out))
        }
    }
    conndf$padj = p.adjust(conndf$p, 'fdr')
    conndf = conndf[order(conndf$p),]

    cr2mat = matrix(1, NC, NC, dimnames=dn)
    p2mat = matrix(1, NC, NC, dimnames=dn)
    cr2mat[as.matrix(conndf[,c('i','j')])] = conndf$est
    p2mat[as.matrix(conndf[,c('i','j')])] = conndf$padj

    save(conndf, cr1mat, p1mat, cr2mat, p2mat, file=conn.reg.file)
    write.table(conndf, conn.reg.tsv, quote=F, row.names=F, sep="\t")
} else {
    load(conn.reg.file)
}

col_fun = colorRamp2(c(-.5, 0, .5), c('blue', 'white', 'red'))
# col_fun = colorRamp2(c(-1, 0, 1), c('blue', 'white', 'red'))

plt = Heatmap(cr1mat,
              use_raster=TRUE,
              cluster_columns=FALSE, 
              cluster_rows=FALSE, 
              col=col_fun,
              column_split=ifelse(colnames(cmat) %in% tophc, 'Hippocampus','Entorhinal Cortex'),
              row_split=ifelse(colnames(cmat) %in% tophc, 'Hippocampus','Entorhinal Cortex'),
              width = ncol(cr1mat)*unit(5, "mm"), 
              height = nrow(cr1mat)*unit(5, "mm"),
              rect_gp = gpar(type = "none"), column_dend_side = "bottom",
              cell_fun = function(j, i, x, y, w, h, fill) {
                  cond1 = (as.numeric(x) > 1 - as.numeric(y) + 1e-6)
                  cond2 = (i <= length(topec) & j > length(topec))
                  cond3 = (i > length(topec) & j <= length(topec))
                  if((cond1 | cond2) & (!cond3)) {
                      grid.rect(x, y, w, h, gp = gpar(fill = fill, col = fill))
                      if (i != j){
                          p = p2mat[i,j] # Adjusted p-values from regression.
                          ann = ifelse(p < 0.05, ifelse(p < 0.01, ifelse(p < 0.001, '***','**'),'*'),'')
                          grid.text(ann, x, y)
                      }
                  }
              })


# Correlation + p-value from regression accounting for covariates
pltprefix = paste0(imgpref, 'correlation_regrpvals_', suffix, '_heatmap')
pdf(paste0(pltprefix, '.pdf'), width=7, height=6)
print(plt)
dev.off()
png(paste0(pltprefix, '.png'), units='in', res=400, width=7, height=6)
print(plt)
dev.off()



# Plot the top correlated neuronal subtypes across regions:
# ---------------------------------------------------------
# TODO: Plot both full + colored by AD status:
# TODO: Extend for all NEU subtypes:
conndf$regi = ifelse(conndf$cti %in% topec, 'EC', 'HC')
conndf$regj = ifelse(conndf$ctj %in% topec, 'EC', 'HC')
crossdf = conndf[conndf$regi != conndf$regj,]
crossdf[crossdf$cti %in% 'CA1 pyramidal cells',]
crossdf[crossdf$ctj %in% 'Exc AGBL1 GPC5',]
crossdf[crossdf$cti %in% 'Exc AGBL1 GPC5',]

pairlist = list(c('Exc TOX3 TTC6', 'CA1 pyramidal cells'),
                c('Exc TOX3 TTC6', 'CA2, CA3 pyramidal cells'),
                c('Exc TOX3 TTC6', 'Exc GRIK1 CTXND1 (Subiculum)'),
                c('Exc RELN COL5A2', 'CA1 pyramidal cells'),
                c('Exc RELN COL5A2', 'CA2, CA3 pyramidal cells'),
                c('Exc RELN GPC5', 'CA1 pyramidal cells'),
                c('Exc RELN GPC5', 'CA2, CA3 pyramidal cells'),
                c('CA1 pyramidal cells', 'Exc AGBL1 GPC5'),
                c('Exc GRIK1 CTXND1 (Subiculum)', 'Exc AGBL1 GPC5'),
                c('Exc RELN GPC5', 'Exc AGBL1 GPC5'),
                c('Exc RELN COL5A2', 'Exc AGBL1 GPC5'))

for (pair in pairlist){
    c1 = pair[1] 
    c2 = pair[2]
    suffstr = gsub(" ", "_", paste0(c1, '_vs_', c2))
    print(suffstr)
    cdf$ci = cmat[,c1] + 1e-3
    cdf$cj = cmat[,c2] + 1e-3

    gp = ggplot(cdf, aes(ci, cj, color=nrad)) + 
        geom_point() + 
        scale_color_manual(values=colvals[['nrad']]) + 
        geom_smooth(method='lm') + 
        scale_y_log10(labels=scales::percent) +
        scale_x_log10(labels=scales::percent) +
        # scale_y_continuous(labels=scales::percent) +
        # scale_x_continuous(labels=scales::percent) +
        stat_cor(method='kendall') + 
        # stat_cor(method='kendall', color='black') + 
        labs(x=c1, y=c2) + 
        theme_pubr()
    pltprefix = paste0(imgpref, 'example_', suffstr, '_scatter')
    ggsave(paste0(pltprefix, '.pdf'), units='in', width=3, height=3)
}


