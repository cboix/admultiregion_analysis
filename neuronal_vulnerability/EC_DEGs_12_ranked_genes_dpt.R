#!/usr/bin/R
# -------------------------------------------------------
# Plots on the ranked genes from the branched pseudotime:
# Updated: 03/06/2022
# -------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)

library(ComplexHeatmap)
library(circlize)
options(width=175)

# Directories:
pstdir = paste0(sdbdir, 'pseudotime/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'detraj_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load the gene rankings for the trajectory:
# ------------------------------------------
rankfile = paste0(pstdir, 'gene_scores_integrated_detraj.tsv')
df = read.delim(rankfile, sep="\t")

dfwide = spread(df[,c('gene','group','max')], group, max)

head(dfwide[order(dfwide$top, decreasing=T),], 50)
head(dfwide[order(dfwide$bottom, decreasing=T),], 50)


# Read in the GAM predictions:
# ----------------------------
genes = scan(paste0(pstdir, 'gene_order.txt'), 'c', quiet=TRUE)
pmat = read.delim(paste0(pstdir, 'gene_prediction_matrix.tsv'), header=F, sep="\t")
pmat = as.matrix(pmat)
rownames(pmat) = genes
topmat = pmat[, 1:100]
botmat = pmat[, 101:200]


# Plot these predictions:
# -----------------------
ntop = 50
ttop = head(dfwide[order(dfwide$top, decreasing=T),'gene'], ntop)
btop = head(dfwide[order(dfwide$bottom, decreasing=T),'gene'], ntop)
load.colors()

group = 'top'
if (group == 'top'){
    pltmat = topmat[ttop,]
} else { 
    pltmat = botmat[btop,]
}

pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')

ux = 1.5
ht = Heatmap(pltmat, 
    use_raster=TRUE, 
    width=ncol(pltmat) * unit(ux / 4, 'mm'),
    height=nrow(pltmat) * unit(ux, 'mm'),
    cluster_columns=FALSE,
    show_column_names=FALSE,
    border_gp=gpar(lwd=.5, color='black'),
    col=rev(colspec))
    # col=viridis(100))
    # rev(colrb))

pltprefix = paste0(imgpref, 'rankedgenes_', group, ntop, '_heatmap')
w = 2 + ncol(pltmat) / 15
h = 2 + nrow(pltmat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)


# Genes where max is in the middle:
# ---------------------------------
group = 'bottom'
if (group == 'top'){
    usemat = topmat
} else { 
    usemat = botmat
}
mpt = apply(usemat, 1, which.max)
midgenes = names(which(mpt > 20 & mpt < 80))
mdf = merge(dfwide, data.frame(gene=names(mpt), mpt=mpt))
mdf$set = ifelse(mdf$mpt > 20, ifelse(mdf$mpt < 80, 'mid', 'top'), 'bot')
mdf$set = round(mdf$mpt / 10, 0)

# Plot top from each set:
ntop = 10
mdf = mdf[order(mdf[[group]], decreasing=T),]
setgenes = sapply(unique(mdf$set), function(x){head(mdf$gene[mdf$set == x], ntop)})
setgenes = c(unlist(setgenes))
rownames(mdf) = mdf$gene
ord = order(mdf[setgenes, 'mpt'])
pltmat = usemat[setgenes[ord],]
# pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
# pltmat = t(scale(t(pltmat)))

ux = 1.5
ht = Heatmap(pltmat, 
    use_raster=TRUE, 
    width=ncol(pltmat) * unit(ux / 4, 'mm'),
    height=nrow(pltmat) * unit(ux, 'mm'),
    cluster_columns=FALSE,
    cluster_rows=FALSE,
    show_column_names=FALSE,
    border_gp=gpar(lwd=.5, color='black'),
    col=rev(colspec))
    # col=viridis(100))
    # rev(colrb))

pltprefix = paste0(imgpref, 'rankedgenes_', group, ntop, '_setgenes_heatmap')
w = 2 + ncol(pltmat) / 15
h = 2 + nrow(pltmat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)


# Plot gene fits with lineplots:
# ------------------------------
pwide = data.frame(usemat)
pmap = 1:ncol(pwide)
names(pmap) = colnames(pwide)
pwide$gene = rownames(usemat)
plong = gather(pwide, cn, value, -gene)
plong$pos = pmap[plong$cn]

logfc = log2(apply(usemat, 1, max) / (apply(usemat, 1, min) - min(usemat) + 1e-4))
mdf$logFC = logfc[mdf$gene]
mdf$logFC[mdf$logFC > 5] = 5
mdf$dir.logFC = mdf$logFC * (2 * (mdf$mpt > 50) - 1)

labdf = head(mdf, 100)
ggplot(mdf, aes_string('dir.logFC', group, color='mpt')) + 
    geom_point() + 
    geom_text(data=labdf, aes_string('dir.logFC', group, label='gene')) + 
    theme_pubr()

# ntop = 100
# topgenes = head(dfwide$gene[order(dfwide[[group]], decreasing=T)], ntop)

selgenes = head(mdf[mdf$logFC > 1,'gene'], 100)
subdf = plong[plong$gene %in% selgenes,]

ggplot(subdf, aes(pos, value, color=gene)) + 
    geom_line() + 
    theme_pubr()
    # theme(legend.position='none')


# Number crunching:
# TODO: REMOVE, not relevant here
# -----------------
# Check proportion of excitatory - inhibitory:
ctmat = table(cellmeta[,c('major.celltype','region')])
ctmat['Exc',] / ctmat['Inh',]
      # AG       EC       HC       MT      PFC       TH 
# 2.912938 1.963658 3.714493 2.602689 2.783395 3.063365 

submeta = cellmeta[cellmeta$major.celltype == 'Mic/Immune',]
ctmat = table(submeta[,'cell_type_high_resolution'])
ctmat / sum(ctmat)



