#!/usr/bin/R
# ------------------------------
# Estimate depletion quantities:
# Updated: 12/06/2021
# ------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)

# Directories:
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'metadata/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)


# Load abundances data only (1st arg):
# ------------------------------------
commandArgs <- function(trailingOnly=TRUE){c(TRUE, FALSE, FALSE)}
source(paste0(sbindir, 'neuronal_vulnerability/load_EC_data.R'))

# Load abundances from multiple:
sets = c('ECneurons','HCneurons','THneurons')
full.ctdf = NULL
for (runset in sets){
    commandArgs <- function(trailingOnly=TRUE){c(runset, remove.batches)}
    source(paste0(sbindir, 'metadata_markers/load_proportions_data.R'))
    full.ctdf = rbind(full.ctdf, ctdf)
}
ctdf = full.ctdf


# Make more systematic calls of what is signif vs. not:
# -----------------------------------------------------
mfracdf = aggregate(cbind(count, total) ~ region + cls + nrad, ctdf, sum)
mfracdf$tot.frac = mfracdf$count / mfracdf$total

ctdf$frac = ctdf$count / ctdf$total
ctdf = merge(ctdf, pqdf, all.x=TRUE)  # TODO: Should we do log1p NFT, etc?
ctdf = merge(ctdf, mfracdf[mfracdf$nrad == 'CTRL',c('region','cls','tot.frac')])
ctdf$rel.frac = ctdf$frac / ctdf$tot.frac
ctdf$rel.frac[ctdf$tot.frac == 0] = 0
subtypes = unique(ctdf$cls)
frac.regdf = c()  # NOTE: Should we do a quasibinomial model instead?

for (subtype in subtypes){
    cat(subtype)
    subdf = ctdf[ctdf$cls == subtype,]
    for (region in unique(subdf$region)){
        cat('\t', region)
        fit1 = lm(frac ~ nrad, subdf[subdf$region == region,])
        fit1b = lm(rel.frac ~ nrad, subdf[subdf$region == region,])
        if (region != 'TH'){
            fit2 = lm(frac ~ nft, subdf[subdf$region == region,])
            fit2b = lm(rel.frac ~ nft, subdf[subdf$region == region,])
            cfit2 = coefficients(summary(fit2))
            cfit2b = coefficients(summary(fit2b))
        }
        fit3 = lm(frac ~ cogdxad, subdf[subdf$region == region,])
        fit3b = lm(rel.frac ~ cogdxad, subdf[subdf$region == region,])
        cfit1 = coefficients(summary(fit1))
        cfit1b = coefficients(summary(fit1b))
        cfit3 = coefficients(summary(fit3))
        cfit3b = coefficients(summary(fit3b))
        if (region != 'TH'){
            df = data.frame(rbind(cfit1['nradAD',c(1,4)], cfit1b['nradAD',c(1,4)], 
                                  cfit2['nft',c(1,4)], cfit2b['nft',c(1,4)],
                                  cfit3['cogdxadAD',c(1,4)], cfit3b['cogdxadAD',c(1,4)]))
            df$reg = c('nrad','nrad.rel', 'nft', 'nft.rel','cogdxad','cogdxad.rel')
        } else {
            df = data.frame(rbind(cfit1['nradAD',c(1,4)], cfit1b['nradAD',c(1,4)], 
                                  cfit3['cogdxadAD',c(1,4)], cfit3b['cogdxadAD',c(1,4)]))
            df$reg = c('nrad','nrad.rel', 'cogdxad','cogdxad.rel')
        }
        colnames(df) = c('Est','p','reg')
        df$cls = subtype
        df$region = region
        frac.regdf = rbind(frac.regdf, df)
    }
    cat('\n')
}

rdf = frac.regdf[frac.regdf$reg == 'nrad',]
rdf = frac.regdf[frac.regdf$reg == 'nft',]
rdf = frac.regdf[frac.regdf$reg == 'nft.rel',]
rdf = rdf[order(-abs(rdf$Est)),]

rdf = frac.regdf[frac.regdf$reg == 'cogdxad',]
rdf = rdf[order(rdf$p),]
rdf = frac.regdf[frac.regdf$reg == 'cogdxad.rel',]
rdf = rdf[order(-abs(rdf$Est)),]


# Save this table:
# ----------------
frac.reg.file = paste0(fracdir, 'estimated_fraction_changes_ECneurons.tsv')
write.table(frac.regdf, frac.reg.file, quote=F, row.names=F, sep="\t")


