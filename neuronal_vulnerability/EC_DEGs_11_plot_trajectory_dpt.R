#!/usr/bin/R
# -------------------------------------------------------
# Plots for the integrated neuronal trajectory from DEGs
# Focusing on DPT pseudotime
# Updated: 03/02/2022
# -------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggridges)

library(ComplexHeatmap)
library(circlize)
options(width=175)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'detraj_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load the metadata for the DE trajectory:
# ----------------------------------------
usefull = TRUE
if (usefull){
    useprefix = 'testedgenes_combat'
} else {
    useprefix = 'DEGpartitions_combat'
}
imgpref = paste0(plotdir, 'detraj_', useprefix, '_')
df.pref = paste0(sdbdir, 'multiregion_majorctUMAP_Exc_log1p_')
df.file = paste0(df.pref, useprefix, '_subsetUMAP.tsv')

df = read.delim(df.file, header=T)
keep.cols = c('barcode', 'projid', 'region', 'celltype', 'C1','C2',
    'dpt_pseudotime','leiden', 'nft','plaq_n','plaq_d','cogdxad','nrad', 'niareagansc', 'braaksc')
# df = df[,keep.cols]
gc()
xlim=range(df$C1)
ylim=range(df$C2)

if (usefull){
    y = max(df$C2) - df$C2
    df$dpt_pseudotime = y / max(y)
}


# Remove clusters that are highly enriched:
cmat = table(df[,c('projid','leiden')])
cmarg = apply(cmat, 2, function(x){max(x) / sum(x)})
keep.leiden = names(cmarg)[cmarg < 0.15]
keep.leiden = keep.leiden[keep.leiden != 5]
df = df[df$leiden %in% keep.leiden,]

# Also remove the PFC data in 7:
ind = ((df$projid == '98953007') & (df$leiden == '7') & (df$region == 'PFC'))
df = df[!ind,]


# Split into groups and find the endpoints:
# -----------------------------------------
C1med = median(df$C1)
df$group = ifelse(df$C1 <= C1med, 'left', 'right')
xr = diff(range(df$C1)) / 200
yr = diff(range(df$C2)) / 200


# NOTE: these points aren't better than just taking the top/bottom pseudotime.
# Left side:
ldf = df[(df$group == 'left') & (df$C1 > C1med - xr),]
C2m = max(ldf$C2)
ldf = ldf[(ldf$C2 < (C2m + yr)) & (ldf$C2 > (C2m - yr)),]
lstart = as.numeric(head(ldf[order(ldf$C1, decreasing=T), c('C1','C2')], 1))
ldf = df[df$group == 'left',]
ldist = sweep(as.matrix(ldf[,c('C1','C2')]), 2, lstart, '-')
ldist = apply(ldist**2, 1, sum)
lend = as.numeric(ldf[which.max(ldist), c('C1','C2')])

# Right side:
ldf = df[(df$group == 'right') & (df$C1 < C1med + xr),]
C2m = max(ldf$C2)
ldf = ldf[(ldf$C2 < (C2m + yr)) & (ldf$C2 > (C2m - yr)),]
rstart = as.numeric(head(ldf[order(ldf$C1, decreasing=T), c('C1','C2')], 1))
ldf = df[df$group == 'right',]
ldist = sweep(as.matrix(ldf[,c('C1','C2')]), 2, rstart, '-')
ldist = apply(ldist**2, 1, sum)
rend = as.numeric(ldf[which.max(ldist), c('C1','C2')])

pts = rbind(lend, rend, lstart, rstart)


# Write out groups:
group.file = paste0(df.pref, useprefix, '_subsetUMAP_branches.tsv')
write.table(df[,c('barcode','group', 'C2')], file=group.file, quote=F, row.names=F, sep="\t")


# Plot the umap, with appropriate proportions:
# --------------------------------------------
palette = viridis(100)
col_fun = function(x, pal=palette, mx=NULL){
    if (is.null(mx)){mx=max(x)} else {x[x > mx] = mx}
    bin <- cut(x, seq(0, mx, length.out=length(palette)), include.lowest=T) 
    palette[bin]  }

cex = 0.025
sp = 0.1
w=1; h=1


# Plot dividing line:
path = 'dpt_pseudotime'
ind = which(!is.na(df[[path]]))
ind = ind[order(df[ind,path])]
png(paste0(imgpref, 'umap_line_', path, '.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(df$C1[ind], df$C2[ind],
    col=col_fun(df[ind, path]), pch='.', cex=cex, axes=F,
    xlim=xlim, ylim=ylim)
abline(v=C1med, col='black', lty='dotted')
# points(pts[,1], pts[,2], pch=19, col='black', cex=.5)
dev.off()


# Alternatively, trajectory between bottom clusters:
# --------------------------------------------------
df2 = read.delim(df.file, header=T)
subdf = df2[df2$leiden %in% c('1','2','5'),]

# Plot dividing line:
path = 'transition_pseudotime'
path = 'C1'
ind = which(!is.na(subdf[[path]]))
ind = ind[order(subdf[ind,path])]
png(paste0(imgpref, 'umap_line_', path, '.png'), units='in', res=450, width=w, height=h)
par(xaxs='i',yaxs='i')
par(mar=rep(sp,4))
plot(subdf$C1[ind], subdf$C2[ind], col=col_fun(subdf[ind, path]),
    pch='.', cex=cex, axes=F, xlim=xlim, ylim=ylim)
abline(v=C1med, col='black', lty='dotted')
dev.off()


# Plot the individual density plots on these branches:
# ----------------------------------------------------
# Get color mappings for projid, celltype:
cmapdf = unique(df[,c('projid','cogdxad')])
cog.cols = colvals[['cogdxad']][cmapdf$cogdxad]
names(cog.cols) = cmapdf$projid
df$pst = max(df$C2) - df$C2
df$pst = df$pst / max(df$pst)

subdf$pst = subdf$C1 / max(subdf$C1)

# TODO: Color celltype by vulnerability instead
nvdir = paste0(sbindir, 'neuronal_vulnerability/')
source(paste0(nvdir, 'load_exc_OR_estimates.R'))
path = 'braaksc.ad'
sub.qbdf = getqb(path)

sub.tcols = tcols[sort(unique(df$celltype))]

for (group in c('left', 'right')){
    gdf = df[df$group == group,]
    paggdf = aggregate(pst ~ projid, gdf, mean)
    proj.lvls = paggdf[order(paggdf$pst), 'projid']
    gdf$projid = factor(gdf$projid, levels=proj.lvls)
    gp = ggplot(gdf, aes(x=pst, y=factor(projid), fill=factor(cogdxad))) + 
        geom_density_ridges() +
        scale_x_continuous(expand = c(0, 0)) +
        scale_y_discrete(expand = c(0, 0)) +
        scale_fill_manual(values=colvals[['cogdxad']], name='Cogn. Imp.') +
        coord_cartesian(clip = "off") + 
        labs(x='Pseudotime', y='Individual') + 
        theme_pubr() + theme(legend.position='right')
        # theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
    saveGGplot(gp, paste0(imgpref, 'density_', group, '_projid'), w=5, h=7)

    paggdf = aggregate(pst ~ celltype, gdf, mean)
    ct.lvls = paggdf[order(paggdf$pst), 'celltype']
    gdf$celltype= factor(gdf$celltype, levels=ct.lvls)
    gp = ggplot(gdf, aes(x=pst, y=factor(celltype), fill=celltype)) + 
        geom_density_ridges() +
        scale_x_continuous(expand = c(0, 0)) +
        scale_y_discrete(expand = c(0, 0)) +
        # scale_fill_manual(values=colvals[['cogdxad']], name='Cogn. Imp.') +
        scale_fill_manual(values=sub.tcols) +
        coord_cartesian(clip = "off") + 
        labs(x='Pseudotime', y='Excitatory Subtype') + 
        theme_pubr() + theme(legend.position='none')
        # theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
    saveGGplot(gp, paste0(imgpref, 'density_', group, '_celltype'), w=5.75, h=7)
}

gdf = subdf
paggdf = aggregate(pst ~ projid, gdf, mean)
proj.lvls = paggdf[order(paggdf$pst), 'projid']
gdf$projid = factor(gdf$projid, levels=proj.lvls)
gp = ggplot(gdf, aes(x=pst, y=factor(projid), fill=factor(cogdxad))) + 
    geom_density_ridges() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_discrete(expand = c(0, 0)) +
    scale_fill_manual(values=colvals[['cogdxad']], name='Cogn. Imp.') +
    coord_cartesian(clip = "off") + 
    labs(x='Pseudotime', y='Individual') + 
    theme_pubr() + theme(legend.position='right')
    # theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
saveGGplot(gp, paste0(imgpref, 'density_horiz_projid'), w=5, h=7)

gdf = subdf
paggdf = aggregate(pst ~ celltype, gdf, mean)
ct.lvls = paggdf[order(paggdf$pst), 'celltype']
gdf$celltype= factor(gdf$celltype, levels=ct.lvls)
gp = ggplot(gdf, aes(x=pst, y=factor(celltype), fill=celltype)) + 
    geom_density_ridges() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_fill_manual(values=sub.tcols) +
    scale_y_discrete(expand = c(0, 0)) +
    coord_cartesian(clip = "off") + 
    labs(x='Pseudotime', y='Excitatory Subtype') + 
    theme_pubr() + theme(legend.position='none')
# theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
saveGGplot(gp, paste0(imgpref, 'density_horiz_celltype'), w=5.75, h=7)


# Average at the region level, plot the region boxplots for each:
# ---------------------------------------------------------------
subdf$group = 'horizontal'
horiz.group.file = paste0(df.pref, useprefix, '_subsetUMAP_horiz.tsv')
write.table(subdf[,c('barcode','group', 'C1')], file=horiz.group.file, quote=F, row.names=F, sep="\t")


aggdf = aggregate(pst ~ region + group + projid, df, mean)
aggdf = rbind(aggdf, 
    aggregate(pst ~ region + group + projid, subdf, mean))

gp = ggplot(aggdf, aes(x=pst, y=region, fill=region)) + 
    facet_wrap(~group, nrow=1) + 
    geom_density_ridges() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_fill_manual(values=reg.cols) +
    scale_y_discrete(expand = c(0, 0)) +
    coord_cartesian(clip = "off") + 
    labs(x='Pseudotime', y='Excitatory Subtype') + 
    theme_pubr() + theme(legend.position='none')
# theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
saveGGplot(gp, paste0(imgpref, 'density_region_projid_avg'), w=8, h=2.5)


keycols = c('pst','region','projid','group', 'braaksc')
fulldf = rbind(df[,keycols], subdf[,keycols])
gp = ggplot(fulldf, aes(x=pst, y=region, fill=region)) + 
# gp = ggplot(fulldf, aes(x=pst, y=factor(braaksc))) + 
    facet_wrap(~group, nrow=1) + 
    geom_density_ridges() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_fill_manual(values=reg.cols) +
    scale_y_discrete(expand = c(0, 0)) +
    coord_cartesian(clip = "off") + 
    labs(x='Pseudotime', y='Excitatory Subtype') + 
    theme_pubr() + theme(legend.position='none')
# theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
saveGGplot(gp, paste0(imgpref, 'density_region_projid_avg'), w=8, h=2.5)


# aggdf = 
gp = ggplot(aggdf, aes(x=factor(projid), y=pst, color=region)) + 
    facet_wrap(~group, nrow=1) + 
    geom_point() + coord_flip() + 
    # scale_x_continuous(expand = c(0, 0)) +
    scale_color_manual(values=reg.cols) +
    # scale_y_discrete(expand = c(0, 0)) +
    # coord_cartesian(clip = "off") + 
    labs(x='Pseudotime', y='Excitatory Subtype') + 
    theme_pubr() + theme(legend.position='none')
# theme_ridges(grid = FALSE, center_axis_labels = TRUE) 
saveGGplot(gp, paste0(imgpref, 'density_region_projid_avg'), w=8, h=5)


# Plot region average as heatmap:
# -------------------------------
aggdf$rg = paste0(aggdf$region , '_', aggdf$group)
amat = pivot.tomatrix(aggdf[,c('rg','projid','pst')], 'projid','pst')

umeta = unique(metadata[metadata$region == 'PFC',
    c('projid','nrad','cogdxad','cogdx', 'niareagansc', 'age_death',
        'msex', 'braaksc', 'Apoe_e4','gpath','tangles','amyloid', 'cogn_global_lv')])
rownames(umeta) = umeta$projid
umeta = umeta[as.character(colnames(amat)),]

age.col_fun = colorRamp2(range(umeta$age_death), c("white", "slateblue")) 
pmi.col_fun = colorRamp2(c(2, 15), c("white", "indianred")) 
gpath.col_fun = colorRamp2(c(0, max(umeta$gpath)), c("white", "indianred")) 
gcog.col_fun = colorRamp2(c(min(umeta$cogn_global_lv), max(umeta$cogn_global_lv)),
    c("red", 'white')) 
# mat.col_fun = colorRamp2(c(0, max(pmat, na.rm=T)), c("white", "blue")) 

# Make metadata annotation:
ux = 1.5
ha = HeatmapAnnotation(
    annotation_name_gp = gpar(fontsize=5),
    simple_anno_size = unit(ux, 'mm'),
    Sex=ifelse(umeta$msex == 0, 'female','male'), 
    # PMI=umeta$pmi,
    Age=umeta$age_death,
    Apoe_e4=umeta$Apoe_e4,
    GPath=umeta$gpath,
    Braak=umeta$braaksc,
    AD=umeta$niareagansc,
    Cognition=umeta$cogdx,
    GlobalCog=umeta$cogn_global_lv,
    col=list(AD=colvals[['niareagansc']],
        Apoe_e4=c('no'='grey95','yes'='grey70'),
        Age=age.col_fun,
        GPath=gpath.col_fun,
        GlobalCog=gcog.col_fun,
        # PMI=pmi.col_fun,
        Braak=colvals[['braaksc']],
        Cognition=colvals[['cogdx']],
        Sex=colvals[['sex']]), which='column')


ht = Heatmap(amat, 
    use_raster=FALSE, 
    width=ncol(amat) * unit(ux, 'mm'),
    height=nrow(amat) * unit(ux, 'mm'),
    cluster_rows=FALSE,
    cluster_columns=TRUE,
    row_split=sub('.*_', "", rownames(amat)),
    show_column_names=TRUE,
    border_gp=gpar(lwd=.5, color='black'),
    bottom_annotation=ha,
    # col=rev(colspec))
    col=viridis(100))
    # rev(colrb))

pltprefix = paste0(imgpref, 'heatmap_region_projid_avg')
w = 3 + ncol(amat) / 15
h = 3 + nrow(amat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)







# Load the full excitatory data (do on cluster):
# TODO: Load all from hdf5 rather than one by one from Rda?
# ----------------------------------------------
source(paste0(sbindir, 'auxiliary_pseudobulk_loading_fns.R'))
all.exc = unlist(exc.sets)
nmat = load_full_dataset('Exc', all.exc, reg.nomb)
rownames(df) = df$barcode
subdf = df[colnames(nmat),]


# Determine genes along either pseudotime trajectory:
# ---------------------------------------------------
group = 'bottom'
subdf = df[df$group == group,]
bcs = subdf$barcode
bcs = bcs[bcs %in% colnames(nmat)]
rownames(subdf) = subdf$barcode
subdf = subdf[bcs,]
submat = nmat[,bcs]
y = subdf$dpt_pseudotime

gene = 'PRNP'
cor(submat[gene, ], y)






