#!/usr/bin/R
# --------------------------------------------------------------
# Plot the two correlation scores + directionality
# Use this to partition neuronal DEGs
# Perform gene set enrichment on specific partitions
# Updated: 06/22/2023
# --------------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)
library(ggrastr)

library(ComplexHeatmap)
library(circlize)
options(width=150)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'ecDE_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Functions for enrichments later:
# --------------------------------
sources = c("GO:CC","GO:BP","GO:MF","REAC","WP","KEGG","CORUM")
sub.sources = c('REAC','WP','KEGG','CORUM')
runSingleGO = function(set, print.res=TRUE){
    gp2.result = gprofiler2::gost(set, organism='hsapiens',
        ordered_query=FALSE, multi_query=FALSE,
        sources = sources, evcodes=TRUE)
    gp2df = gp2.result$result
    gp2df = gp2df[order(gp2df$p_value),]
    if (print.res) {
        print(head(gp2df[gp2df$term_size < 500,], 25))
    }
    return(gp2df)
}


# Function to reduce enrichments by intersections:
jacc.vec = function(x, y){
    int = length(intersect(x,y))
    un = length(x) + length(y) - int
    return(int / un)
}

selGOterms = function(intlist, cutoff=0.75){
    # Separate to lists:
    intlist = lapply(intlist, function(x){ strsplit(x,",")[[1]] })
    NT = length(intlist)
    jmat = matrix(0, nrow=NT, ncol=NT)
    for (i in 1:NT){
        jmat[i,] = sapply(1:NT, function(j){ jacc.vec(intlist[[i]], intlist[[j]]) })
    }
    # Select above cutoff, flag for removal:
    jmat = jmat - diag(diag(jmat))
    jdf = which(jmat >= cutoff, arr.ind=TRUE)
    jdf = jdf[jdf[,1] < jdf[,2],]
    # Greedy approach to remove:
    rmvec = c()
    for (k in 1:nrow(jdf)){
        if (!(jdf[k, 1] %in% rmvec)){
            rmvec = c(rmvec, jdf[k, 2])
        }
    }
    keep.ind = 1:NT
    keep.ind = keep.ind[!(keep.ind %in% rmvec)]
    return(keep.ind)
}


subsetGOterms = function(gp2df, cutoff=0.75, termsize=500, subsetsources=FALSE){
    subdf = gp2df[gp2df$term_size < termsize,]
    if (subsetsources){
        sub.sources = c('REAC','WP','KEGG','CORUM')
        subdf = subdf[subdf$source %in% sub.sources,]
    }
    subdf = subdf[order(subdf$p_value),]
    intlist = subdf$intersection
    keep.ind = selGOterms(intlist, cutoff=cutoff)
    return(subdf[keep.ind,])
}

reduceGeneList = function(x, ntop=8){
    x = strsplit(x, ',')[[1]]
    x = head(x, ntop)
    x = paste(x, collapse=',')
    return(x)
}

plotGObarplot = function(subdf, pltprefix, fill='grey50', ntop=20){
    subdf = unique(subdf[, c('p_value', 'term_name', 'source', 'intersection'), drop=F])
    subdf$lab = paste0(subdf$source, ": ", subdf$term_name)
    subdf = head(subdf, ntop)
    subdf$lab = factor(subdf$lab, levels=rev(subdf$lab))
    # Reduce the intersection term length
    subdf$int.short = sapply(subdf$intersection, reduceGeneList)
    gp = ggplot(subdf, aes(lab, -log10(p_value), label=int.short)) +
        geom_bar(stat='identity', fill=fill) +
        coord_flip() + geom_text(y=0.1, hjust=0) +
        labs(x='Enriched Term') +
        scale_y_continuous(expand=c(0,0)) +
        theme_pubr()
    h = .5 + nrow(subdf) / 4
    w = 10
    saveGGplot(gp, pltprefix, w=w, h=h)
    return(gp)
}


# Load in regression results for subtypes:
# ----------------------------------------
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
topdegdf = read.delim(gzfile(topdeg.file), sep="\t")
topdegdf = topdegdf[order(topdegdf$log10p_nm, decreasing=T),]


# Load both scores based on correlation with depletion:
# -----------------------------------------------------
extail = '.excitatory_subsets.comparison_depletion.tsv'
estdf = read.delim(paste0(regdir, 'allmethods', extail), header=T)
expdf = read.delim(paste0(regdir, 'expression', extail), header=T)
expdf = spread(expdf, time, corr)

# TODO: Can look at the diff between early -> late
estdf = merge(estdf, expdf)

estdf$col3 = ifelse(estdf$late < 0.4, ifelse(estdf$late > -0.4, 0, 1), 2)
estdf$col.corr = with(estdf, ifelse(corr < 0.3, ifelse(corr > -0.3, .5, -1), 1))
# estdf$col.corr = with(estdf, ifelse(padj.corr < 0.05, ifelse(corr > 0, 1, -1), 0))


labdf = estdf[(estdf$col2 >= 1) & (estdf$col3 >= 1),]
# labdf = estdf[(estdf$col2 >= 1),]
# labdf = labdf[!(labdf$col2 %in% c(1,2) & (abs(labdf$zdir) < 1.5)),]
labdf = estdf[(estdf$col3 >= 1) | (abs(estdf$zdir) >= 1),]
path = 'braaksc.ad'

pcols = brewer.pal(12, 'Paired')
degvals = c('0'='grey90','0.5'='grey50','1'=pcols[1],'1.5'=pcols[2],'2'=pcols[5], '2.5'=pcols[6])
gp = ggplot(estdf, aes(corr, late, color=factor(col2))) +
    geom_point() +
    geom_abline(lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=degvals) +
    stat_cor(color='black') +
    labs(x='Effect size vs. log2OR', y='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(corr, late, label=gene, color=factor(col2))) +
    theme_pubr() + theme(legend.position='none')

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_estcorr_scatter_', path)
saveGGplot(gp2, pltprefix, w=18, h=12)


# Plot late vs. zdir
pcols = brewer.pal(12, 'Paired')
degvals = c('0'='grey90','0.5'='grey50','1'=pcols[1],'1.5'=pcols[2],'2'=pcols[5], '2.5'=pcols[6])
gp = ggplot(estdf, aes(zdir, late, color=factor(col2))) +
    geom_point() +
    geom_abline(lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=degvals) +
    stat_cor(color='black') +
    labs(x='Effect size vs. log2OR', y='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=factor(col2))) +
    theme_pubr() + theme(legend.position='none')

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_zdir_scatter_', path)
saveGGplot(gp2, pltprefix, w=18, h=12)


# Plot late vs. zdir (colored by corr)
gp = ggplot(estdf, aes(zdir, late, color=factor(col2))) +
    geom_point() +
    geom_abline(lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=degvals) +
    stat_cor(color='black') +
    # scale_color_distiller(palette='RdYlBu') +
    labs(x='Effect size vs. log2OR', y='Expression vs. log2OR') +
    # geom_text_repel(data=labdf, aes(zdir, late, label=gene), color='black') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=factor(col2))) +
    theme_pubr() + theme(legend.position='none')

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_zdir_col2_scatter_', path)
saveGGplot(gp2, pltprefix, w=18, h=12)


# Partition genes into internal / external and resilient / mid / degen labels:
# ----------------------------------------------------------------------------
corr.cut = 0.2
estdf$reacts.to = with(estdf, ifelse(abs(corr) >= corr.cut, 'Internal', 'External'))
estdf$process = with(estdf, ifelse(late < corr.cut,
        ifelse(late > -corr.cut, 'Middle', 'Degeneration'), 'Resilience'))
estdf$partition = with(estdf, paste0(reacts.to, ' - ', process))
estdf$partition = with(estdf, ifelse(estdf$col == 0, 'Not DE',
        ifelse(estdf$col == 1,
            paste0('Down: ', reacts.to, ' - ', process),
            paste0('Up: ', reacts.to, ' - ', process))))
estdf$partition2 = with(estdf, ifelse(estdf$col == 0, 'Not DE',
        ifelse(estdf$col == 1, paste0('Down + ', reacts.to), paste0('Up + ', reacts.to))))
estdf$partition3 = with(estdf, ifelse(estdf$col == 0, 'Not DE',
        ifelse(estdf$col == 1, paste0('Down + ', process), paste0('Up + ', process))))
estdf$sig = with(estdf, ifelse(estdf$col == 0, 'Not DE', ifelse(estdf$col == 1, 'Down', 'Up')))


# Plot these partitions:
# ----------------------
labdf = estdf[(estdf$col3 >= 1) | (abs(estdf$zdir) >= 1),]
labdf = labdf[!(labdf$col == 0),]

partvals = c("Not DE" = 'grey90',
    "Down: Internal - Resilience" = pcols[2],
    "Down: External - Resilience" = pcols[1],
    "Down: Internal - Middle" = 'grey25',
    "Down: External - Middle" = 'grey50',
    "Down: Internal - Degeneration" = pcols[4],
    "Down: External - Degeneration" = pcols[3],
    "Up: Internal - Resilience" = pcols[6],
    "Up: External - Resilience" = pcols[5],
    "Up: Internal - Middle" = 'grey25',
    "Up: External - Middle" = 'grey50',
    "Up: Internal - Degeneration" = pcols[8],
    "Up: External - Degeneration" = pcols[7])

part2vals = c("Not DE" = 'grey90',
    "Down + Internal" = pcols[2],
    "Down + External" = pcols[1],
    "Up + Internal" = pcols[6],
    "Up + External" = pcols[5])

part3vals = c("Not DE" = 'grey90',
    "Down + Resilience" = pcols[2],
    "Down + Middle" = 'grey50',
    "Down + Degeneration" = pcols[4],
    "Up + Resilience" = pcols[6],
    "Up + Middle" = 'grey50',
    "Up + Degeneration" = pcols[8])

sigvals = c("Not DE" = 'grey90',
    "Down" = pcols[2],
    "Up" = pcols[6])


# Plot late vs. zdir (colored by partition 1)
gp = ggplot(estdf, aes(zdir, late, color=partition)) +
    geom_point() +
    geom_hline(yintercept=c(-corr.cut, corr.cut), lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=partvals) +
    stat_cor(color='black') +
    # scale_color_distiller(palette='RdYlBu') +
    labs(x='Average effect size', y='Expression vs. log2OR') +
    # geom_text_repel(data=labdf, aes(zdir, late, label=gene), color='black') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=partition)) +
    theme_pubr() # + theme(legend.position='none')

# Plot late vs. zdir (colored by partition 2)
gp = ggplot(estdf, aes(zdir, late, color=partition2)) +
    geom_point() +
    geom_hline(yintercept=c(-corr.cut, corr.cut), lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=part2vals) +
    labs(x='Average effect size', y='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=partition2)) +
    theme_pubr()

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_zdir_partition2_scatter_', path)
saveGGplot(gp2, pltprefix, w=18, h=12)


# Plot late vs. zdir (small, colored by partition 2)
gp = ggplot(estdf, aes(zdir, late, color=partition2)) +
    geom_point(cex=.25) +
    geom_hline(yintercept=c(-corr.cut, corr.cut), lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=part2vals) +
    labs(x='Average effect size', y='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=partition2), max.overlaps=30, size=2) +
    theme_pubr() # + theme(legend.position='none')

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_zdir_partition2_scatter_small', path)
saveGGplot(gp2, pltprefix, w=6, h=5)


# -----------------------------------------------------
# Plot late vs. zdir (small, vert, colored by sig only)
# SIMPLEST VERSION, USED IN MAIN 
# -----------------------------------------------------
gp = ggplot(estdf, aes(late, zdir, color=sig)) +
    rasterize(geom_point(cex=.25, alpha=0.75), dpi=450) +
    geom_vline(xintercept=c(-corr.cut, corr.cut), lty='dashed') +
    geom_vline(xintercept=0, lty='dotted') +
    geom_hline(yintercept=0, lty='dotted') +
    scale_color_manual(values=sigvals) +
    labs(y='Average effect size', x='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(late, zdir, label=gene, color=sig), 
        max.overlaps=15, force=5, size=3, box.padding=0.03, point.padding=0.0, min.segment.length=0.02) +
    theme_pubr() + theme(legend.position='none')
pltprefix = paste0(imgpref, 'exprcorr_zdir_vert_basic_scatter_small', path)
saveGGplot(gp, pltprefix, w=4, h=5)


# Plots for partition 3 (up/down vs. degen/resil):
# ------------------------------------------------
# Plot late vs. zdir (colored by partition 3)
gp = ggplot(estdf, aes(zdir, late, color=partition3)) +
    geom_point() +
    geom_hline(yintercept=c(-corr.cut, corr.cut), lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=part3vals) +
    labs(x='Average effect size', y='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=partition3)) +
    theme_pubr()

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_zdir_partition3_scatter_', path)
saveGGplot(gp2, pltprefix, w=18, h=12)


# Plot late vs. zdir (small, colored by partition 3)
gp = ggplot(estdf, aes(zdir, late, color=partition3)) +
    geom_point(cex=.25) +
    geom_hline(yintercept=c(-corr.cut, corr.cut), lty='dashed') +
    geom_hline(yintercept=0, lty='dotted') +
    geom_vline(xintercept=0, lty='dotted') +
    scale_color_manual(values=part3vals) +
    labs(x='Average effect size', y='Expression vs. log2OR') +
    geom_text_repel(data=labdf, aes(zdir, late, label=gene, color=partition3), max.overlaps=30, size=2) +
    theme_pubr() # + theme(legend.position='none')

gp2 = rasterize(gp, layers='Point', dpi=450)
pltprefix = paste0(imgpref, 'exprcorr_zdir_partition3_scatter_small', path)
saveGGplot(gp2, pltprefix, w=6, h=5)



# Define gene sets for enrichment - top 250 genes by effect size in each set:
# ---------------------------------------------------------------------------
estdf = estdf[order(abs(estdf$zdir), decreasing=T),]
ccut = 0.2
ntop = 250

# Resilience associated:
res.genes.up = head(estdf$gene[(estdf$late > ccut) & (estdf$col == 2)], ntop)
res.genes.dw = head(estdf$gene[(estdf$late > ccut) & (estdf$col == 1)], ntop)
res.genes = c(res.genes.up, res.genes.dw)

# Internal resilient - shift in vulnerable cells:
resint.genes.up = estdf$gene[(estdf$corr < -ccut) & (estdf$late > ccut) & (estdf$col == 2)]

# Degeneration associated
degen.genes.up = head(estdf$gene[(estdf$late < -ccut) & (estdf$col == 2)], ntop)
degen.genes.dw = head(estdf$gene[(estdf$late < -ccut) & (estdf$col == 1)], ntop)
degen.genes = c(degen.genes.up, degen.genes.dw)

# Neither of the two:
mid.genes.up = head(estdf$gene[(estdf$late >= -ccut) & (estdf$late <= ccut) & (estdf$col == 2)], ntop)
mid.genes.dw = head(estdf$gene[(estdf$late >= -ccut) & (estdf$late <= ccut) & (estdf$col == 1)], ntop)
mid.genes = c(mid.genes.up, mid.genes.dw)

tested.genes = unique(estdf$gene)
allde.genes = unique(estdf$gene[estdf$col != 0])

subdf = estdf[estdf$col != 0,]
subdf$corr.sign = subdf$corr * (2 * (subdf$col - 1) - 1)
gp = ggplot(subdf, aes(process, corr.sign, color=process)) + 
    geom_boxplot() + 
    stat_compare_means() +
    geom_hline(yintercept=0, lty='dashed') + 
    labs(y='Correlation with log2OR * DE sign') + 
    coord_flip() + 
    theme_pubr()
pltprefix = paste0(imgpref, 'ORcorr_histogram_by_partition_', path)
saveGGplot(gp, pltprefix, w=7, h=3)


# Write these gene sets out:
# --------------------------
gdf = rbind(data.frame(gene=res.genes.up, process='Reslience', dir='Up'),
    data.frame(gene=res.genes.dw, process='Reslience', dir='Down'),
    data.frame(gene=mid.genes.up, process='Middle', dir='Up'),
    data.frame(gene=mid.genes.dw, process='Middle', dir='Down'),
    data.frame(gene=degen.genes.up, process='Degeneration', dir='Up'),
    data.frame(gene=degen.genes.dw, process='Degeneration', dir='Down'))

ptnfile = paste0(regdir, 'topDEGs_bypartition.tsv')
write.table(gdf, ptnfile, quote=F, row.names=F, sep="\t")

write.table(tested.genes, paste0(regdir, 'DEtested_neuronal_genes.tsv'),
        quote=F, row.names=F, sep="\t", col.names=F)
write.table(allde.genes, paste0(regdir, 'allDEGs_neuronal_genes.tsv'),
        quote=F, row.names=F, sep="\t", col.names=F)



# Functional enrichments for the (up) DEGs by partition:
# ------------------------------------------------------
# 1. Up-regulated resilience terms (ubiquitin, HSF, ER processing, neuron death, cadherin binding)
gp2df = runSingleGO(res.genes.up, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# 2. Down-regulated resilience terms (NAT complex - MED21/6/10 and RNA polymerase complex - TAF1/11, POL1/3)
gp2df = runSingleGO(res.genes.dw, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# 3. All resilience terms (similar to up, minus neuron death in top)
gp2df = runSingleGO(res.genes, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# Plot a reduced version of these enrichments:
pltprefix = paste0(imgpref, 'barplot_enr_allresil')
gp = plotGObarplot(subdf, pltprefix, ntop=25, fill=part3vals['Up + Resilience'])


# ------------------------------------------------------
# 4. Really clean DEs: vesicle clathrin endo / ubiquitin / glycolysis / (apoptosis) (in the top 25, extend GO?)
gp2df = runSingleGO(resint.genes.up, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 25)

# Plot a reduced version of these enrichments:
pltprefix = paste0(imgpref, 'barplot_enr_allresil_int')
gp = plotGObarplot(subdf, pltprefix, ntop=25, fill=part3vals['Up + Resilience'])


# ------------------------------------------------------
# 1. Up-regulated degeneration terms (oxidative phosphorylation, transmembrane transporters - inc. ABCA7)
gp2df = runSingleGO(degen.genes.up, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# 2. Down-regulated degeneration terms (transport vesicle)
gp2df = runSingleGO(degen.genes.dw, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# 3. All degeneration terms (similar to combination, contains oxphos + vesicle, BIN1 and PSEN1 change)
gp2df = runSingleGO(degen.genes, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# Plot a reduced version of these enrichments:
pltprefix = paste0(imgpref, 'barplot_enr_alldegen')
gp = plotGObarplot(subdf, pltprefix, ntop=25, fill=part3vals['Up + Degeneration'])


# ------------------------------------------------------
# 3. All mid (mostly synapse organization related genes)
gp2df = runSingleGO(mid.genes, print.res=FALSE)
subdf = subsetGOterms(gp2df, cutoff=0.75, subsetsources=FALSE)
head(subdf, 20)

# Plot a reduced version of these enrichments:
pltprefix = paste0(imgpref, 'barplot_enr_allmid')
gp = plotGObarplot(subdf, pltprefix, ntop=25, fill=part3vals['Up + Middle'])


# Finally, bin into overlapping sets and plot terms along these bins:
# -------------------------------------------------------------------
dedf = estdf[estdf$col != 0,]; suffix = 'allDE'
dedf = estdf[estdf$col == 2,]; suffix = 'uponly'
dedf = estdf[estdf$col == 2 & (estdf$corr < -.2),]; suffix = 'uponly_corrDE'

minor= 0.05
# ntop = 500
ntop = 250
xat = seq(-1, 1, minor)
mind = dedf$late
names(mind) = dedf$gene
# msets = lapply(xat, function(x){ names(mind[abs(mind - x) <= minor]) })
msets = lapply(xat, function(x){ head(names(mind[abs(mind - x) <= minor * 2]), ntop) })
names(msets) = paste0('x_',xat)

# Remove empty subsets:
dl = c(lapply(msets, length))
keep = names(dl)[dl > 1]
msets = msets[keep]

# Run GO enrichments across all subsets:
# --------------------------------------
gp2.result = gprofiler2::gost(msets, organism='hsapiens',
    ordered_query=FALSE, multi_query=TRUE,
    sources = sources, evcodes=FALSE)

gp2df = gp2.result$result
pmat = t(data.frame(gp2df$p_value))
rownames(pmat) = gp2df$term_name
colnames(pmat) = paste0('p', names(msets))
pmat = -log10(pmat)

# Get the genes in the term intersections:
allgenes = unique(unlist(msets))
gp2.res.int = gprofiler2::gost(allgenes, organism='hsapiens',
    ordered_query=FALSE, multi_query=FALSE, user_threshold=1,
    sources = sources, evcodes=TRUE)

intdf = gp2.res.int$result
# Get the top N genes per term:
degs = dedf$gene
intdf$topgenes = sapply(intdf$intersection, function(x, ntop=3){
    x = strsplit(x, ',')[[1]]
    x = head(degs[degs %in% x], ntop)
    return(paste0(x, collapse=','))
    })

# Mapping term ids to genes:
mapgenes = intdf$topgenes
names(mapgenes) = intdf$term_id
gp2df$topgenes = mapgenes[gp2df$term_id]

intdf = intdf[intdf$term_id %in% gp2df$term_id,]
intdf = intdf[order(intdf$p_value),]
intdf = intdf[intdf$term_size < 500,]

# Use this to prune the enriched terms:
sel.ind = selGOterms(intdf$intersection, cutoff=0.75)
int.terms = intdf$term_id[sel.ind]

# Add terms not in intdf:
all.gpterms = gp2df$term_id[gp2df$term_size < 500]
uq.gpterms = all.gpterms[!(all.gpterms %in% intdf$term_id)]
kept.terms = c(int.terms, uq.gpterms)
# kept.terms = c(int.terms)


# Diagonalize + order terms:
# --------------------------
ind = (gp2df$term_id %in% kept.terms)
pltmat = pmat[ind,]
pltgenes = gp2df$topgenes[ind]
names(pltgenes) = rownames(pltmat)
# TODO: Need to reduce still...
tind = apply(pltmat, 1, max) > 2.5
pltmat = pltmat[tind,]
pltmat[pltmat > 10] = 10
ll = diag.mat2(t(pltmat), cutoff=2)
pltmat = pltmat[ll[[2]],]

# Keep only top within each set:
if (suffix == 'uponly_corrDE'){ nterm=3 } else { nterm=2 }
nc.cutoff = 40
acut = ll[[3]]
rn = c()
for (i in unique(acut)){
    print(i)
    anm = names(acut[acut == i])
    asc = sort(pltmat[anm,i], decreasing=T)
    nc = nchar(names(asc))
    asc = asc[nc < nc.cutoff]
    asc = head(asc, nterm)
    anm = anm[anm %in% names(asc)]
    rn = c(rn, anm)
}

htann = HeatmapAnnotation(topgenes=anno_text(pltgenes[rownames(pltmat)],
        gp=gpar(fontsize=5)), which='row')
ht = Heatmap(pltmat,
    name='-log10p',
    col=colb,
    left_annotation=htann,
    cluster_columns=FALSE,
    cluster_rows=FALSE)
pltprefix = paste0(imgpref, 'heatmap_binned_enr_all', suffix)
h = 2 + nrow(pltmat) / 15
w = 5 + ncol(pltmat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)

# Subset:
pltmat = pltmat[rn,]
ux = 1.5
htann = HeatmapAnnotation(topgenes=anno_text(pltgenes[rownames(pltmat)],
        gp=gpar(fontsize=5)), which='row')
ht = Heatmap(pltmat,
    name='-log10p',
    col=colb,
    left_annotation=htann,
    width = ncol(pltmat)*unit(ux / 1.5, "mm"),
    height = nrow(pltmat)*unit(ux, "mm"),
    border_gp = gpar(col='black', lwd=.5),
    cluster_columns=FALSE,
    cluster_rows=FALSE)
pltprefix = paste0(imgpref, 'heatmap_binned_enr_small', suffix)
h = 2 + nrow(pltmat) / 15
w = 5 + ncol(pltmat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)


# Compare these to GWAS genes:
# ----------------------------
tab = read.delim('Annotation/20210915_ADGENES_CHROM_Tanzi.tsv', header=T)
adgenes = tab$gene[tab$evidence == 'GWAS']
addf = estdf[(estdf$gene %in% adgenes) & (estdf$col != 0),]

table(addf[,c('col','process')]) # 17 down, 20 up

