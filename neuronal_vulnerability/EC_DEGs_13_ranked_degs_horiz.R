#!/usr/bin/R
# ---------------------------------------------------------
# Plots on the ranked genes from the horizontal pseudotime:
# Updated: 03/09/2022
# ---------------------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)

library(ComplexHeatmap)
library(circlize)
options(width=175)

# Directories:
pstdir = paste0(sdbdir, 'pseudotime/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'detraj_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load the gene rankings for the trajectory:
# ------------------------------------------
rankfile = paste0(pstdir, 'gene_scores_integrated_detraj_horiz.tsv')
df = read.delim(rankfile, sep="\t")

dfwide = spread(df[,c('gene','group','max')], group, max)
colnames(dfwide) = c('gene','horiz')
group = 'horiz'
head(dfwide[order(dfwide[[group]], decreasing=T),], 50)


# Read in the GAM predictions:
# ----------------------------
genes = scan(paste0(pstdir, 'gene_order_horiz.txt'), 'c', quiet=TRUE)
pmat = read.delim(paste0(pstdir, 'gene_prediction_matrix_horiz.tsv'), header=F, sep="\t")
pmat = as.matrix(pmat)
rownames(pmat) = genes
# Reverse pmat, is backwards:
pmat = pmat[,rev(colnames(pmat))]


# Plot these predictions:
# -----------------------
orderMatrix = function(pltmat, cutoff = 0.75){
    pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
    ordmat = pltmat * (pltmat > 0.75)
    score = (sweep(ordmat, 1, apply(ordmat, 1, sum), '/')**2) %*% 1:ncol(ordmat)
    geneord = rownames(ordmat)[order(score)]
    return(geneord)
}

ntop = 100
group = 'horiz'
topgenes = head(dfwide[order(dfwide[[group]], decreasing=T),'gene'], ntop)
load.colors()

pltmat = pmat[topgenes,]
pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
geneord = orderMatrix(pltmat)

ux = 1.5
ht = Heatmap(pltmat[geneord,], 
    use_raster=TRUE, 
    width=ncol(pltmat) * unit(ux / 4, 'mm'),
    height=nrow(pltmat) * unit(ux, 'mm'),
    cluster_columns=FALSE,
    cluster_rows=FALSE,
    show_column_names=FALSE,
    border_gp=gpar(lwd=.5, color='black'),
    col=rev(colspec))

pltprefix = paste0(imgpref, 'rankedgenes_', group, ntop, '_heatmap')
w = 2 + ncol(pltmat) / 15
h = 2 + nrow(pltmat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)


# Genes where max is in the middle:
# ---------------------------------
usemat = pmat 
mpt = apply(usemat, 1, which.max)
midgenes = names(which(mpt > 20 & mpt < 80))
mdf = merge(dfwide, data.frame(gene=names(mpt), mpt=mpt))
mdf$set = ifelse(mdf$mpt > 20, ifelse(mdf$mpt < 80, 'mid', 'top'), 'bot')
mdf$set = round(mdf$mpt / 10, 0)

# Plot top from each set:
ntop = 10
mdf = mdf[order(mdf[[group]], decreasing=T),]
setgenes = sapply(unique(mdf$set), function(x){head(mdf$gene[mdf$set == x], ntop)})
setgenes = c(unlist(setgenes))
rownames(mdf) = mdf$gene
ord = order(mdf[setgenes, 'mpt'])
pltmat = usemat[setgenes[ord],]
pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
# pltmat = t(scale(t(pltmat)))


ux = 1.5
ht = Heatmap(pltmat, 
    use_raster=TRUE, 
    width=ncol(pltmat) * unit(ux / 4, 'mm'),
    height=nrow(pltmat) * unit(ux, 'mm'),
    cluster_columns=FALSE,
    cluster_rows=FALSE,
    show_column_names=FALSE,
    border_gp=gpar(lwd=.5, color='black'),
    col=rev(colspec))
    # col=viridis(100))
    # rev(colrb))

pltprefix = paste0(imgpref, 'rankedgenes_', group, ntop, '_setgenes_heatmap')
w = 2 + ncol(pltmat) / 15
h = 2 + nrow(pltmat) / 15
saveHeatmap(ht, pltprefix, w=w, h=h)


# Plot gene fits with lineplots:
# ------------------------------
pwide = data.frame(usemat)
pmap = 1:ncol(pwide)
names(pmap) = colnames(pwide)
pwide$gene = rownames(usemat)
plong = gather(pwide, cn, value, -gene)
plong$pos = pmap[plong$cn]

logfc = log2(apply(usemat, 1, max) / (apply(usemat, 1, min) - min(usemat) + 1e-4))
mdf$logFC = logfc[mdf$gene]
mdf$logFC[mdf$logFC > 5] = 5
mdf$dir.logFC = mdf$logFC * (2 * (mdf$mpt > 50) - 1)

labdf = head(mdf, 100)
gp = ggplot(mdf, aes_string('dir.logFC', group, color='mpt')) + 
    rasterise(geom_point(cex=.3), scale=.5) + 
    geom_text_repel(data=labdf, aes_string('dir.logFC', group, label='gene'), 
        size=2, max.overlaps=40, color='black') + 
    scale_y_continuous(expand=c(0,0)) + 
    scale_color_viridis('Maximum point on PST') + 
    labs(x='log2 FC', 'maximum z-score from GAM fit') + 
    theme_pubr() + theme(legend.position='top')

pltprefix = paste0(imgpref, 'rankedgenes_', group, ntop, '_setgenes_scatter')
saveGGplot(gp, pltprefix, w=7, h=7)

# ntop = 100
# topgenes = head(dfwide$gene[order(dfwide[[group]], decreasing=T)], ntop)

selgenes = head(mdf[mdf$logFC > 1,'gene'], 50)
selgenes = setgenes
subdf = plong[plong$gene %in% selgenes,]

gp = ggplot(subdf, aes(pos, value, color=gene)) + 
    geom_line() + 
    theme_pubr() + 
    theme(legend.position = 'right')
pltprefix = paste0(imgpref, 'rankedgenes_', group, ntop, '_setgenes_fits')
saveGGplot(gp, pltprefix, w=12, h=8)

