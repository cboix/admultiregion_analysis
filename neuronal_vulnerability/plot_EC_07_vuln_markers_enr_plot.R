#!/usr/bin/R
# -------------------------------------------
# Plots of top markers of vulnerable neurons:
# Updated: 12/22/2021
# -------------------------------------------
library(cbrbase)
set_proj('DEVTRAJ', 'multiRegion')
source(paste0(sbindir, 'load_metadata.R'))

library(tidyr)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(patchwork)
library(ggrastr)
library(GGally)  # ggpairs

library(ComplexHeatmap)
library(circlize)
library(gprofiler2)
options(width=175)

# Directories:
regdir = paste0(sdbdir, 'dereg/')
fracdir = paste0(sdbdir, 'fractions/')
plotdir = paste0(imgdir, 'vuln/')
imgpref = paste0(plotdir, 'echip_')
cmd = paste('mkdir -p', plotdir)
system(cmd)

source(paste0(sbindir, 'auxiliary_plotting_settings.R'))


# Load the regression estimates of fraction changes:
# --------------------------------------------------
subset = 'Exc'
qbreg.file = paste0(fracdir, 'quasibinom_contrasts_Exc_byregion.tsv')
qbdf = read.delim(qbreg.file, sep='\t')

# TODO: Filter down the odds ratios analysis:
kdf = merge(data.frame(cls=exc.sets[['CTXneurons']]), data.frame(region=c('AG','MT','PFC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['ECneurons']], region=c('EC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['HCneurons']], region=c('HC')))
kdf = rbind(kdf, data.frame(cls=exc.sets[['THneurons']], region=c('TH')))

path = 'braaksc.ad'
sub.qbdf = qbdf[qbdf$path == path,]
sub.qbdf = merge(sub.qbdf[,c('cls','region','odds.ratio')], kdf)
sub.qbdf$Est = log2(sub.qbdf$odds.ratio)
sub.qbdf = sub.qbdf[,c('region','cls','Est')]
names(sub.qbdf)[2] = 'cell_type_high_resolution'


# Load pseudobulk data for all neurons in any set of regions:
# -----------------------------------------------------------
# Set the used regions:
# use.regions = 'EC'
# use.regions = 'ECHCTH'
use.regions = 'allregions'
use.ctrlonly = TRUE
use.est = TRUE
suffix = use.regions
if (use.ctrlonly){ suffix = paste0(suffix, '_ctrlonly') }
if (use.est){ 
    suffix = paste0(suffix, '_estvuln_', path)
} else {
    suffix = paste0(suffix, '_vuln')
}

res.regfile.rda = paste0('multiRegion/vulnmarkers_regression_psbulk_', suffix, '_full.Rda')
load(res.regfile.rda)

# Write, with expression cut more leniently (mx > 3) to look at internally:
mxexpr = apply(pmat, 1, max)
reportdf = est.regdf[est.regdf$var == 'val',]
reportdf = reportdf[!is.na(reportdf$p),]
reportdf$mx = mxexpr[reportdf$symbol]
reportdf = reportdf[order(reportdf$p), ]
reportdf$padj = p.adjust(reportdf$p, 'fdr')
reportdf$log10q = -log10(reportdf$padj)
reportdf = reportdf[(reportdf$padj < pcut) & (reportdf$mx > 3),]
reportdf$dir = ifelse(reportdf$Est < 0, 'Vulnerable','Resilient')

sub.regfile.tsv = paste0(sdbdir, 'vulnmarkers_regression_psbulk_', suffix, '_topgenes.tsv')
write.table(reportdf, sub.regfile.tsv, quote=F, row.names=F, sep='\t')


# Plot markers on a heatmap:
# --------------------------
ntop = 30
if (use.est){
    upgene = head(adf[adf$color == 1,'symbol'], ntop)
    dwgene = head(adf[adf$color == 2,'symbol'], ntop)
}
pltgene = unique(c(upgene, dwgene, 'RELN','GPC5','DAB1', 'VLDLR','LRP8'))

# ind = umeta$nrad == 'CTRL' 
pltmat = as.matrix(log1p(pmat[pltgene,]))

pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
plt = Heatmap(pltmat, 
              column_split=paste0(umeta$vuln, '-', umeta$nrad),
              use_raster=T, 
              show_column_names=FALSE)


# Functional enrichments for the (up) markers by where/when they are called:
# --------------------------------------------------------------------------
ntop = 30
upgene = head(adf[adf$color == 1,'symbol'], ntop)
dwgene = head(adf[adf$color == 2,'symbol'], ntop)
sources = c("GO:CC","GO:BP","GO:MF","REAC","WP","KEGG","CORUM")
sub.sources = c('REAC','WP','KEGG','CORUM')

for(use.set in c('down', 'up')){
    # use.set = 'up'
    if (use.set == 'down'){ set = dwgene } else { set = upgene }
    gp2.result = gprofiler2::gost(set, organism='hsapiens',
                                  ordered_query=FALSE, multi_query=FALSE,
                                  sources = sources, evcodes=TRUE)
    gp2df = gp2.result$result
    gp2df = gp2df[order(gp2df$p_value),]
    gp2df[(gp2df$term_size < 500) & (gp2df$source %in% sub.sources),]

    gp2cols = c('term_id','p_value','source','term_name', 'term_size', 'intersection')
    gp2df = gp2df[,gp2cols]

    # Plot a reduced version of these enrichments:
    subdf = gp2df[(gp2df$term_size < 500) & (gp2df$source %in% sub.sources),]
    subdf = unique(subdf[, c('p_value', 'term_name', 'source', 'intersection'), drop=F])
    subdf$lab = paste0(subdf$source, ": ", subdf$term_name)

    subdf$lab = factor(subdf$lab, levels=rev(subdf$lab))
    gp = ggplot(subdf, aes(lab, -log10(p_value), label=intersection)) + 
        geom_bar(stat='identity') + 
        coord_flip() + 
        geom_text() + 
        theme_pubr()

    pltprefix = paste0(imgpref, 'enrichments_vuln_markers_subsources_barplot_', use.set)
    w = 10; h = 3
    ggsave(paste0(pltprefix, '.png'), gp, dpi=450, units='in', width=w, height=h)
    ggsave(paste0(pltprefix, '.pdf'), gp, dpi=450, units='in', width=w, height=h)
}


# Look at the correlation of upgenes:
# -----------------------------------
ntop = 50
upgene = head(adf[adf$color == 1,'symbol'], ntop)
upmat = as.matrix(pmat[upgene,])
cr = cor(t(upmat))

plt = Heatmap(cr,
              use_raster=TRUE,
              width = ncol(cr)*unit(5, "mm"), 
              height = nrow(cr)*unit(5, "mm"),
              col=colb)

pltprefix = paste0(imgpref, 'correlation_vuln_markers_top', ntop)
png(paste0(pltprefix, '.png'), res=450, units='in', width=10, height=10)
print(plt)
dev.off()
pdf(paste0(pltprefix, '.pdf'), width=10, height=10)
print(plt)
dev.off()



# Plot small heatmap with selected top markers:
# TODO: Merge each subtype:
# ---------------------------------------------
ind = (umeta$nrad == 'CTRL')
umeta$cr = with(umeta, paste0(cell_type_high_resolution, '-', region))
crs = unique(umeta$cr)
tform = make.tform(umeta$cr[ind], u=crs, norm=FALSE)
tform = sweep(tform, 1, umeta$ncell[ind], '*')
tform = sweep(tform, 2, apply(tform, 2, sum), '/')
avg.mat = as.matrix(pmat[, ind] %*% tform)

pltgenes = c('CLSTN1','FOXP2','RELN','DAB1','PRKCA','SPHKAP','DLGAP1', 'KCNN2')

pltmat = log1p(avg.mat[pltgenes,])
# pltmat = sweep(pltmat, 1, apply(pltmat, 1, max), '/')
plt = Heatmap(t(pltmat), 
              # column_split=paste0(umeta$vuln, '-', umeta$nrad),
              use_raster=T)
              # show_column_names=TRUE)

# Plot as scatter as well:
sub.qbdf$cr = with(sub.qbdf, paste0(cell_type_high_resolution, '-', region))
sub.pltdf = sub.qbdf[sub.qbdf$cr %in% colnames(pltmat),]

all.pltdf = c()
for (gene in c('DAB1','HS6ST3','AGBL1','SPHKAP','DLGAP1','EYS','PRKCA','COL4A2','RELN', 'KCNN2', 'CLSTN1','PCSK1N')){
    sub.pltdf$x = log1p(avg.mat[gene, sub.pltdf$cr])
    sub.pltdf$gene = gene
    all.pltdf = rbind(all.pltdf, sub.pltdf)
}

gp = ggplot(all.pltdf, aes(x, Est, label=cr)) + 
    facet_wrap(~gene, scales='free') + 
    geom_point() + 
    geom_smooth(method='lm') + 
    geom_text_repel() + 
    stat_cor() + 
    theme_pubr()

gp2 = rasterize(gp, layers='Point', dpi=450)
w = 12; h=9
pltprefix = paste0(imgpref, 'vuln_genes_subtype_scatters_', suffix)
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)



# Intersect with consistent DEG sets:
# -----------------------------------
# Load in regression results for subtypes:
topdeg.file = paste0(regdir, 'allmethods.vulnerable_excitatory_subsets.bypath.tsv.gz')
topdegdf = read.delim(gzfile(topdeg.file), sep="\t")
topdegdf = topdegdf[order(topdegdf$log10p_nm, decreasing=T),]
subdf = topdegdf[topdegdf$path == 'cogdxad',]  # TODO: braaksc.ad might be more appropriate
updegene = unique(subdf$gene[subdf$col == 2])
dwdegene = unique(subdf$gene[subdf$col == 1])

vulndf = adf[(adf$color == 1) & (adf$symbol %in% dwdegene),]
resdf = adf[(adf$color == 2) & (adf$symbol %in% updegene),]
dim(vulndf)
dim(resdf)


# Plot the scatter of vuln/resil vs. AD DEG
# -----------------------------------------
dedf = subdf[,c('gene','zdir','col')]
ordf = adf[,c('symbol','Est','color')]
names(dedf) = c('gene','de.est','de.col')
names(ordf) = c('gene','or.est','or.col')
crossdf = merge(dedf, ordf)
crossdf$de.est[crossdf$de.est > 4] = 4
labdf = crossdf[crossdf$de.col != 0 & crossdf$or.col != 0,]

gp = ggplot(crossdf, aes(de.est, or.est, label=gene, color=factor(de.col))) + 
    geom_point(cex=.1) + 
    geom_smooth(method='lm', color='black', lwd=.25) + 
    geom_text_repel(data=labdf, aes(de.est, or.est, label=gene, color=factor(de.col)),
        point.padding=0.05, box.padding=0.05,
        cex=1.5, max.overlaps=10) +
    scale_color_manual(values=c('0'='grey80', '1'='blue','2'='red')) + 
    geom_hline(yintercept=0, lty='dashed', lwd=.25) + 
    geom_vline(xintercept=0, lty='dashed', lwd=.25) + 
    stat_cor(color='black', cex=1.5) + 
    theme_pubr() + theme(legend.position='none') + 
    labs(x='Differential expression effect size (z-scored)', y='Depletion odds-ratio effect size') + 
    font("xlab", size = 6) + font("ylab", size = 6) + font("xy.text", size = 5) + 
    theme(axis.ticks = element_line(size = 0.25),
        axis.line = element_line(size = 0.25))
# gp2 = rasterize(gp, layers='Point', dpi=300)
pltprefix = paste0(imgpref, 'vuln_genes_scatter_vsDE_', suffix)
saveGGplot(gp, pltprefix, w=2.5, h=2.5)




# Plot expression of RELN + DAB1 signaling pathways against each other:
# ---------------------------------------------------------------------
ind = (umeta$nrad == 'CTRL')
ind = 1:nrow(umeta)
umeta$cr = with(umeta, paste0(cell_type_high_resolution, '-', region))
crs = unique(umeta$cr)
tform = make.tform(umeta$cr[ind], u=crs, norm=FALSE)
tform = sweep(tform, 1, umeta$ncell[ind], '*')
tform = sweep(tform, 2, apply(tform, 2, sum), '/')
avg.mat = as.matrix(pmat[, ind] %*% tform)

sub.qbdf$cr = with(sub.qbdf, paste0(cell_type_high_resolution, '-', region))
sub.pltdf = sub.qbdf[sub.qbdf$cr %in% colnames(pltmat),]
siggenes = c('RELN', 'DAB1', 'LRP8', 'VLDLR', 'FYN', 'SRC', 'PIK3CB','PIK3CA','GSK3B', 'CDK5','AKT1')
for (gene in siggenes){
    sub.pltdf[[gene]] = log1p(avg.mat[gene, sub.pltdf$cr])
}


# Plot reduced version:
gp = ggpairs(sub.pltdf, columns=c(siggenes[1:6], 'Est'),
             lower = list(continuous = "smooth")) + 
    theme_pubr()
w = 9; h=9
pltprefix = paste0(imgpref, 'vuln_genes_reelin_signaling_pairs_', suffix)
ggsave(paste0(pltprefix, '.png'), gp, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp, dpi=450, units='in', width=w, height=h)


# Plot full version:
gp2 = ggpairs(sub.pltdf, columns=c(siggenes, 'Est'),
              lower = list(continuous = "smooth")) + 
    theme_pubr()
w = 10; h=10
pltprefix = paste0(imgpref, 'vuln_genes_reelin_signaling_pairs_full_', suffix)
ggsave(paste0(pltprefix, '.png'), gp2, dpi=450, units='in', width=w, height=h)
ggsave(paste0(pltprefix, '.pdf'), gp2, dpi=450, units='in', width=w, height=h)

smat = sub.pltdf[,c('VLDLR','FYN','DAB1')]
sub.pltdf$sig.score = apply(smat, 1, sum)
sub.pltdf = sub.pltdf[order(sub.pltdf$sig.score, decreasing=T),]
sub.pltdf$cr = factor(sub.pltdf$cr, levels=sub.pltdf$cr)

# Plot a barplot for this:
gp = ggplot(sub.pltdf, aes(cr, sig.score, fill=Est)) + 
    geom_bar(stat='identity') + 
    scale_fill_distiller(palette='RdBu') + 
    scale_y_continuous(expand=c(0,0)) + 
    labs(y='VLDLR + FYN + DAB1 expression') + 
    theme_pubr() + coord_flip()
pltprefix = paste0(imgpref, 'vuln_3gene_score_barplot_', suffix)
saveGGplot(gp, pltprefix, w=6, h=12)


